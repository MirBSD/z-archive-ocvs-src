head	1.6;
access;
symbols
	lynx-2_8_6dev10:1.1.2.1
	FSF:1.1.2
	tg-mergetmp-mirosx-1:1.6
	tg-mergefixes-1-branch:1.6.0.4
	tg-mergefixes-1-base:1.6
	MIROS_X:1.6.0.2
	MIROS_X_BASE:1.6
	MIRBSD_XP_MIRPPC:1.5.0.4
	lynx-2_8_6dev_7b:1.1.3.3
	lynx-2_8_6dev_6:1.1.3.3
	MIRBSD_XP_SPARC_BASE:1.5
	MIRBSD_XP_SPARC:1.5.0.2
	lynx-2_8_6dev_5-iz2:1.1.3.3
	lynx-2_8_6dev_5:1.1.3.3
	cvs-200406091940:1.1.1.2
	MIRBSD_7quater:1.3
	cvs-200405160640:1.1.1.2
	lynx-2_8_6dev2:1.1.3.2
	lynx-2_8_5:1.1.3.1
	cvs-200401271800:1.1.1.2
	cvs-200401261630:1.1.1.2
	lynx_2-8-5_dev17d:1.1.3.1
	cvs-200401021645:1.1.1.2
	MIRBSD_7_ALPHA:1.3.0.6
	MIRBSD_7:1.3.0.4
	cvs-200312222040:1.1.1.2
	MIRBSD_7ter:1.3
	MIRBSD_7_DEV:1.3.0.2
	cvs-200310020700:1.1.1.2
	lynx_2-8-5_dev16c:1.1.3.1
	cvs-200309271030:1.1.1.2
	cvs-200309251530:1.1.1.2
	lynx_2-8-5_dev16:1.1.3.1
	tg:1.1.3
	cvs-200308302005:1.1.1.2
	cvs-200308171200:1.1.1.2
	ctm-3496:1.1.1.2
	ctm-3449:1.1.1.2
	ctm-3437:1.1.1.2
	cvs-200307191805:1.1.1.2
	ctm-3425:1.1.1.2
	cvs-200307091500:1.1.1.2
	VENDOR_LYNX_285dev16:1.3
	ctm-3389:1.1.1.2
	cvs-200306291430:1.1.1.2
	ctm-3341:1.1.1.2
	MIRBSD_5:1.1.1.2
	cvs-200306082100:1.1.1.2
	ctm-3316:1.1.1.2
	ctm-3272:1.1.1.2
	ctm-3264:1.1.1.2
	cvs-200305071630:1.1.1.2
	MIRBSD_4:1.1.1.1
	ctm-3203:1.1.1.1
	cvs-20030410-1130:1.1.1.1
	ctm-3155:1.1.1.1
	ctm-3132:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@ * @;


1.6
date	2004.11.28.16.36.16;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2004.07.15.18.16.39;	author tg;	state Stab;
branches;
next	1.4;

1.4
date	2004.04.30.16.32.28;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2003.07.07.18.58.03;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2003.07.07.18.49.07;	author tg;	state dead;
branches;
next	1.1;

1.1
date	2003.03.22.17.42.12;	author tg;	state Exp;
branches
	1.1.1.1
	1.1.2.1
	1.1.3.1;
next	;

1.1.1.1
date	2003.03.22.17.42.12;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2003.05.07.17.30.01;	author tg;	state Exp;
branches;
next	;

1.1.2.1
date	2005.01.03.00.26.48;	author tg;	state Exp;
branches;
next	;

1.1.3.1
date	2003.09.17.14.19.53;	author tg;	state Exp;
branches;
next	1.1.3.2;

1.1.3.2
date	2004.04.30.16.15.17;	author tg;	state Exp;
branches;
next	1.1.3.3;

1.1.3.3
date	2004.07.15.15.47.48;	author tg;	state Exp;
branches;
next	;


desc
@@


1.6
log
@all the -W* stuff
@
text
@/* $MirBSD$ */

/*		Telnet Acees, Roligin, etc			HTTelnet.c
 *		==========================
 *
 * Authors
 *	TBL	Tim Berners-Lee timbl@@info.cern.ch
 *	JFG	Jean-Francois Groff jgh@@next.com
 *	DD	Denis DeLaRoca (310) 825-4580  <CSP1DWD@@mvs.oac.ucla.edu>
 * History
 *	 8 Jun 92 Telnet hopping prohibited as telnet is not secure (TBL)
 *	26 Jun 92 When over DECnet, suppressed FTP, Gopher and News. (JFG)
 *	 6 Oct 92 Moved HTClientHost and logfile into here. (TBL)
 *	17 Dec 92 Tn3270 added, bug fix. (DD)
 *	 2 Feb 93 Split from HTAccess.c.  Registration.(TBL)
 */

#include <HTUtils.h>
#include <LYUtils.h>

/* Implements:
*/
#include <HTTelnet.h>

#include <HTParse.h>
#include <HTAnchor.h>
#include <HTTP.h>
#include <HTFile.h>

#include <HTTCP.h>
#include <HText.h>

#include <HTAccess.h>
#include <HTAlert.h>

#include <LYStrings.h>
#include <LYClean.h>
#include <LYLeaks.h>

static void do_system(char *command)
{
    if (!isEmpty(command)) {
	CTRACE((tfp, "HTTelnet: Command is: %s\n\n", command));
	LYSystem(command);
	FREE(command);
    }
}

/*	Telnet or "rlogin" access
 *	-------------------------
 */
static int remote_session(char *acc_method, char *host)
{
    const char *program;
    char *user = host;
    char *password = NULL;
    char *cp;
    char *hostname;
    char *port;
    char *command = NULL;
    enum _login_protocol {
	telnet,
	rlogin,
	tn3270
    } login_protocol =
      strcmp(acc_method, "rlogin") == 0 ? rlogin :
      strcmp(acc_method, "tn3270") == 0 ? tn3270 : telnet;

    /*
     * Modified to allow for odd chars in a username only if exists.
     * 05-28-94 Lynx 2-3-1 Garrett Arch Blythe
     */
    /* prevent telnet://hostname;rm -rf *  URL's (VERY BAD)
     *  *cp=0;        // terminate at any ;,<,>,`,|,",' or space or return
     * or tab to prevent security whole
     */
    for (cp = (strchr(host, '@@') ? strchr(host, '@@') : host); *cp != '\0';
	 cp++) {
	if (!isalnum(UCH(*cp)) && *cp != '_' && *cp != '-' &&
	    *cp != ':' && *cp != '.' && *cp != '@@') {
	    *cp = '\0';
	    break;
	}
    }

    hostname = strchr(host, '@@');

    if (hostname) {
	*hostname++ = '\0';	/* Split */
    } else {
	hostname = host;
	user = NULL;		/* No user specified */
    }

    port = strchr(hostname, ':');
    if (port)
	*port++ = '\0';		/* Split */

    if (!hostname || *hostname == '\0') {
	CTRACE((tfp, "HTTelnet: No host specified!\n"));
	return HT_NO_DATA;
    } else if (!valid_hostname(hostname)) {
	char *prefix = NULL;
	char *line = NULL;

	CTRACE((tfp, "HTTelnet: Invalid hostname %s!\n", host));
	HTSprintf0(&prefix,
		   gettext("remote %s session:"), acc_method);
	HTSprintf0(&line,
		   gettext("Invalid hostname %s"), host);
	HTAlwaysAlert(prefix, line);
	FREE(prefix);
	FREE(line);
	return HT_NO_DATA;
    }

    if (user) {
	password = strchr(user, ':');
	if (password) {
	    *password++ = '\0';
	}
    }

    /* If the person is already telnetting etc, forbid hopping */
    /* This is a security precaution, for us and remote site */

    if (HTSecure) {

#ifdef TELNETHOPPER_MAIL
	HTSprintf0(&command,
		   "finger @@%s | mail -s \"**telnethopper %s\" tbl@@dxcern.cern.ch",
		   HTClientHost, HTClientHost);
	do_system(command);
#endif
	printf("\n\nSorry, but the service you have selected is one\n");
	printf("to which you have to log in.  If you were running www\n");
	printf("on your own computer, you would be automatically connected.\n");
	printf("For security reasons, this is not allowed when\n");
	printf("you log in to this information service remotely.\n\n");

	printf("You can manually connect to this service using %s\n",
	       acc_method);
	printf("to host %s", hostname);
	if (user)
	    printf(", user name %s", user);
	if (password)
	    printf(", password %s", password);
	if (port)
	    printf(", port %s", port);
	printf(".\n\n");
	return HT_NO_DATA;
    }

    /* Not all telnet servers get it even if user name is specified so we
     * always tell the guy what to log in as.
     */
    if (user && login_protocol != rlogin)
	printf("When you are connected, log in as:  %s\n", user);
    if (password && login_protocol != rlogin)
	printf("                  The password is:  %s\n", password);
    fflush(stdout);

/*
 *	NeXTSTEP is the implied version of the NeXT operating system.
 *		You may need to define this yourself.
 */
#if	!defined(TELNET_DONE) && (defined(NeXT) && defined(NeXTSTEP) && NeXTSTEP<=20100)
#define FMT_TELNET "%s%s%s %s %s"

    if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	HTAddParam(&command, FMT_TELNET, 1, program);
	HTOptParam(&command, FMT_TELNET, 2, user ? " -l " : "");
	HTAddParam(&command, FMT_TELNET, 3, user);
	HTAddParam(&command, FMT_TELNET, 4, hostname);
	HTAddParam(&command, FMT_TELNET, 5, port);
	HTEndParam(&command, FMT_TELNET, 5);
    }
    do_system(command);
#define TELNET_DONE
#endif

/* Most unix machines support username only with rlogin */
#if !defined(TELNET_DONE) && (defined(UNIX) || defined(DOSPATH) || defined(__CYGWIN__))

#define FMT_RLOGIN "%s %s%s%s"
#define FMT_TN3270 "%s %s %s"
#define FMT_TELNET "%s %s %s"

    switch (login_protocol) {
    case rlogin:
	if ((program = HTGetProgramPath(ppRLOGIN)) != NULL) {
	    HTAddParam(&command, FMT_RLOGIN, 1, program);
	    HTAddParam(&command, FMT_RLOGIN, 2, hostname);
	    HTOptParam(&command, FMT_RLOGIN, 3, user ? " -l " : "");
	    HTAddParam(&command, FMT_RLOGIN, 4, user);
	    HTEndParam(&command, FMT_RLOGIN, 4);
	}
	break;

    case tn3270:
	if ((program = HTGetProgramPath(ppTN3270)) != NULL) {
	    HTAddParam(&command, FMT_TN3270, 1, program);
	    HTAddParam(&command, FMT_TN3270, 2, hostname);
	    HTAddParam(&command, FMT_TN3270, 3, port);
	    HTEndParam(&command, FMT_TN3270, 3);
	}
	break;

    case telnet:
	if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	    HTAddParam(&command, FMT_TELNET, 1, program);
	    HTAddParam(&command, FMT_TELNET, 2, hostname);
	    HTAddParam(&command, FMT_TELNET, 3, port);
	    HTEndParam(&command, FMT_TELNET, 3);
	}
	break;
    }

    LYSystem(command);
#define TELNET_DONE
#endif /* unix */

/* VMS varieties */
#if !defined(TELNET_DONE) && (defined(MULTINET))
    if (login_protocol == rlogin) {
	HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",	/*lm 930713 */
		   user ? "/USERNAME=\"" : "",
		   NonNull(user),
		   user ? "\"" : "",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);

    } else if (login_protocol == tn3270) {
	HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);

    } else {			/* TELNET */
	HTSprintf0(&command, "TELNET %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);
    }

    do_system(command);
#define TELNET_DONE
#endif /* MULTINET */

#if !defined(TELNET_DONE) && defined(WIN_TCP)
    if ((cp = getenv("WINTCP_COMMAND_STYLE")) != NULL &&
	0 == strncasecomp(cp, "VMS", 3)) {	/* VMS command syntax */
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",		/*lm 930713 */
		       user ? "/USERNAME=\"" : "",
		       NonNull(user),
		       user ? "\"" : "",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);

	} else if (login_protocol == tn3270) {
	    HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);

	} else {		/* TELNET */
	    HTSprintf0(&command, "TELNET %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
	}

    } else {			/* UNIX command syntax */
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "RLOGIN %s%s%s%s%s",
		       hostname,
		       user ? " -l " : "",
		       user ? "\"" : "",
		       NonNull(user),
		       user ? "\"" : "");

	} else if (login_protocol == tn3270) {
	    HTSprintf0(&command, "TN3270 %s %s",
		       hostname,
		       NonNull(port));

	} else {		/* TELNET */
	    HTSprintf0(&command, "TELNET %s %s",
		       hostname,
		       NonNull(port));
	}
    }

    do_system(command);
#define TELNET_DONE
#endif /* WIN_TCP */

#if !defined(TELNET_DONE) && defined(UCX)
    if (login_protocol == rlogin) {
	HTSprintf0(&command, "RLOGIN%s%s%s %s %s",
		   user ? "/USERNAME=\"" : "",
		   NonNull(user),
		   user ? "\"" : "",
		   hostname,
		   NonNull(port));

    } else if (login_protocol == tn3270) {
	HTSprintf0(&command, "TN3270 %s %s",
		   hostname,
		   NonNull(port));

    } else {			/* TELNET */
	HTSprintf0(&command, "TELNET %s %s",
		   hostname,
		   NonNull(port));
    }

    do_system(command);
#define TELNET_DONE
#endif /* UCX */

#if !defined(TELNET_DONE) && defined(CMU_TCP)
    if (login_protocol == telnet) {
	HTSprintf0(&command, "TELNET %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);
	do_system(command);
    } else {
	printf("\nSorry, this browser was compiled without the %s access option.\n",
	       acc_method);
	printf("\nPress <return> to return to Lynx.");
	LYgetch();
	HadVMSInterrupt = FALSE;
    }
#define TELNET_DONE
#endif /* CMU_TCP */

#if !defined(TELNET_DONE) && defined(SOCKETSHR_TCP)
    if (getenv("MULTINET_SOCKET_LIBRARY") != NULL) {
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "MULTINET RLOGIN%s%s%s%s %s",	/*lm 930713 */
		       user ? "/USERNAME=" : "",
		       NonNull(user),
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);

	} else if (login_protocol == tn3270) {
	    HTSprintf0(&command, "MULTINET TELNET/TN3270 %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);

	} else {		/* TELNET */
	    HTSprintf0(&command, "MULTINET TELNET %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
	}

	do_system(command);
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if ((cp = getenv("WINTCP_COMMAND_STYLE")) != NULL) {
	if (0 == strncasecomp(cp, "VMS", 3)) {	/* VMS command syntax */
	    if (login_protocol == rlogin) {
		HTSprintf0(&command, "RLOGIN%s%s%s%s %s",	/*lm 930713 */
			   user ? "/USERNAME=" : "",
			   NonNull(user),
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
	    } else {		/* TELNET */
		HTSprintf0(&command, "TELNET %s%s %s",
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
	    }
	} else {		/* UNIX command syntax */
	    if (login_protocol == rlogin) {
		HTSprintf0(&command, "RLOGIN %s%s%s",
			   hostname,
			   user ? " -l " : "",
			   NonNull(user));
	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TN3270 %s %s",
			   hostname,
			   NonNull(port));
	    } else {		/* TELNET */
		HTSprintf0(&command, "TELNET %s %s",
			   hostname,
			   NonNull(port));
	    }
	}

	do_system(command);
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if (getenv("UCX$DEVICE") != NULL
	       || getenv("TCPIP$DEVICE") != NULL) {
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "RLOGIN%s%s %s %s",
		       user ? "/USERNAME=" : "",
		       NonNull(user),
		       hostname,
		       NonNull(port));

	} else if (login_protocol == tn3270) {
	    HTSprintf0(&command, "TN3270 %s %s",
		       hostname,
		       NonNull(port));

	} else {		/* TELNET */
	    HTSprintf0(&command, "TELNET %s %s",
		       hostname,
		       NonNull(port));
	}

	do_system(command);
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if (getenv("CMUTEK_ROOT") != NULL) {
	if (login_protocol == telnet) {
	    HTSprintf0(&command, "TELNET %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
	    do_system(command);
	} else {
	    printf("\nSorry, this browser was compiled without the %s access option.\n",
		   acc_method);
	    printf("\nPress <return> to return to Lynx.");
	    LYgetch();
	    HadVMSInterrupt = FALSE;
	}
    } else {
	if (login_protocol == telnet) {
	    HTSprintf0(&command, "TELNET %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
	    do_system(command);
	} else {
	    printf("\nSorry, this browser was compiled without the %s access option.\n",
		   acc_method);
	    printf("\nPress <return> to return to Lynx.");
	    LYgetch();
	    HadVMSInterrupt = FALSE;
	}
    }
#define TELNET_DONE
#endif /* SOCKETSHR_TCP */

#if !defined(TELNET_DONE) && (defined(SIMPLE_TELNET) || defined(VM))
    if (login_protocol == telnet) {	/* telnet only */
	HTSprintf0(&command, "TELNET  %s",	/* @@@@ Bug: port ignored */
		   hostname);
	do_system(command);
	return HT_NO_DATA;	/* Ok - it was done but no data */
    }
#define TELNET_DONE
#endif

#ifndef TELNET_DONE
    printf("\nSorry, this browser was compiled without the %s access option.\n",
	   acc_method);
    printf("\nTo access the information you must %s to %s", acc_method, hostname);
    if (port)
	printf(" (port %s)", port);
    if (user)
	printf("\nlogging in with username %s", user);
    printf(".\n");
    {
	printf("\nPress <return> to return to Lynx.");
	fflush(stdout);
	LYgetch();
#ifdef VMS
	HadVMSInterrupt = FALSE;
#endif /* VMS */
    }
#endif /* !TELNET_DONE */
    return HT_NO_DATA;
}

/*	"Load a document" -- establishes a session
 *	------------------------------------------
 *
 * On entry,
 *	addr		must point to the fully qualified hypertext reference.
 *
 * On exit,
 *	returns		<0	Error has occured.
 *			>=0	Value of file descriptor or socket to be used
 *				 to read data.
 *	*pFormat	Set to the format of the file, if known.
 *			(See WWW.h)
 *
 */
static int HTLoadTelnet(const char *addr,
			HTParentAnchor *anchor GCC_UNUSED,
			HTFormat format_out GCC_UNUSED,
			HTStream *sink)		/* Ignored */
{
    char *acc_method;
    char *host;
    int status;

    if (sink) {
	CTRACE((tfp,
		"HTTelnet: Can't output a live session -- must be interactive!\n"));
	return HT_NO_DATA;
    }
    acc_method = HTParse(addr, STR_FILE_URL, PARSE_ACCESS);

    host = HTParse(addr, "", PARSE_HOST);
    if (!host || *host == '\0') {
	status = HT_NO_DATA;
	CTRACE((tfp, "HTTelnet: No host specified!\n"));
    } else {
	status = remote_session(acc_method, host);
    }

    FREE(host);
    FREE(acc_method);
    do_system(NULL);	/* silence gcc */
    return status;
}

#ifdef GLOBALDEF_IS_MACRO
#define _HTTELNET_C_1_INIT { "telnet", HTLoadTelnet, NULL }
#define _HTTELNET_C_2_INIT { "rlogin", HTLoadTelnet, NULL }
#define _HTTELNET_C_3_INIT { "tn3270", HTLoadTelnet, NULL }
GLOBALDEF(HTProtocol, HTTelnet, _HTTELNET_C_1_INIT);
GLOBALDEF(HTProtocol, HTRlogin, _HTTELNET_C_2_INIT);
GLOBALDEF(HTProtocol, HTTn3270, _HTTELNET_C_3_INIT);
#else
GLOBALDEF HTProtocol HTTelnet =
{"telnet", HTLoadTelnet, NULL};
GLOBALDEF HTProtocol HTRlogin =
{"rlogin", HTLoadTelnet, NULL};
GLOBALDEF HTProtocol HTTn3270 =
{"tn3270", HTLoadTelnet, NULL};
#endif /* GLOBALDEF_IS_MACRO */
@


1.5
log
@automatic merge of lynx-current
@
text
@d1 2
d531 1
@


1.4
log
@pretty much automatic merge of Lynx update
now, we live in an ANSI C world...
@
text
@d2 13
a14 13
**		==========================
**
** Authors
**	TBL	Tim Berners-Lee timbl@@info.cern.ch
**	JFG	Jean-Francois Groff jgh@@next.com
**	DD	Denis DeLaRoca (310) 825-4580  <CSP1DWD@@mvs.oac.ucla.edu>
** History
**	 8 Jun 92 Telnet hopping prohibited as telnet is not secure (TBL)
**	26 Jun 92 When over DECnet, suppressed FTP, Gopher and News. (JFG)
**	 6 Oct 92 Moved HTClientHost and logfile into here. (TBL)
**	17 Dec 92 Tn3270 added, bug fix. (DD)
**	 2 Feb 93 Split from HTAccess.c.  Registration.(TBL)
*/
d38 1
a38 1
static void do_system (char *  command)
d48 3
a50 3
**	-------------------------
*/
static int remote_session (char *  acc_method, char *  host)
d53 28
a80 25
	char * user = host;
	char * password = NULL;
	char * cp;
	char * hostname;
	char * port;
	char * command = NULL;
	enum _login_protocol { telnet, rlogin, tn3270 } login_protocol =
		strcmp(acc_method, "rlogin") == 0 ? rlogin :
		strcmp(acc_method, "tn3270") == 0 ? tn3270 : telnet;

	/*
	 *	Modified to allow for odd chars in a username only if exists.
	 *	05-28-94 Lynx 2-3-1 Garrett Arch Blythe
	 */
	/* prevent telnet://hostname;rm -rf *  URL's (VERY BAD)
	 *  *cp=0;  / * terminate at any ;,<,>,`,|,",' or space or return
	 *  or tab to prevent security whole
	 */
	for(cp = (strchr(host, '@@') ? strchr(host, '@@') : host); *cp != '\0';
		cp++)	{
	    if(!isalnum(UCH(*cp)) && *cp != '_' && *cp != '-' &&
				*cp != ':' && *cp != '.' && *cp != '@@') {
		*cp = '\0';
		break;
	    }
d82 1
d84 1
a84 1
	hostname = strchr(host, '@@');
d86 10
a95 6
	if (hostname) {
	    *hostname++ = '\0'; /* Split */
	} else {
	    hostname = host;
	    user = NULL;	/* No user specified */
	}
d97 17
a113 3
	port = strchr(hostname, ':');
	if (port)
	    *port++ = '\0';	/* Split */
d115 4
a118 22
	if (!hostname || *hostname == '\0') {
	    CTRACE((tfp, "HTTelnet: No host specified!\n"));
	    return HT_NO_DATA;
	} else if (!valid_hostname(hostname)) {
	    char *prefix = NULL;
	    char *line = NULL;
	    CTRACE((tfp, "HTTelnet: Invalid hostname %s!\n", host));
	    HTSprintf0(&prefix,
		       gettext("remote %s session:"), acc_method);
	    HTSprintf0(&line,
		       gettext("Invalid hostname %s"), host);
	    HTAlwaysAlert(prefix, line);
	    FREE(prefix);
	    FREE(line);
	    return HT_NO_DATA;
	}

	if (user) {
	    password = strchr(user, ':');
	    if (password) {
		*password++ = '\0';
	    }
d120 1
d122 2
a123 2
	/* If the person is already telnetting etc, forbid hopping */
	/* This is a security precaution, for us and remote site */
d125 1
a125 1
	if (HTSecure) {
d128 4
a131 4
	    HTSprintf0(&command,
	      "finger @@%s | mail -s \"**telnethopper %s\" tbl@@dxcern.cern.ch",
	       HTClientHost, HTClientHost);
	    do_system(command);
d133 18
a150 5
	    printf("\n\nSorry, but the service you have selected is one\n");
	    printf("to which you have to log in.  If you were running www\n");
	    printf("on your own computer, you would be automatically connected.\n");
	    printf("For security reasons, this is not allowed when\n");
	    printf("you log in to this information service remotely.\n\n");
d152 8
a159 18
	    printf("You can manually connect to this service using %s\n",
		   acc_method);
	    printf("to host %s", hostname);
	    if (user) printf(", user name %s", user);
	    if (password) printf(", password %s", password);
	    if (port) printf(", port %s", port);
	    printf(".\n\n");
	    return HT_NO_DATA;
	}

	/* Not all telnet servers get it even if user name is specified
	** so we always tell the guy what to log in as
	*/
	if (user && login_protocol != rlogin)
	    printf("When you are connected, log in as:  %s\n", user);
	if (password && login_protocol != rlogin)
	    printf("                  The password is:  %s\n", password);
	fflush(stdout);
d168 9
a176 9
	if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	    HTAddParam(&command, FMT_TELNET, 1, program);
	    HTOptParam(&command, FMT_TELNET, 2, user ? " -l " : "");
	    HTAddParam(&command, FMT_TELNET, 3, user);
	    HTAddParam(&command, FMT_TELNET, 4, hostname);
	    HTAddParam(&command, FMT_TELNET, 5, port);
	    HTEndParam(&command, FMT_TELNET, 5);
	}
	do_system(command);
d187 19
a205 10
	switch (login_protocol) {
	case rlogin:
	    if ((program = HTGetProgramPath(ppRLOGIN)) != NULL) {
		HTAddParam(&command, FMT_RLOGIN, 1, program);
		HTAddParam(&command, FMT_RLOGIN, 2, hostname);
		HTOptParam(&command, FMT_RLOGIN, 3, user ? " -l " : "");
		HTAddParam(&command, FMT_RLOGIN, 4, user);
		HTEndParam(&command, FMT_RLOGIN, 4);
	    }
	    break;
d207 6
a212 17
	case tn3270:
	    if ((program = HTGetProgramPath(ppTN3270)) != NULL) {
		HTAddParam(&command, FMT_TN3270, 1, program);
		HTAddParam(&command, FMT_TN3270, 2, hostname);
		HTAddParam(&command, FMT_TN3270, 3, port);
		HTEndParam(&command, FMT_TN3270, 3);
	    }
	    break;

	case telnet:
	    if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
		HTAddParam(&command, FMT_TELNET, 1, program);
		HTAddParam(&command, FMT_TELNET, 2, hostname);
		HTAddParam(&command, FMT_TELNET, 3, port);
		HTEndParam(&command, FMT_TELNET, 3);
	    }
	    break;
d214 2
d217 1
a217 1
        LYSystem(command);
d223 29
d253 7
a259 7
	    HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",  /*lm 930713 */
		user ? "/USERNAME=\"" : "",
		NonNull(user),
		user ? "\"" : "",
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d263 3
a265 3
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d267 1
a267 1
	} else {  /* TELNET */
d269 3
a271 3
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d274 8
a281 3
	do_system(command);
#define TELNET_DONE
#endif /* MULTINET */
d283 4
a286 11
#if !defined(TELNET_DONE) && defined(WIN_TCP)
	if ((cp=getenv("WINTCP_COMMAND_STYLE")) != NULL &&
	    0==strncasecomp(cp, "VMS", 3)) { /* VMS command syntax */
	    if (login_protocol == rlogin) {
		HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",  /*lm 930713 */
		    user ? "/USERNAME=\"" : "",
		    NonNull(user),
		    user ? "\"" : "",
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);
d288 4
a291 32
	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);

	    } else {  /* TELNET */
		HTSprintf0(&command, "TELNET %s%s %s",
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);
	    }

	} else { /* UNIX command syntax */
	   if (login_protocol == rlogin) {
	       HTSprintf0(&command, "RLOGIN %s%s%s%s%s",
		   hostname,
		   user ? " -l " : "",
		   user ? "\"" : "",
		   NonNull(user),
		   user ? "\"" : "");

	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TN3270 %s %s",
		    hostname,
		    NonNull(port));

	    } else {  /* TELNET */
		HTSprintf0(&command, "TELNET %s %s",
		    hostname,
		    NonNull(port));
	    }
d293 1
d295 1
a295 1
	do_system(command);
d300 7
a306 7
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "RLOGIN%s%s%s %s %s",
		user ? "/USERNAME=\"" : "",
		NonNull(user),
		user ? "\"" : "",
		hostname,
		NonNull(port));
d308 4
a311 4
	} else if (login_protocol == tn3270) {
	    HTSprintf0(&command, "TN3270 %s %s",
		hostname,
		NonNull(port));
d313 5
a317 5
	} else {  /* TELNET */
	    HTSprintf0(&command, "TELNET %s %s",
		hostname,
		NonNull(port));
	}
d319 1
a319 1
	do_system(command);
d324 13
a336 15
	if (login_protocol == telnet) {
	    HTSprintf0(&command, "TELNET %s%s %s",
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
	    do_system(command);
	}
	else {
	    printf(
	"\nSorry, this browser was compiled without the %s access option.\n",
		acc_method);
	    printf("\nPress <return> to return to Lynx.");
	    LYgetch();
	    HadVMSInterrupt = FALSE;
	}
d343 6
a348 6
	    HTSprintf0(&command, "MULTINET RLOGIN%s%s%s%s %s",  /*lm 930713 */
		user ? "/USERNAME=" : "",
		NonNull(user),
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d352 3
a354 3
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d356 1
a356 1
	} else {  /* TELNET */
d358 3
a360 3
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d364 3
a366 4
	return HT_NO_DATA;		/* Ok - it was done but no data */
    }
    else if ((cp=getenv("WINTCP_COMMAND_STYLE")) != NULL) {
	if (0==strncasecomp(cp, "VMS", 3)) { /* VMS command syntax */
d368 6
a373 6
		HTSprintf0(&command, "RLOGIN%s%s%s%s %s",  /*lm 930713 */
		    user ? "/USERNAME=" : "",
		    NonNull(user),
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);
d376 4
a379 4
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);
	    } else {  /* TELNET */
d381 3
a383 3
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);
d385 1
a385 1
	} else { /* UNIX command syntax */
d388 3
a390 3
		    hostname,
		    user ? " -l " : "",
		    NonNull(user));
d393 3
a395 3
		    hostname,
		    NonNull(port));
	    } else {  /* TELNET */
d397 2
a398 2
		    hostname,
		    NonNull(port));
d403 3
a405 4
	return HT_NO_DATA;		/* Ok - it was done but no data */
    }
    else if (getenv("UCX$DEVICE") != NULL
          || getenv("TCPIP$DEVICE") != NULL) {
d408 4
a411 4
		user ? "/USERNAME=" : "",
		NonNull(user),
		hostname,
		NonNull(port));
d415 2
a416 2
		hostname,
		NonNull(port));
d418 1
a418 1
	} else {  /* TELNET */
d420 2
a421 2
		hostname,
		NonNull(port));
d425 2
a426 3
	return HT_NO_DATA;		/* Ok - it was done but no data */
    }
    else if (getenv("CMUTEK_ROOT") != NULL) {
d429 3
a431 3
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d433 3
a435 5
	}
	else {
	    printf(
	  "\nSorry, this browser was compiled without the %s access option.\n",
		acc_method);
d440 1
a440 2
    }
    else {
d443 3
a445 3
		port ? "/PORT=" : "",
		NonNull(port),
		hostname);
d447 3
a449 5
	}
	else {
	    printf(
	  "\nSorry, this browser was compiled without the %s access option.\n",
		acc_method);
d459 6
a464 6
	if (login_protocol == telnet) {			/* telnet only */
	    HTSprintf0(&command, "TELNET  %s",	/* @@@@ Bug: port ignored */
		hostname);
	    do_system(command);
	    return HT_NO_DATA;		/* Ok - it was done but no data */
	}
d469 12
a480 14
	printf(
	"\nSorry, this browser was compiled without the %s access option.\n",
		acc_method);
	printf(
	"\nTo access the information you must %s to %s", acc_method, hostname);
	if (port)
	    printf(" (port %s)", port);
	if (user)
	    printf("\nlogging in with username %s", user);
	printf(".\n");
	{
	    printf("\nPress <return> to return to Lynx.");
	    fflush(stdout);
	    LYgetch();
d482 1
a482 1
	    HadVMSInterrupt = FALSE;
d484 1
a484 1
	}
d486 1
a486 1
	return HT_NO_DATA;
d490 17
a506 20
**	------------------------------------------
**
** On entry,
**	addr		must point to the fully qualified hypertext reference.
**
** On exit,
**	returns		<0	Error has occured.
**			>=0	Value of file descriptor or socket to be used
**				 to read data.
**	*pFormat	Set to the format of the file, if known.
**			(See WWW.h)
**
*/
static int HTLoadTelnet
(
 const char *		addr,
 HTParentAnchor *	anchor GCC_UNUSED,
 HTFormat		format_out GCC_UNUSED,
 HTStream *		sink			/* Ignored */
)
d508 2
a509 2
    char * acc_method;
    char * host;
d513 2
a514 1
	CTRACE((tfp, "HTTelnet: Can't output a live session -- must be interactive!\n"));
d517 1
a517 1
    acc_method =  HTParse(addr, STR_FILE_URL, PARSE_ACCESS);
a531 1

d536 3
a538 3
GLOBALDEF (HTProtocol, HTTelnet, _HTTELNET_C_1_INIT );
GLOBALDEF (HTProtocol, HTRlogin, _HTTELNET_C_2_INIT );
GLOBALDEF (HTProtocol, HTTn3270, _HTTELNET_C_3_INIT );
d540 6
a545 3
GLOBALDEF HTProtocol HTTelnet = { "telnet", HTLoadTelnet, NULL };
GLOBALDEF HTProtocol HTRlogin = { "rlogin", HTLoadTelnet, NULL };
GLOBALDEF HTProtocol HTTn3270 = { "tn3270", HTLoadTelnet, NULL };
@


1.3
log
@un-tar the file
>>> lynx2.8.5dev.16.tar.gz
from http://lynx.isc.org/current/

the following files need -kb:
- LYStyle.c
- Xsystem.c
- WWW HTMIME.c
@
text
@d38 1
a38 1
PRIVATE void do_system ARGS1(char *, command)
d50 1
a50 1
PRIVATE int remote_session ARGS2(char *, acc_method, char *, host)
d52 1
a52 1
    CONST char *program;
d507 1
a507 2
PRIVATE int HTLoadTelnet
ARGS4
d509 4
a512 4
 CONST char *,		addr,
 HTParentAnchor *,	anchor GCC_UNUSED,
 HTFormat,		format_out GCC_UNUSED,
 HTStream *,		sink			/* Ignored */
d547 3
a549 3
GLOBALDEF PUBLIC HTProtocol HTTelnet = { "telnet", HTLoadTelnet, NULL };
GLOBALDEF PUBLIC HTProtocol HTRlogin = { "rlogin", HTLoadTelnet, NULL };
GLOBALDEF PUBLIC HTProtocol HTTn3270 = { "tn3270", HTLoadTelnet, NULL };
@


1.2
log
@remove lynx 2.8.4 patchlevel 1d
@
text
@d35 1
d40 5
a44 3
    CTRACE(tfp, "HTTelnet: Command is: %s\n\n", command);
    system(command);
    FREE(command);
d52 1
d71 3
a73 2
	for(cp = host; *cp != '\0'; cp++) {
	    if(!isalnum(*cp) && *cp != '_' && *cp != '-' &&
d94 1
a94 1
	    CTRACE(tfp, "HTTelnet: No host specified!\n");
d99 1
a99 1
	    CTRACE(tfp, "HTTelnet: Invalid hostname %s!\n", host);
d157 1
a157 1
#if	defined(NeXT) && defined(NeXTSTEP) && NeXTSTEP<=20100
d160 8
a167 7
	HTAddParam(&command, FMT_TELNET, 1, TELNET_PATH);
	HTOptParam(&command, FMT_TELNET, 2, user ? " -l " : "");
	HTAddParam(&command, FMT_TELNET, 3, user);
	HTAddParam(&command, FMT_TELNET, 4, hostname);
	HTAddParam(&command, FMT_TELNET, 5, port);
	HTEndParam(&command, FMT_TELNET, 5);

a168 1
	return HT_NO_DATA;		/* Ok - it was done but no data */
d172 2
a173 3
/* Most unix machines suppport username only with rlogin */
#if defined(unix) || defined(DOSPATH)
#ifndef TELNET_DONE
d179 10
a188 1
	if (login_protocol == rlogin) {
d190 8
a197 5
	    HTAddParam(&command, FMT_RLOGIN, 1, RLOGIN_PATH);
	    HTAddParam(&command, FMT_RLOGIN, 2, hostname);
	    HTOptParam(&command, FMT_RLOGIN, 3, user ? " -l " : "");
	    HTAddParam(&command, FMT_RLOGIN, 4, user);
	    HTEndParam(&command, FMT_RLOGIN, 4);
d199 8
a206 13
	} else if (login_protocol == tn3270) {

	    HTAddParam(&command, FMT_TN3270, 1, TN3270_PATH);
	    HTAddParam(&command, FMT_TN3270, 2, hostname);
	    HTAddParam(&command, FMT_TN3270, 3, port);
	    HTEndParam(&command, FMT_TN3270, 3);

	} else {  /* TELNET */

	    HTAddParam(&command, FMT_TELNET, 1, TELNET_PATH);
	    HTAddParam(&command, FMT_TELNET, 2, hostname);
	    HTAddParam(&command, FMT_TELNET, 3, port);
	    HTEndParam(&command, FMT_TELNET, 3);
d209 1
a209 10
#ifdef __DJGPP__
       __djgpp_set_ctrl_c(0);
       _go32_want_ctrl_break(1);
#endif /* __DJGPP__ */
	do_system(command);
#ifdef __DJGPP__
       __djgpp_set_ctrl_c(1);
       _go32_want_ctrl_break(0);
#endif /* __DJGPP__ */
	return HT_NO_DATA;		/* Ok - it was done but no data */
a210 1
#endif /* !TELNET_DONE */
d214 1
a214 1
#if defined(MULTINET)
d218 1
a218 1
		user ? user : "",
d221 1
a221 1
		port ? port : "",
d227 1
a227 1
		port ? port : "",
d233 1
a233 1
		port ? port : "",
a237 1
	return HT_NO_DATA;		/* Ok - it was done but no data */
d241 17
a257 3
#if defined(WIN_TCP)
	{
	    char *cp;
d259 5
a263 43
	    if ((cp=getenv("WINTCP_COMMAND_STYLE")) != NULL &&
		0==strncasecomp(cp, "VMS", 3)) { /* VMS command syntax */
		if (login_protocol == rlogin) {
		    HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",  /*lm 930713 */
			user ? "/USERNAME=\"" : "",
			user ? user : "",
			user ? "\"" : "",
			port ? "/PORT=" : "",
			port ? port : "",
			hostname);

		} else if (login_protocol == tn3270) {
		    HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
			port ? "/PORT=" : "",
			port ? port : "",
			hostname);

		} else {  /* TELNET */
		    HTSprintf0(&command, "TELNET %s%s %s",
			port ? "/PORT=" : "",
			port ? port : "",
			hostname);
		}

	    } else { /* UNIX command syntax */
	       if (login_protocol == rlogin) {
		   HTSprintf0(&command, "RLOGIN %s%s%s%s%s",
		       hostname,
		       user ? " -l " : "",
		       user ? "\"" : "",
		       user ? user : "",
		       user ? "\"" : "");

		} else if (login_protocol == tn3270) {
		    HTSprintf0(&command, "TN3270 %s %s",
			hostname,
			port ? port : "");

		} else {  /* TELNET */
		    HTSprintf0(&command, "TELNET %s %s",
			hostname,
			port ? port : "");
		}
d266 19
a284 2
	    do_system(command);
	    return HT_NO_DATA;		/* Ok - it was done but no data */
d286 2
d291 1
a291 1
#ifdef UCX
d295 1
a295 1
		user ? user : "",
d298 1
a298 1
		port ? port : "");
d303 1
a303 1
		port ? port : "");
d308 1
a308 1
		port ? port : "");
a311 1
	return HT_NO_DATA;		/* Ok - it was done but no data */
d315 1
a315 1
#ifdef CMU_TCP
d319 1
a319 1
		port ? port : "",
a323 2
	    extern BOOLEAN HadVMSInterrupt;

a330 1
	return HT_NO_DATA;		/* Ok - it was done but no data */
d334 1
a334 4
#ifdef SOCKETSHR_TCP
  {
    char *cp;

d339 1
a339 1
		user ? user : "",
d341 1
a341 1
		port ? port : "",
d347 1
a347 1
		port ? port : "",
d353 1
a353 1
		port ? port : "",
d365 1
a365 1
		    user ? user : "",
d367 1
a367 1
		    port ? port : "",
d372 1
a372 1
		    port ? port : "",
d377 1
a377 1
		    port ? port : "",
d385 1
a385 1
		    user ? user : "");
d389 1
a389 1
		    port ? port : "");
d393 1
a393 1
		    port ? port : "");
d400 2
a401 1
    else if (getenv("UCX$DEVICE") != NULL) {
d405 1
a405 1
		user ? user : "",
d407 1
a407 1
		port ? port : "");
d412 1
a412 1
		port ? port : "");
d417 1
a417 1
		port ? port : "");
d427 1
a427 1
		port ? port : "",
a431 2
	    extern BOOLEAN HadVMSInterrupt;

a438 1
	return HT_NO_DATA;		/* Ok - it was done but no data */
d444 1
a444 1
		port ? port : "",
a448 2
	    extern BOOLEAN HadVMSInterrupt;

a455 1
	return HT_NO_DATA;		/* Ok - it was done but no data */
a456 1
  }
d460 1
a460 4
#ifdef VM
#define SIMPLE_TELNET
#endif
#ifdef SIMPLE_TELNET
d467 1
d486 1
a486 4
	    {
		extern BOOLEAN HadVMSInterrupt;
		HadVMSInterrupt = FALSE;
	    }
d489 1
a490 1
#endif /* !TELNET_DONE */
d521 1
a521 1
	CTRACE(tfp, "HTTelnet: Can't output a live session -- must be interactive!\n");
d524 1
a524 1
    acc_method =  HTParse(addr, "file:", PARSE_ACCESS);
d529 1
a529 1
	CTRACE(tfp, "HTTelnet: No host specified!\n");
@


1.1
log
@Initial revision
@
text
@@


1.1.2.1
log
@Lynx 2.8.6dev.10 as imported into ncvs
@
text
@d2 13
a14 13
 *		==========================
 *
 * Authors
 *	TBL	Tim Berners-Lee timbl@@info.cern.ch
 *	JFG	Jean-Francois Groff jgh@@next.com
 *	DD	Denis DeLaRoca (310) 825-4580  <CSP1DWD@@mvs.oac.ucla.edu>
 * History
 *	 8 Jun 92 Telnet hopping prohibited as telnet is not secure (TBL)
 *	26 Jun 92 When over DECnet, suppressed FTP, Gopher and News. (JFG)
 *	 6 Oct 92 Moved HTClientHost and logfile into here. (TBL)
 *	17 Dec 92 Tn3270 added, bug fix. (DD)
 *	 2 Feb 93 Split from HTAccess.c.  Registration.(TBL)
 */
a34 1
#include <LYClean.h>
d37 1
a37 1
static void do_system(char *command)
d39 3
a41 5
    if (!isEmpty(command)) {
	CTRACE((tfp, "HTTelnet: Command is: %s\n\n", command));
	LYSystem(command);
	FREE(command);
    }
d45 3
a47 3
 *	-------------------------
 */
static int remote_session(char *acc_method, char *host)
d49 24
a72 29
    const char *program;
    char *user = host;
    char *password = NULL;
    char *cp;
    char *hostname;
    char *port;
    char *command = NULL;
    enum _login_protocol {
	telnet,
	rlogin,
	tn3270
    } login_protocol =
      strcmp(acc_method, "rlogin") == 0 ? rlogin :
      strcmp(acc_method, "tn3270") == 0 ? tn3270 : telnet;

    /*
     * Modified to allow for odd chars in a username only if exists.
     * 05-28-94 Lynx 2-3-1 Garrett Arch Blythe
     */
    /* prevent telnet://hostname;rm -rf *  URL's (VERY BAD)
     *  *cp=0;        // terminate at any ;,<,>,`,|,",' or space or return
     * or tab to prevent security whole
     */
    for (cp = (strchr(host, '@@') ? strchr(host, '@@') : host); *cp != '\0';
	 cp++) {
	if (!isalnum(UCH(*cp)) && *cp != '_' && *cp != '-' &&
	    *cp != ':' && *cp != '.' && *cp != '@@') {
	    *cp = '\0';
	    break;
a73 1
    }
d75 1
a75 1
    hostname = strchr(host, '@@');
d77 6
a82 6
    if (hostname) {
	*hostname++ = '\0';	/* Split */
    } else {
	hostname = host;
	user = NULL;		/* No user specified */
    }
d84 3
a86 3
    port = strchr(hostname, ':');
    if (port)
	*port++ = '\0';		/* Split */
d88 22
a109 22
    if (!hostname || *hostname == '\0') {
	CTRACE((tfp, "HTTelnet: No host specified!\n"));
	return HT_NO_DATA;
    } else if (!valid_hostname(hostname)) {
	char *prefix = NULL;
	char *line = NULL;

	CTRACE((tfp, "HTTelnet: Invalid hostname %s!\n", host));
	HTSprintf0(&prefix,
		   gettext("remote %s session:"), acc_method);
	HTSprintf0(&line,
		   gettext("Invalid hostname %s"), host);
	HTAlwaysAlert(prefix, line);
	FREE(prefix);
	FREE(line);
	return HT_NO_DATA;
    }

    if (user) {
	password = strchr(user, ':');
	if (password) {
	    *password++ = '\0';
a110 1
    }
d112 2
a113 2
    /* If the person is already telnetting etc, forbid hopping */
    /* This is a security precaution, for us and remote site */
d115 1
a115 1
    if (HTSecure) {
d118 4
a121 4
	HTSprintf0(&command,
		   "finger @@%s | mail -s \"**telnethopper %s\" tbl@@dxcern.cern.ch",
		   HTClientHost, HTClientHost);
	do_system(command);
d123 15
a137 18
	printf("\n\nSorry, but the service you have selected is one\n");
	printf("to which you have to log in.  If you were running www\n");
	printf("on your own computer, you would be automatically connected.\n");
	printf("For security reasons, this is not allowed when\n");
	printf("you log in to this information service remotely.\n\n");

	printf("You can manually connect to this service using %s\n",
	       acc_method);
	printf("to host %s", hostname);
	if (user)
	    printf(", user name %s", user);
	if (password)
	    printf(", password %s", password);
	if (port)
	    printf(", port %s", port);
	printf(".\n\n");
	return HT_NO_DATA;
    }
d139 8
a146 8
    /* Not all telnet servers get it even if user name is specified so we
     * always tell the guy what to log in as.
     */
    if (user && login_protocol != rlogin)
	printf("When you are connected, log in as:  %s\n", user);
    if (password && login_protocol != rlogin)
	printf("                  The password is:  %s\n", password);
    fflush(stdout);
d152 1
a152 1
#if	!defined(TELNET_DONE) && (defined(NeXT) && defined(NeXTSTEP) && NeXTSTEP<=20100)
d155 1
a155 2
    if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	HTAddParam(&command, FMT_TELNET, 1, program);
d161 3
a163 2
    }
    do_system(command);
d167 3
a169 2
/* Most unix machines support username only with rlogin */
#if !defined(TELNET_DONE) && (defined(UNIX) || defined(DOSPATH) || defined(__CYGWIN__))
d175 3
a177 4
    switch (login_protocol) {
    case rlogin:
	if ((program = HTGetProgramPath(ppRLOGIN)) != NULL) {
	    HTAddParam(&command, FMT_RLOGIN, 1, program);
a181 2
	}
	break;
d183 3
a185 3
    case tn3270:
	if ((program = HTGetProgramPath(ppTN3270)) != NULL) {
	    HTAddParam(&command, FMT_TN3270, 1, program);
a188 2
	}
	break;
d190 3
a192 3
    case telnet:
	if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	    HTAddParam(&command, FMT_TELNET, 1, program);
a196 2
	break;
    }
d198 10
a207 1
    LYSystem(command);
d209 1
d213 1
a213 30
#if !defined(TELNET_DONE) && (defined(MULTINET))
    if (login_protocol == rlogin) {
	HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",	/*lm 930713 */
		   user ? "/USERNAME=\"" : "",
		   NonNull(user),
		   user ? "\"" : "",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);

    } else if (login_protocol == tn3270) {
	HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);

    } else {			/* TELNET */
	HTSprintf0(&command, "TELNET %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);
    }

    do_system(command);
#define TELNET_DONE
#endif /* MULTINET */

#if !defined(TELNET_DONE) && defined(WIN_TCP)
    if ((cp = getenv("WINTCP_COMMAND_STYLE")) != NULL &&
	0 == strncasecomp(cp, "VMS", 3)) {	/* VMS command syntax */
d215 7
a221 7
	    HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",		/*lm 930713 */
		       user ? "/USERNAME=\"" : "",
		       NonNull(user),
		       user ? "\"" : "",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d225 3
a227 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d229 1
a229 1
	} else {		/* TELNET */
d231 3
a233 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d236 36
a271 3
    } else {			/* UNIX command syntax */
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "RLOGIN %s%s%s%s%s",
d275 1
a275 1
		       NonNull(user),
d278 27
d307 2
a308 2
		       hostname,
		       NonNull(port));
d310 1
a310 1
	} else {		/* TELNET */
d312 2
a313 2
		       hostname,
		       NonNull(port));
a314 1
    }
d316 2
a317 1
    do_system(command);
d319 1
a319 1
#endif /* WIN_TCP */
d321 10
a330 19
#if !defined(TELNET_DONE) && defined(UCX)
    if (login_protocol == rlogin) {
	HTSprintf0(&command, "RLOGIN%s%s%s %s %s",
		   user ? "/USERNAME=\"" : "",
		   NonNull(user),
		   user ? "\"" : "",
		   hostname,
		   NonNull(port));

    } else if (login_protocol == tn3270) {
	HTSprintf0(&command, "TN3270 %s %s",
		   hostname,
		   NonNull(port));

    } else {			/* TELNET */
	HTSprintf0(&command, "TELNET %s %s",
		   hostname,
		   NonNull(port));
    }
d332 8
a339 1
    do_system(command);
d341 1
a341 1
#endif /* UCX */
d343 3
a345 16
#if !defined(TELNET_DONE) && defined(CMU_TCP)
    if (login_protocol == telnet) {
	HTSprintf0(&command, "TELNET %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);
	do_system(command);
    } else {
	printf("\nSorry, this browser was compiled without the %s access option.\n",
	       acc_method);
	printf("\nPress <return> to return to Lynx.");
	LYgetch();
	HadVMSInterrupt = FALSE;
    }
#define TELNET_DONE
#endif /* CMU_TCP */
a346 1
#if !defined(TELNET_DONE) && defined(SOCKETSHR_TCP)
d349 6
a354 6
	    HTSprintf0(&command, "MULTINET RLOGIN%s%s%s%s %s",	/*lm 930713 */
		       user ? "/USERNAME=" : "",
		       NonNull(user),
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d358 3
a360 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d362 1
a362 1
	} else {		/* TELNET */
d364 3
a366 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d370 4
a373 3
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if ((cp = getenv("WINTCP_COMMAND_STYLE")) != NULL) {
	if (0 == strncasecomp(cp, "VMS", 3)) {	/* VMS command syntax */
d375 6
a380 6
		HTSprintf0(&command, "RLOGIN%s%s%s%s %s",	/*lm 930713 */
			   user ? "/USERNAME=" : "",
			   NonNull(user),
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
d383 4
a386 4
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
	    } else {		/* TELNET */
d388 3
a390 3
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
d392 1
a392 1
	} else {		/* UNIX command syntax */
d395 3
a397 3
			   hostname,
			   user ? " -l " : "",
			   NonNull(user));
d400 3
a402 3
			   hostname,
			   NonNull(port));
	    } else {		/* TELNET */
d404 2
a405 2
			   hostname,
			   NonNull(port));
d410 3
a412 3
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if (getenv("UCX$DEVICE") != NULL
	       || getenv("TCPIP$DEVICE") != NULL) {
d415 4
a418 4
		       user ? "/USERNAME=" : "",
		       NonNull(user),
		       hostname,
		       NonNull(port));
d422 2
a423 2
		       hostname,
		       NonNull(port));
d425 1
a425 1
	} else {		/* TELNET */
d427 2
a428 2
		       hostname,
		       NonNull(port));
d432 3
a434 2
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if (getenv("CMUTEK_ROOT") != NULL) {
d437 3
a439 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d441 7
a447 3
	} else {
	    printf("\nSorry, this browser was compiled without the %s access option.\n",
		   acc_method);
d452 3
a454 1
    } else {
d457 3
a459 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d461 7
a467 3
	} else {
	    printf("\nSorry, this browser was compiled without the %s access option.\n",
		   acc_method);
d472 1
d474 1
d478 10
a487 8
#if !defined(TELNET_DONE) && (defined(SIMPLE_TELNET) || defined(VM))
    if (login_protocol == telnet) {	/* telnet only */
	HTSprintf0(&command, "TELNET  %s",	/* @@@@ Bug: port ignored */
		   hostname);
	do_system(command);
	return HT_NO_DATA;	/* Ok - it was done but no data */
    }
#define TELNET_DONE
d491 14
a504 12
    printf("\nSorry, this browser was compiled without the %s access option.\n",
	   acc_method);
    printf("\nTo access the information you must %s to %s", acc_method, hostname);
    if (port)
	printf(" (port %s)", port);
    if (user)
	printf("\nlogging in with username %s", user);
    printf(".\n");
    {
	printf("\nPress <return> to return to Lynx.");
	fflush(stdout);
	LYgetch();
d506 4
a509 1
	HadVMSInterrupt = FALSE;
d511 2
a512 1
    }
a513 1
    return HT_NO_DATA;
d517 21
a537 17
 *	------------------------------------------
 *
 * On entry,
 *	addr		must point to the fully qualified hypertext reference.
 *
 * On exit,
 *	returns		<0	Error has occured.
 *			>=0	Value of file descriptor or socket to be used
 *				 to read data.
 *	*pFormat	Set to the format of the file, if known.
 *			(See WWW.h)
 *
 */
static int HTLoadTelnet(const char *addr,
			HTParentAnchor *anchor GCC_UNUSED,
			HTFormat format_out GCC_UNUSED,
			HTStream *sink)		/* Ignored */
d539 2
a540 2
    char *acc_method;
    char *host;
d544 1
a544 2
	CTRACE((tfp,
		"HTTelnet: Can't output a live session -- must be interactive!\n"));
d547 1
a547 1
    acc_method = HTParse(addr, STR_FILE_URL, PARSE_ACCESS);
d552 1
a552 1
	CTRACE((tfp, "HTTelnet: No host specified!\n"));
d562 1
d567 3
a569 3
GLOBALDEF(HTProtocol, HTTelnet, _HTTELNET_C_1_INIT);
GLOBALDEF(HTProtocol, HTRlogin, _HTTELNET_C_2_INIT);
GLOBALDEF(HTProtocol, HTTn3270, _HTTELNET_C_3_INIT);
d571 3
a573 6
GLOBALDEF HTProtocol HTTelnet =
{"telnet", HTLoadTelnet, NULL};
GLOBALDEF HTProtocol HTRlogin =
{"rlogin", HTLoadTelnet, NULL};
GLOBALDEF HTProtocol HTTn3270 =
{"tn3270", HTLoadTelnet, NULL};
@


1.1.3.1
log
@Import Lynx 2.8.5.dev16 again, this time via a vendor branch (tg),
to ease tracking of the upcoming dev17 (2.8.6-prerelease) update.
@
text
@a34 1
#include <LYClean.h>
d39 3
a41 5
    if (!isEmpty(command)) {
	CTRACE((tfp, "HTTelnet: Command is: %s\n\n", command));
	LYSystem(command);
	FREE(command);
    }
a48 1
    CONST char *program;
d67 2
a68 3
	for(cp = (strchr(host, '@@') ? strchr(host, '@@') : host); *cp != '\0';
		cp++)	{
	    if(!isalnum(UCH(*cp)) && *cp != '_' && *cp != '-' &&
d89 1
a89 1
	    CTRACE((tfp, "HTTelnet: No host specified!\n"));
d94 1
a94 1
	    CTRACE((tfp, "HTTelnet: Invalid hostname %s!\n", host));
d152 1
a152 1
#if	!defined(TELNET_DONE) && (defined(NeXT) && defined(NeXTSTEP) && NeXTSTEP<=20100)
d155 7
a161 8
	if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	    HTAddParam(&command, FMT_TELNET, 1, program);
	    HTOptParam(&command, FMT_TELNET, 2, user ? " -l " : "");
	    HTAddParam(&command, FMT_TELNET, 3, user);
	    HTAddParam(&command, FMT_TELNET, 4, hostname);
	    HTAddParam(&command, FMT_TELNET, 5, port);
	    HTEndParam(&command, FMT_TELNET, 5);
	}
d163 1
d167 3
a169 2
/* Most unix machines support username only with rlogin */
#if !defined(TELNET_DONE) && (defined(UNIX) || defined(DOSPATH) || defined(__CYGWIN__))
d175 14
a188 10
	switch (login_protocol) {
	case rlogin:
	    if ((program = HTGetProgramPath(ppRLOGIN)) != NULL) {
		HTAddParam(&command, FMT_RLOGIN, 1, program);
		HTAddParam(&command, FMT_RLOGIN, 2, hostname);
		HTOptParam(&command, FMT_RLOGIN, 3, user ? " -l " : "");
		HTAddParam(&command, FMT_RLOGIN, 4, user);
		HTEndParam(&command, FMT_RLOGIN, 4);
	    }
	    break;
d190 1
a190 8
	case tn3270:
	    if ((program = HTGetProgramPath(ppTN3270)) != NULL) {
		HTAddParam(&command, FMT_TN3270, 1, program);
		HTAddParam(&command, FMT_TN3270, 2, hostname);
		HTAddParam(&command, FMT_TN3270, 3, port);
		HTEndParam(&command, FMT_TN3270, 3);
	    }
	    break;
d192 4
a195 8
	case telnet:
	    if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
		HTAddParam(&command, FMT_TELNET, 1, program);
		HTAddParam(&command, FMT_TELNET, 2, hostname);
		HTAddParam(&command, FMT_TELNET, 3, port);
		HTEndParam(&command, FMT_TELNET, 3);
	    }
	    break;
d198 10
a207 1
        LYSystem(command);
d209 1
d213 1
a213 1
#if !defined(TELNET_DONE) && (defined(MULTINET))
d217 1
a217 1
		NonNull(user),
d220 1
a220 1
		NonNull(port),
d226 1
a226 1
		NonNull(port),
d232 1
a232 1
		NonNull(port),
d237 1
d241 3
a243 11
#if !defined(TELNET_DONE) && defined(WIN_TCP)
	if ((cp=getenv("WINTCP_COMMAND_STYLE")) != NULL &&
	    0==strncasecomp(cp, "VMS", 3)) { /* VMS command syntax */
	    if (login_protocol == rlogin) {
		HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",  /*lm 930713 */
		    user ? "/USERNAME=\"" : "",
		    NonNull(user),
		    user ? "\"" : "",
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);
d245 43
a287 11
	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);

	    } else {  /* TELNET */
		HTSprintf0(&command, "TELNET %s%s %s",
		    port ? "/PORT=" : "",
		    NonNull(port),
		    hostname);
d290 2
a291 19
	} else { /* UNIX command syntax */
	   if (login_protocol == rlogin) {
	       HTSprintf0(&command, "RLOGIN %s%s%s%s%s",
		   hostname,
		   user ? " -l " : "",
		   user ? "\"" : "",
		   NonNull(user),
		   user ? "\"" : "");

	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TN3270 %s %s",
		    hostname,
		    NonNull(port));

	    } else {  /* TELNET */
		HTSprintf0(&command, "TELNET %s %s",
		    hostname,
		    NonNull(port));
	    }
a292 2

	do_system(command);
d296 1
a296 1
#if !defined(TELNET_DONE) && defined(UCX)
d300 1
a300 1
		NonNull(user),
d303 1
a303 1
		NonNull(port));
d308 1
a308 1
		NonNull(port));
d313 1
a313 1
		NonNull(port));
d317 1
d321 1
a321 1
#if !defined(TELNET_DONE) && defined(CMU_TCP)
d325 1
a325 1
		NonNull(port),
d330 2
d339 1
d343 4
a346 1
#if !defined(TELNET_DONE) && defined(SOCKETSHR_TCP)
d351 1
a351 1
		NonNull(user),
d353 1
a353 1
		NonNull(port),
d359 1
a359 1
		NonNull(port),
d365 1
a365 1
		NonNull(port),
d377 1
a377 1
		    NonNull(user),
d379 1
a379 1
		    NonNull(port),
d384 1
a384 1
		    NonNull(port),
d389 1
a389 1
		    NonNull(port),
d397 1
a397 1
		    NonNull(user));
d401 1
a401 1
		    NonNull(port));
d405 1
a405 1
		    NonNull(port));
d412 1
a412 2
    else if (getenv("UCX$DEVICE") != NULL
          || getenv("TCPIP$DEVICE") != NULL) {
d416 1
a416 1
		NonNull(user),
d418 1
a418 1
		NonNull(port));
d423 1
a423 1
		NonNull(port));
d428 1
a428 1
		NonNull(port));
d438 1
a438 1
		NonNull(port),
d443 2
d452 1
d458 1
a458 1
		NonNull(port),
d463 2
d472 1
d474 1
d478 4
a481 1
#if !defined(TELNET_DONE) && (defined(SIMPLE_TELNET) || defined(VM))
a487 1
#define TELNET_DONE
d506 4
a509 1
	    HadVMSInterrupt = FALSE;
d512 1
a513 1
	return HT_NO_DATA;
d544 1
a544 1
	CTRACE((tfp, "HTTelnet: Can't output a live session -- must be interactive!\n"));
d547 1
a547 1
    acc_method =  HTParse(addr, STR_FILE_URL, PARSE_ACCESS);
d552 1
a552 1
	CTRACE((tfp, "HTTelnet: No host specified!\n"));
@


1.1.3.2
log
@A three-days old development version of Lynx, the best web browser ever,
which follows the OpenBSD paradigma to only provide high-quality, func-
tional snapshots.
@
text
@d38 1
a38 1
static void do_system (char *  command)
d50 1
a50 1
static int remote_session (char *  acc_method, char *  host)
d52 1
a52 1
    const char *program;
d507 2
a508 1
static int HTLoadTelnet
d510 4
a513 4
 const char *		addr,
 HTParentAnchor *	anchor GCC_UNUSED,
 HTFormat		format_out GCC_UNUSED,
 HTStream *		sink			/* Ignored */
d548 3
a550 3
GLOBALDEF HTProtocol HTTelnet = { "telnet", HTLoadTelnet, NULL };
GLOBALDEF HTProtocol HTRlogin = { "rlogin", HTLoadTelnet, NULL };
GLOBALDEF HTProtocol HTTn3270 = { "tn3270", HTLoadTelnet, NULL };
@


1.1.3.3
log
@Lynx 2.8.6dev.5 fresh from the ISC
@
text
@d2 13
a14 13
 *		==========================
 *
 * Authors
 *	TBL	Tim Berners-Lee timbl@@info.cern.ch
 *	JFG	Jean-Francois Groff jgh@@next.com
 *	DD	Denis DeLaRoca (310) 825-4580  <CSP1DWD@@mvs.oac.ucla.edu>
 * History
 *	 8 Jun 92 Telnet hopping prohibited as telnet is not secure (TBL)
 *	26 Jun 92 When over DECnet, suppressed FTP, Gopher and News. (JFG)
 *	 6 Oct 92 Moved HTClientHost and logfile into here. (TBL)
 *	17 Dec 92 Tn3270 added, bug fix. (DD)
 *	 2 Feb 93 Split from HTAccess.c.  Registration.(TBL)
 */
d38 1
a38 1
static void do_system(char *command)
d48 3
a50 3
 *	-------------------------
 */
static int remote_session(char *acc_method, char *host)
d53 25
a77 28
    char *user = host;
    char *password = NULL;
    char *cp;
    char *hostname;
    char *port;
    char *command = NULL;
    enum _login_protocol {
	telnet,
	rlogin,
	tn3270
    } login_protocol =
      strcmp(acc_method, "rlogin") == 0 ? rlogin :
      strcmp(acc_method, "tn3270") == 0 ? tn3270 : telnet;

    /*
     * Modified to allow for odd chars in a username only if exists.
     * 05-28-94 Lynx 2-3-1 Garrett Arch Blythe
     */
    /* prevent telnet://hostname;rm -rf *  URL's (VERY BAD)
     *  *cp=0;        // terminate at any ;,<,>,`,|,",' or space or return
     * or tab to prevent security whole
     */
    for (cp = (strchr(host, '@@') ? strchr(host, '@@') : host); *cp != '\0';
	 cp++) {
	if (!isalnum(UCH(*cp)) && *cp != '_' && *cp != '-' &&
	    *cp != ':' && *cp != '.' && *cp != '@@') {
	    *cp = '\0';
	    break;
a78 1
    }
d80 1
a80 1
    hostname = strchr(host, '@@');
d82 6
a87 6
    if (hostname) {
	*hostname++ = '\0';	/* Split */
    } else {
	hostname = host;
	user = NULL;		/* No user specified */
    }
d89 3
a91 3
    port = strchr(hostname, ':');
    if (port)
	*port++ = '\0';		/* Split */
d93 22
a114 22
    if (!hostname || *hostname == '\0') {
	CTRACE((tfp, "HTTelnet: No host specified!\n"));
	return HT_NO_DATA;
    } else if (!valid_hostname(hostname)) {
	char *prefix = NULL;
	char *line = NULL;

	CTRACE((tfp, "HTTelnet: Invalid hostname %s!\n", host));
	HTSprintf0(&prefix,
		   gettext("remote %s session:"), acc_method);
	HTSprintf0(&line,
		   gettext("Invalid hostname %s"), host);
	HTAlwaysAlert(prefix, line);
	FREE(prefix);
	FREE(line);
	return HT_NO_DATA;
    }

    if (user) {
	password = strchr(user, ':');
	if (password) {
	    *password++ = '\0';
a115 1
    }
d117 2
a118 2
    /* If the person is already telnetting etc, forbid hopping */
    /* This is a security precaution, for us and remote site */
d120 1
a120 1
    if (HTSecure) {
d123 4
a126 4
	HTSprintf0(&command,
		   "finger @@%s | mail -s \"**telnethopper %s\" tbl@@dxcern.cern.ch",
		   HTClientHost, HTClientHost);
	do_system(command);
d128 15
a142 18
	printf("\n\nSorry, but the service you have selected is one\n");
	printf("to which you have to log in.  If you were running www\n");
	printf("on your own computer, you would be automatically connected.\n");
	printf("For security reasons, this is not allowed when\n");
	printf("you log in to this information service remotely.\n\n");

	printf("You can manually connect to this service using %s\n",
	       acc_method);
	printf("to host %s", hostname);
	if (user)
	    printf(", user name %s", user);
	if (password)
	    printf(", password %s", password);
	if (port)
	    printf(", port %s", port);
	printf(".\n\n");
	return HT_NO_DATA;
    }
d144 8
a151 8
    /* Not all telnet servers get it even if user name is specified so we
     * always tell the guy what to log in as.
     */
    if (user && login_protocol != rlogin)
	printf("When you are connected, log in as:  %s\n", user);
    if (password && login_protocol != rlogin)
	printf("                  The password is:  %s\n", password);
    fflush(stdout);
d160 9
a168 9
    if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	HTAddParam(&command, FMT_TELNET, 1, program);
	HTOptParam(&command, FMT_TELNET, 2, user ? " -l " : "");
	HTAddParam(&command, FMT_TELNET, 3, user);
	HTAddParam(&command, FMT_TELNET, 4, hostname);
	HTAddParam(&command, FMT_TELNET, 5, port);
	HTEndParam(&command, FMT_TELNET, 5);
    }
    do_system(command);
d179 19
a197 19
    switch (login_protocol) {
    case rlogin:
	if ((program = HTGetProgramPath(ppRLOGIN)) != NULL) {
	    HTAddParam(&command, FMT_RLOGIN, 1, program);
	    HTAddParam(&command, FMT_RLOGIN, 2, hostname);
	    HTOptParam(&command, FMT_RLOGIN, 3, user ? " -l " : "");
	    HTAddParam(&command, FMT_RLOGIN, 4, user);
	    HTEndParam(&command, FMT_RLOGIN, 4);
	}
	break;

    case tn3270:
	if ((program = HTGetProgramPath(ppTN3270)) != NULL) {
	    HTAddParam(&command, FMT_TN3270, 1, program);
	    HTAddParam(&command, FMT_TN3270, 2, hostname);
	    HTAddParam(&command, FMT_TN3270, 3, port);
	    HTEndParam(&command, FMT_TN3270, 3);
	}
	break;
d199 8
a206 6
    case telnet:
	if ((program = HTGetProgramPath(ppTELNET)) != NULL) {
	    HTAddParam(&command, FMT_TELNET, 1, program);
	    HTAddParam(&command, FMT_TELNET, 2, hostname);
	    HTAddParam(&command, FMT_TELNET, 3, port);
	    HTEndParam(&command, FMT_TELNET, 3);
a207 2
	break;
    }
d209 1
a209 1
    LYSystem(command);
d215 21
a235 21
    if (login_protocol == rlogin) {
	HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",	/*lm 930713 */
		   user ? "/USERNAME=\"" : "",
		   NonNull(user),
		   user ? "\"" : "",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);

    } else if (login_protocol == tn3270) {
	HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);

    } else {			/* TELNET */
	HTSprintf0(&command, "TELNET %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);
    }
d237 1
a237 1
    do_system(command);
d242 10
a251 10
    if ((cp = getenv("WINTCP_COMMAND_STYLE")) != NULL &&
	0 == strncasecomp(cp, "VMS", 3)) {	/* VMS command syntax */
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",		/*lm 930713 */
		       user ? "/USERNAME=\"" : "",
		       NonNull(user),
		       user ? "\"" : "",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d253 5
a257 5
	} else if (login_protocol == tn3270) {
	    HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d259 6
a264 6
	} else {		/* TELNET */
	    HTSprintf0(&command, "TELNET %s%s %s",
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
	}
d266 8
a273 8
    } else {			/* UNIX command syntax */
	if (login_protocol == rlogin) {
	    HTSprintf0(&command, "RLOGIN %s%s%s%s%s",
		       hostname,
		       user ? " -l " : "",
		       user ? "\"" : "",
		       NonNull(user),
		       user ? "\"" : "");
d275 4
a278 4
	} else if (login_protocol == tn3270) {
	    HTSprintf0(&command, "TN3270 %s %s",
		       hostname,
		       NonNull(port));
d280 5
a284 4
	} else {		/* TELNET */
	    HTSprintf0(&command, "TELNET %s %s",
		       hostname,
		       NonNull(port));
a285 1
    }
d287 1
a287 1
    do_system(command);
d292 7
a298 7
    if (login_protocol == rlogin) {
	HTSprintf0(&command, "RLOGIN%s%s%s %s %s",
		   user ? "/USERNAME=\"" : "",
		   NonNull(user),
		   user ? "\"" : "",
		   hostname,
		   NonNull(port));
d300 4
a303 4
    } else if (login_protocol == tn3270) {
	HTSprintf0(&command, "TN3270 %s %s",
		   hostname,
		   NonNull(port));
d305 5
a309 5
    } else {			/* TELNET */
	HTSprintf0(&command, "TELNET %s %s",
		   hostname,
		   NonNull(port));
    }
d311 1
a311 1
    do_system(command);
d316 15
a330 13
    if (login_protocol == telnet) {
	HTSprintf0(&command, "TELNET %s%s %s",
		   port ? "/PORT=" : "",
		   NonNull(port),
		   hostname);
	do_system(command);
    } else {
	printf("\nSorry, this browser was compiled without the %s access option.\n",
	       acc_method);
	printf("\nPress <return> to return to Lynx.");
	LYgetch();
	HadVMSInterrupt = FALSE;
    }
d337 6
a342 6
	    HTSprintf0(&command, "MULTINET RLOGIN%s%s%s%s %s",	/*lm 930713 */
		       user ? "/USERNAME=" : "",
		       NonNull(user),
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d346 3
a348 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d350 1
a350 1
	} else {		/* TELNET */
d352 3
a354 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d358 4
a361 3
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if ((cp = getenv("WINTCP_COMMAND_STYLE")) != NULL) {
	if (0 == strncasecomp(cp, "VMS", 3)) {	/* VMS command syntax */
d363 6
a368 6
		HTSprintf0(&command, "RLOGIN%s%s%s%s %s",	/*lm 930713 */
			   user ? "/USERNAME=" : "",
			   NonNull(user),
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
d371 4
a374 4
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
	    } else {		/* TELNET */
d376 3
a378 3
			   port ? "/PORT=" : "",
			   NonNull(port),
			   hostname);
d380 1
a380 1
	} else {		/* UNIX command syntax */
d383 3
a385 3
			   hostname,
			   user ? " -l " : "",
			   NonNull(user));
d388 3
a390 3
			   hostname,
			   NonNull(port));
	    } else {		/* TELNET */
d392 2
a393 2
			   hostname,
			   NonNull(port));
d398 4
a401 3
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if (getenv("UCX$DEVICE") != NULL
	       || getenv("TCPIP$DEVICE") != NULL) {
d404 4
a407 4
		       user ? "/USERNAME=" : "",
		       NonNull(user),
		       hostname,
		       NonNull(port));
d411 2
a412 2
		       hostname,
		       NonNull(port));
d414 1
a414 1
	} else {		/* TELNET */
d416 2
a417 2
		       hostname,
		       NonNull(port));
d421 3
a423 2
	return HT_NO_DATA;	/* Ok - it was done but no data */
    } else if (getenv("CMUTEK_ROOT") != NULL) {
d426 3
a428 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d430 5
a434 3
	} else {
	    printf("\nSorry, this browser was compiled without the %s access option.\n",
		   acc_method);
d439 2
a440 1
    } else {
d443 3
a445 3
		       port ? "/PORT=" : "",
		       NonNull(port),
		       hostname);
d447 5
a451 3
	} else {
	    printf("\nSorry, this browser was compiled without the %s access option.\n",
		   acc_method);
d461 6
a466 6
    if (login_protocol == telnet) {	/* telnet only */
	HTSprintf0(&command, "TELNET  %s",	/* @@@@ Bug: port ignored */
		   hostname);
	do_system(command);
	return HT_NO_DATA;	/* Ok - it was done but no data */
    }
d471 14
a484 12
    printf("\nSorry, this browser was compiled without the %s access option.\n",
	   acc_method);
    printf("\nTo access the information you must %s to %s", acc_method, hostname);
    if (port)
	printf(" (port %s)", port);
    if (user)
	printf("\nlogging in with username %s", user);
    printf(".\n");
    {
	printf("\nPress <return> to return to Lynx.");
	fflush(stdout);
	LYgetch();
d486 1
a486 1
	HadVMSInterrupt = FALSE;
d488 1
a488 1
    }
d490 1
a490 1
    return HT_NO_DATA;
d494 20
a513 17
 *	------------------------------------------
 *
 * On entry,
 *	addr		must point to the fully qualified hypertext reference.
 *
 * On exit,
 *	returns		<0	Error has occured.
 *			>=0	Value of file descriptor or socket to be used
 *				 to read data.
 *	*pFormat	Set to the format of the file, if known.
 *			(See WWW.h)
 *
 */
static int HTLoadTelnet(const char *addr,
			HTParentAnchor *anchor GCC_UNUSED,
			HTFormat format_out GCC_UNUSED,
			HTStream *sink)		/* Ignored */
d515 2
a516 2
    char *acc_method;
    char *host;
d520 1
a520 2
	CTRACE((tfp,
		"HTTelnet: Can't output a live session -- must be interactive!\n"));
d523 1
a523 1
    acc_method = HTParse(addr, STR_FILE_URL, PARSE_ACCESS);
d538 1
d543 3
a545 3
GLOBALDEF(HTProtocol, HTTelnet, _HTTELNET_C_1_INIT);
GLOBALDEF(HTProtocol, HTRlogin, _HTTELNET_C_2_INIT);
GLOBALDEF(HTProtocol, HTTn3270, _HTTELNET_C_3_INIT);
d547 3
a549 6
GLOBALDEF HTProtocol HTTelnet =
{"telnet", HTLoadTelnet, NULL};
GLOBALDEF HTProtocol HTRlogin =
{"rlogin", HTLoadTelnet, NULL};
GLOBALDEF HTProtocol HTTn3270 =
{"tn3270", HTLoadTelnet, NULL};
@


1.1.1.1
log
@Import OpenBSD 3.3 source repository from CTM 3132 the first time
This opens an OpenBSD-mirabile (aka MirBSD) repository.

### MirBSD is:
# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
# Copyright  1968-2003  The authors of And contributors to UNIX, the
#       C Language, BSD/Berkeley Unix; 386BSD, NetBSD 1.1 and OpenBSD.
#
# Anyone who obtained a copy of this work is hereby permitted to freely use,
# distribute, modify, merge, sublicence, give away or sell it as long as the
# authors are given due credit and the following notice is retained:
#
# This work is provided "as is", with no explicit or implicit warranty what-
# soever. Use it only at your own risk. In no event may an author or contri-
# butor be held liable for any damage, directly or indirectly, that origina-
# ted through or is caused by creation or modification of this work.

MirBSD is my private tree. MirBSD does not differ very much from OpenBSD
and intentionally tracks OpenBSD. That's why it _is_ OpenBSD, just not the
official one. It's like with DarrenBSD.

At time of this writing, no advertising for MirBSD must be done,
because the advertising clause has not yet been sorted out.

http://templeofhate.com/tglaser/MirBSD/index.php
@
text
@@


1.1.1.2
log
@Import OpenBSD source tree of short before 17:00 UTC today
@
text
@d39 1
a39 4
    CTRACE((tfp, "HTTelnet: Command is: %s\n\n", command));
#ifdef UNIX	/* want LYSystem's signal sanitizing - kw */
    LYSystem(command);
#else		/* Non-UNIX should use LYSystem too? - left for now - kw */
a40 1
#endif
d68 1
a68 1
	    if(!isalnum(UCH(*cp)) && *cp != '_' && *cp != '-' &&
d89 1
a89 1
	    CTRACE((tfp, "HTTelnet: No host specified!\n"));
d94 1
a94 1
	    CTRACE((tfp, "HTTelnet: Invalid hostname %s!\n", host));
d152 1
a152 1
#if	!defined(TELNET_DONE) && (defined(NeXT) && defined(NeXTSTEP) && NeXTSTEP<=20100)
d163 1
d167 3
a169 2
/* Most unix machines support username only with rlogin */
#if !defined(TELNET_DONE) && (defined(UNIX) || defined(DOSPATH) || defined(__CYGWIN__))
a198 3
#ifdef WATT32
	_eth_release();
#endif /* WATT32 */
a205 3
#ifdef WATT32
       _eth_init();
#endif /* WATT32 */
d207 1
a207 1

d209 1
d213 1
a213 1
#if !defined(TELNET_DONE) && (defined(MULTINET))
d237 1
d241 3
a243 11
#if !defined(TELNET_DONE) && defined(WIN_TCP)
	if ((cp=getenv("WINTCP_COMMAND_STYLE")) != NULL &&
	    0==strncasecomp(cp, "VMS", 3)) { /* VMS command syntax */
	    if (login_protocol == rlogin) {
		HTSprintf0(&command, "RLOGIN%s%s%s%s%s %s",  /*lm 930713 */
		    user ? "/USERNAME=\"" : "",
		    user ? user : "",
		    user ? "\"" : "",
		    port ? "/PORT=" : "",
		    port ? port : "",
		    hostname);
d245 43
a287 11
	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TELNET/TN3270 %s%s %s",
		    port ? "/PORT=" : "",
		    port ? port : "",
		    hostname);

	    } else {  /* TELNET */
		HTSprintf0(&command, "TELNET %s%s %s",
		    port ? "/PORT=" : "",
		    port ? port : "",
		    hostname);
d290 2
a291 19
	} else { /* UNIX command syntax */
	   if (login_protocol == rlogin) {
	       HTSprintf0(&command, "RLOGIN %s%s%s%s%s",
		   hostname,
		   user ? " -l " : "",
		   user ? "\"" : "",
		   user ? user : "",
		   user ? "\"" : "");

	    } else if (login_protocol == tn3270) {
		HTSprintf0(&command, "TN3270 %s %s",
		    hostname,
		    port ? port : "");

	    } else {  /* TELNET */
		HTSprintf0(&command, "TELNET %s %s",
		    hostname,
		    port ? port : "");
	    }
a292 2

	do_system(command);
d296 1
a296 1
#if !defined(TELNET_DONE) && defined(UCX)
d317 1
d321 1
a321 1
#if !defined(TELNET_DONE) && defined(CMU_TCP)
d339 1
d343 4
a346 1
#if !defined(TELNET_DONE) && defined(SOCKETSHR_TCP)
d412 1
a412 2
    else if (getenv("UCX$DEVICE") != NULL
          || getenv("TCPIP$DEVICE") != NULL) {
d452 1
d472 1
d474 1
d478 4
a481 1
#if !defined(TELNET_DONE) && (defined(SIMPLE_TELNET) || defined(VM))
a487 1
#define TELNET_DONE
d512 1
a513 1
	return HT_NO_DATA;
d544 1
a544 1
	CTRACE((tfp, "HTTelnet: Can't output a live session -- must be interactive!\n"));
d552 1
a552 1
	CTRACE((tfp, "HTTelnet: No host specified!\n"));
@

