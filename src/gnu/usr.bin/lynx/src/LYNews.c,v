head	1.6;
access;
symbols
	lynx-2_8_6dev10:1.1.2.1
	FSF:1.1.2
	tg-mergetmp-mirosx-1:1.6
	tg-mergefixes-1-branch:1.6.0.4
	tg-mergefixes-1-base:1.6
	MIROS_X:1.6.0.2
	MIROS_X_BASE:1.6
	MIRBSD_XP_MIRPPC:1.5.0.4
	lynx-2_8_6dev_7b:1.1.3.4
	lynx-2_8_6dev_6:1.1.3.3
	MIRBSD_XP_SPARC_BASE:1.5
	MIRBSD_XP_SPARC:1.5.0.2
	lynx-2_8_6dev_5-iz2:1.1.3.3
	lynx-2_8_6dev_5:1.1.3.3
	cvs-200406091940:1.1.1.2
	MIRBSD_7quater:1.3
	cvs-200405160640:1.1.1.2
	lynx-2_8_6dev2:1.1.3.2
	lynx-2_8_5:1.1.3.1
	cvs-200401271800:1.1.1.2
	cvs-200401261630:1.1.1.2
	lynx_2-8-5_dev17d:1.1.3.1
	cvs-200401021645:1.1.1.2
	MIRBSD_7_ALPHA:1.3.0.6
	MIRBSD_7:1.3.0.4
	cvs-200312222040:1.1.1.2
	MIRBSD_7ter:1.3
	MIRBSD_7_DEV:1.3.0.2
	cvs-200310020700:1.1.1.2
	lynx_2-8-5_dev16c:1.1.3.1
	cvs-200309271030:1.1.1.2
	cvs-200309251530:1.1.1.2
	lynx_2-8-5_dev16:1.1.3.1
	tg:1.1.3
	cvs-200308302005:1.1.1.2
	cvs-200308171200:1.1.1.2
	ctm-3496:1.1.1.2
	ctm-3449:1.1.1.2
	ctm-3437:1.1.1.2
	cvs-200307191805:1.1.1.2
	ctm-3425:1.1.1.2
	cvs-200307091500:1.1.1.2
	VENDOR_LYNX_285dev16:1.3
	ctm-3389:1.1.1.2
	cvs-200306291430:1.1.1.2
	ctm-3341:1.1.1.2
	MIRBSD_5:1.1.1.2
	cvs-200306082100:1.1.1.2
	ctm-3316:1.1.1.2
	ctm-3272:1.1.1.2
	ctm-3264:1.1.1.2
	cvs-200305071630:1.1.1.2
	MIRBSD_4:1.1.1.1
	ctm-3203:1.1.1.1
	cvs-20030410-1130:1.1.1.1
	ctm-3155:1.1.1.1
	ctm-3132:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@ * @;


1.6
date	2004.10.20.10.26.30;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2004.07.15.18.17.00;	author tg;	state Stab;
branches;
next	1.4;

1.4
date	2004.04.30.16.32.36;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2003.07.07.18.58.37;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2003.07.07.18.49.33;	author tg;	state dead;
branches;
next	1.1;

1.1
date	2003.03.22.17.42.19;	author tg;	state Exp;
branches
	1.1.1.1
	1.1.2.1
	1.1.3.1;
next	;

1.1.1.1
date	2003.03.22.17.42.19;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2003.05.07.17.30.26;	author tg;	state Exp;
branches;
next	;

1.1.2.1
date	2005.01.03.00.31.17;	author tg;	state Exp;
branches;
next	;

1.1.3.1
date	2003.09.17.14.20.18;	author tg;	state Exp;
branches;
next	1.1.3.2;

1.1.3.2
date	2004.04.30.16.15.56;	author tg;	state Exp;
branches;
next	1.1.3.3;

1.1.3.3
date	2004.07.15.15.52.16;	author tg;	state Exp;
branches;
next	1.1.3.4;

1.1.3.4
date	2004.10.20.10.10.44;	author tg;	state Exp;
branches;
next	;


desc
@@


1.6
log
@automatic merge
@
text
@#include <HTUtils.h>
#ifndef DISABLE_NEWS
#include <HTParse.h>
#include <HTAccess.h>
#include <HTCJK.h>
#include <HTAlert.h>
#include <LYCurses.h>
#include <LYSignal.h>
#include <LYStructs.h>
#include <LYUtils.h>
#include <LYClean.h>
#include <LYStrings.h>
#include <LYHistory.h>
#include <GridText.h>
#include <LYCharSets.h>
#include <LYNews.h>
#include <LYEdit.h>

#include <LYGlobalDefs.h>

#include <LYLeaks.h>

/*
 *  Global variable for async i/o.
 */
BOOLEAN term_message = FALSE;
static void terminate_message(int sig);

static BOOLEAN message_has_content(const char *filename,
				   BOOLEAN *nonspaces)
{
    FILE *fp;
    char *buffer = NULL;
    BOOLEAN in_headers = TRUE;

    *nonspaces = FALSE;

    if (!filename || (fp = fopen(filename, "r")) == NULL) {
	CTRACE((tfp, "Failed to open file %s for reading!\n",
		NONNULL(filename)));
	return FALSE;
    }
    while (LYSafeGets(&buffer, fp) != NULL) {
	char *cp = buffer;
	char firstnonblank = '\0';

	LYTrimNewline(cp);
	for (; *cp; cp++) {
	    if (!firstnonblank && isgraph(UCH(*cp))) {
		firstnonblank = *cp;
	    } else if (!isspace(UCH(*cp))) {
		*nonspaces = TRUE;
	    }
	}
	if (firstnonblank && firstnonblank != '>') {
	    if (!in_headers) {
		LYCloseInput(fp);
		FREE(buffer);
		return TRUE;
	    }
	}
	if (!firstnonblank) {
	    in_headers = FALSE;
	}
    }
    FREE(buffer);
    LYCloseInput(fp);
    return FALSE;
}

/*
 *  This function is called from HTLoadNews() to have the user
 *  create a file with news headers and a body for posting of
 *  a new message (based on a newspost://nntp_host/newsgroups
 *  or snewspost://secure_nntp_host/newsgroups URL), or to post
 *  a followup (based on a newsreply://nntp_host/newsgroups or
 *  snewsreply://secure_nntp_host/newsgroups URL). The group
 *  or comma-separated list of newsgroups is passed without
 *  a lead slash, and followup is TRUE for newsreply or
 *  snewsreply URLs.  - FM
 */
char *LYNewsPost(char *newsgroups,
		 BOOLEAN followup)
{
    char user_input[1024];
    char CJKinput[1024];
    char *cp = NULL;
    const char *kp = NULL;
    int c = 0;			/* user input */
    int len;
    FILE *fd = NULL;
    char my_tempfile[LY_MAXPATH];
    FILE *fc = NULL;
    char CJKfile[LY_MAXPATH];
    char *postfile = NULL;
    char *NewsGroups = NULL;
    char *References = NULL;
    char *org = NULL;
    FILE *fp = NULL;
    BOOLEAN nonempty = FALSE;
    BOOLEAN nonspaces = FALSE;

    /*
     * Make sure a non-zero length newspost, newsreply, snewspost or snewsreply
     * path was sent to us.  - FM
     */
    if (isEmpty(newsgroups))
	return (postfile);

    /*
     * Return immediately if we do get called, maybe by some quirk of HTNews.c,
     * when we shouldn't.  - kw
     */
    if (no_newspost)
	return (postfile);

    /*
     * Open a temporary file for the headers and message body.  - FM
     */
#ifdef __DJGPP__
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, BIN_W)) == NULL)
#else
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, "w")) == NULL)
#endif /* __DJGPP__ */
    {
	HTAlert(CANNOT_OPEN_TEMP);
	return (postfile);
    }

    /*
     * If we're using a Japanese display character set, open a temporary file
     * for a conversion to JIS.  - FM
     */
    CJKfile[0] = '\0';
    if (current_char_set == UCGetLYhndl_byMIME("euc-jp") ||
	current_char_set == UCGetLYhndl_byMIME("shift_jis")) {
	if ((fc = LYOpenTemp(CJKfile, HTML_SUFFIX, "w")) == NULL) {
	    HTAlert(CANNOT_OPEN_TEMP);
	    LYRemoveTemp(my_tempfile);
	    return (postfile);
	}
    }

    /*
     * The newsgroups could be a comma-seperated list.  It need not have
     * spaces, but deal with any that may also have been hex escaped.  - FM
     */
    StrAllocCopy(NewsGroups, newsgroups);
    if ((cp = strstr(NewsGroups, ";ref="))) {
	*cp = '\0';
	cp += 5;
	if (*cp == '<') {
	    StrAllocCopy(References, cp);
	} else {
	    StrAllocCopy(References, "<");
	    StrAllocCat(References, cp);
	    StrAllocCat(References, ">");
	}
	HTUnEscape(References);
	if (!((cp = strchr(References, '@@')) && cp > References + 1 &&
	      isalnum(UCH(cp[1])))) {
	    FREE(References);
	}
    }
    HTUnEscape(NewsGroups);
    if (!*NewsGroups) {
	LYCloseTempFP(fd);	/* Close the temp file. */
	goto cleanup;
    }

    /*
     * Allow ^C to cancel the posting, i.e., don't let SIGINTs exit Lynx.
     */
    signal(SIGINT, terminate_message);
    term_message = FALSE;

    /*
     * Show the list of newsgroups.  - FM
     */
    LYclear();
    LYmove(2, 0);
    scrollok(LYwin, TRUE);	/* Enable scrolling. */
    LYaddstr(gettext("You will be posting to:"));
    LYaddstr("\n\t");
    LYaddstr(NewsGroups);
    LYaddch('\n');

    /*
     * Get the mail address for the From header, offering personal_mail_address
     * as default.
     */
    LYaddstr(gettext("\n\n Please provide your mail address for the From: header\n"));
    sprintf(user_input, "From: %.*s", (int) sizeof(user_input) - 8,
	    NonNull(personal_mail_address));
    if (LYgetstr(user_input, VISIBLE,
		 sizeof(user_input), NORECALL) < 0 ||
	term_message) {
	HTInfoMsg(NEWS_POST_CANCELLED);
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
	goto cleanup;
    }
    fprintf(fd, "%s\n", user_input);

    /*
     * Get the Subject header, offering the current document's title as the
     * default if this is a followup rather than a new post.  - FM
     */
    LYaddstr(gettext("\n\n Please provide or edit the Subject: header\n"));
    strcpy(user_input, "Subject: ");
    if ((followup == TRUE && nhist > 0) &&
	(kp = HText_getTitle()) != NULL) {
	/*
	 * Add the default subject.
	 */
	kp = LYSkipCBlanks(kp);
#ifdef CJK_EX			/* 1998/05/15 (Fri) 09:10:38 */
	if (HTCJK == JAPANESE) {
	    CJKinput[0] = '\0';
	    switch (kanji_code) {
	    case EUC:
		TO_EUC((const unsigned char *) kp, (unsigned char *) CJKinput);
		kp = CJKinput;
		break;
	    case SJIS:
		TO_SJIS((const unsigned char *) kp, (unsigned char *) CJKinput);
		kp = CJKinput;
		break;
	    default:
		break;
	    }
	}
#endif
	if (strncasecomp(kp, "Re:", 3)) {
	    strcat(user_input, "Re: ");
	}
	len = strlen(user_input);
	LYstrncpy(user_input + len, kp, sizeof(user_input) - len - 1);
    }
    cp = NULL;
    if (LYgetstr(user_input, VISIBLE,
		 sizeof(user_input), NORECALL) < 0 ||
	term_message) {
	HTInfoMsg(NEWS_POST_CANCELLED);
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
	goto cleanup;
    }
    fprintf(fd, "%s\n", user_input);

    /*
     * Add Organization:  header.
     */
    StrAllocCopy(cp, "Organization: ");
    if ((org = LYGetEnv("ORGANIZATION")) != NULL) {
	StrAllocCat(cp, org);
    } else if ((org = LYGetEnv("NEWS_ORGANIZATION")) != NULL) {
	StrAllocCat(cp, org);
    }
#ifdef UNIX
    else if ((fp = fopen("/etc/organization", TXT_R)) != NULL) {
	char *buffer = 0;

	if (LYSafeGets(&buffer, fp) != NULL) {
	    if (user_input[0] != '\0') {
		LYTrimNewline(buffer);
		StrAllocCat(cp, buffer);
	    }
	}
	FREE(buffer);
	LYCloseInput(fp);
    }
#else
#ifdef _WINDOWS			/* 1998/05/14 (Thu) 17:47:01 */
    else {
	char *p, fname[LY_MAXPATH];

	strcpy(fname, LynxSigFile);
	p = strrchr(fname, '/');
	if (p != 0 && (p - fname) < sizeof(fname) - 15) {
	    strcpy(p + 1, "LYNX_ETC.TXT");
	    if ((fp = fopen(fname, TXT_R)) != NULL) {
		if (fgets(user_input, sizeof(user_input), fp) != NULL) {
		    if ((org = strchr(user_input, '\n')) != NULL) {
			*org = '\0';
		    }
		    if (user_input[0] != '\0') {
			StrAllocCat(cp, user_input);
		    }
		}
		LYCloseInput(fp);
	    }
	}
    }
#endif /* _WINDOWS */
#endif /* !UNIX */
    LYstrncpy(user_input, cp, (sizeof(user_input) - 16));
    FREE(cp);
    LYaddstr(gettext("\n\n Please provide or edit the Organization: header\n"));
    if (LYgetstr(user_input, VISIBLE,
		 sizeof(user_input), NORECALL) < 0 ||
	term_message) {
	HTInfoMsg(NEWS_POST_CANCELLED);
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
	goto cleanup;
    }
    fprintf(fd, "%s\n", user_input);

    if (References) {
	fprintf(fd, "References: %s\n", References);
    }
    /*
     * Add Newsgroups Summary and Keywords headers.
     */
    fprintf(fd, "Newsgroups: %s\nSummary: \nKeywords: \n\n", NewsGroups);

    /*
     * Have the user create the message body.
     */
    if (!no_editor && non_empty(editor)) {

	if (followup && nhist > 0) {
	    /*
	     * Ask if the user wants to include the original message.
	     */
	    if (term_message) {
		_statusline(INC_ORIG_MSG_PROMPT);
	    } else if (HTConfirm(INC_ORIG_MSG_PROMPT) == YES) {
		/*
		 * The 'TRUE' will add the reply ">" in front of every line. 
		 * We're assuming that if the display character set is Japanese
		 * and the document did not have a CJK charset, any non-EUC or
		 * non-SJIS 8-bit characters in it where converted to 7-bit
		 * equivalents.  - FM
		 */
		print_wwwfile_to_fd(fd, FALSE, TRUE);
	    }
	}
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
	if (term_message || LYCharIsINTERRUPT(c))
	    goto cleanup;

	/*
	 * Spawn the user's editor on the news file.
	 */
	edit_temporary_file(my_tempfile, "", SPAWNING_EDITOR_FOR_NEWS);

	nonempty = message_has_content(my_tempfile, &nonspaces);

    } else {
	/*
	 * Use the built in line editior.
	 */
	LYaddstr(gettext("\n\n Please enter your message below."));
	LYaddstr(gettext("\n When you are done, press enter and put a single period (.)"));
	LYaddstr(gettext("\n on a line and press enter again."));
	LYaddstr("\n\n");
	LYrefresh();
	*user_input = '\0';
	if (LYgetstr(user_input, VISIBLE,
		     sizeof(user_input), NORECALL) < 0 ||
	    term_message) {
	    HTInfoMsg(NEWS_POST_CANCELLED);
	    LYCloseTempFP(fd);	/* Close the temp file. */
	    scrollok(LYwin, FALSE);	/* Stop scrolling.      */
	    goto cleanup;
	}
	while (!STREQ(user_input, ".") && !term_message) {
	    LYaddch('\n');
	    fprintf(fd, "%s\n", user_input);
	    if (!nonempty && strlen(user_input))
		nonempty = TRUE;
	    *user_input = '\0';
	    if (LYgetstr(user_input, VISIBLE,
			 sizeof(user_input), NORECALL) < 0) {
		HTInfoMsg(NEWS_POST_CANCELLED);
		LYCloseTempFP(fd);	/* Close the temp file. */
		scrollok(LYwin, FALSE);		/* Stop scrolling.      */
		goto cleanup;
	    }
	}
	fprintf(fd, "\n");
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
    }

    if (nonempty) {
	/*
	 * Confirm whether to post, and if so, whether to append the sig file. 
	 * - FM
	 */
	LYStatusLine = (LYlines - 1);
	c = HTConfirm(POST_MSG_PROMPT);
	LYStatusLine = -1;
	if (c != YES) {
	    LYclear();		/* clear the screen */
	    goto cleanup;
	}
    } else {
	HTAlert(gettext("Message has no original text!"));
	if (!nonspaces
	    || HTConfirmDefault(POST_MSG_PROMPT, NO) != YES)
	    goto cleanup;
    }
    if ((LynxSigFile != NULL) && (fp = fopen(LynxSigFile, TXT_R)) != NULL) {
	char *msg = NULL;

	HTSprintf0(&msg, APPEND_SIG_FILE, LynxSigFile);

	LYStatusLine = (LYlines - 1);
	if (term_message) {
	    _user_message(APPEND_SIG_FILE, LynxSigFile);
	} else if (HTConfirm(msg) == YES) {
	    if ((fd = LYAppendToTxtFile(my_tempfile)) != NULL) {
		char *buffer = NULL;

		fputs("-- \n", fd);
		while (LYSafeGets(&buffer, fp) != NULL) {
		    fputs(buffer, fd);
		}
		LYCloseOutput(fd);
	    }
	}
	LYCloseInput(fp);
	FREE(msg);
	LYStatusLine = -1;
    }
    LYclear();			/* clear the screen */

    /*
     * If we are using a Japanese display character set, convert the contents
     * of the temp file to JIS (nothing should change if it does not, in fact,
     * contain EUC or SJIS di-bytes).  Otherwise, use the temp file as is.  -
     * FM
     */
    if (CJKfile[0] != '\0') {
	if ((fd = fopen(my_tempfile, TXT_R)) != NULL) {
	    char *buffer = NULL;

	    while (LYSafeGets(&buffer, fd) != NULL) {
		TO_JIS((unsigned char *) buffer,
		       (unsigned char *) CJKinput);
		fputs(CJKinput, fc);
	    }
	    LYCloseTempFP(fc);
	    StrAllocCopy(postfile, CJKfile);
	    LYCloseInput(fd);
	    LYRemoveTemp(my_tempfile);
	    strcpy(my_tempfile, CJKfile);
	    CJKfile[0] = '\0';
	} else {
	    StrAllocCopy(postfile, my_tempfile);
	}
    } else {
	StrAllocCopy(postfile, my_tempfile);
    }
    if (!followup) {
	/*
	 * If it's not a followup, the current document most likely is the
	 * group listing, so force a to have the article show up in the list
	 * after the posting.  Note, that if it's a followup via a link in a
	 * news article, the user must do a reload manually on returning to the
	 * group listing.  - FM
	 */
	LYforce_no_cache = TRUE;
    }
    LYStatusLine = (LYlines - 1);
    HTUserMsg(POSTING_TO_NEWS);
    LYStatusLine = -1;

    /*
     * Come here to cleanup and exit.
     */
  cleanup:
#ifndef VMS
    signal(SIGINT, cleanup_sig);
#endif /* !VMS */
    term_message = FALSE;
    if (!postfile)
	LYRemoveTemp(my_tempfile);
    LYRemoveTemp(CJKfile);
    FREE(NewsGroups);
    FREE(References);

    return (postfile);
}

static void terminate_message(int sig GCC_UNUSED)
{
    term_message = TRUE;
    /*
     * Reassert the AST.
     */
    signal(SIGINT, terminate_message);
#ifdef VMS
    /*
     * Refresh the screen to get rid of the "interrupt" message.
     */
    lynx_force_repaint();
    LYrefresh();
#endif /* VMS */
}

#endif /* not DISABLE_NEWS */
@


1.5
log
@automatic merge of lynx-current
@
text
@d107 1
a107 1
    if (!(newsgroups && *newsgroups))
d321 1
a321 1
    if (!no_editor && editor && *editor != '\0') {
@


1.4
log
@pretty much automatic merge of Lynx update
now, we live in an ANSI C world...
@
text
@d24 2
a25 2
**  Global variable for async i/o.
*/
d27 1
a27 1
static void terminate_message  (int sig);
d29 2
a30 3
static BOOLEAN message_has_content (
    const char *	filename,
    BOOLEAN *		nonspaces)
d40 1
a40 1
	       NONNULL(filename)));
d46 1
d72 12
a83 13
**  This function is called from HTLoadNews() to have the user
**  create a file with news headers and a body for posting of
**  a new message (based on a newspost://nntp_host/newsgroups
**  or snewspost://secure_nntp_host/newsgroups URL), or to post
**  a followup (based on a newsreply://nntp_host/newsgroups or
**  snewsreply://secure_nntp_host/newsgroups URL). The group
**  or comma-separated list of newsgroups is passed without
**  a lead slash, and followup is TRUE for newsreply or
**  snewsreply URLs.  - FM
*/
char *LYNewsPost (
	char *		newsgroups,
	BOOLEAN	followup)
d89 1
a89 1
    int c = 0;  /* user input */
d104 2
a105 2
     *  Make sure a non-zero length newspost, newsreply,
     *  snewspost or snewsreply path was sent to us. - FM
d108 1
a108 1
	return(postfile);
d111 2
a112 2
     *  Return immediately if we do get called, maybe by some quirk
     *  of HTNews.c, when we shouldn't. - kw
d115 1
a115 1
	return(postfile);
d118 1
a118 2
     *  Open a temporary file for the headers
     *  and message body. - FM
d127 1
a127 1
	return(postfile);
d131 2
a132 2
     *  If we're using a Japanese display character set,
     *  open a temporary file for a conversion to JIS. - FM
d140 1
a140 1
	    return(postfile);
d145 2
a146 3
     *  The newsgroups could be a comma-seperated list.
     *  It need not have spaces, but deal with any that
     *  may also have been hex escaped. - FM
d167 1
a167 1
	LYCloseTempFP(fd);		/* Close the temp file.	*/
d172 1
a172 2
     *  Allow ^C to cancel the posting,
     *  i.e., don't let SIGINTs exit Lynx.
d178 1
a178 1
     *  Show the list of newsgroups. - FM
d181 2
a182 2
    LYmove(2,0);
    scrollok(LYwin, TRUE);		/* Enable scrolling. */
d189 2
a190 2
     *  Get the mail address for the From header,
     *  offering personal_mail_address as default.
d193 1
a193 1
    sprintf(user_input, "From: %.*s", (int)sizeof(user_input) - 8,
d199 2
a200 2
	LYCloseTempFP(fd);		/* Close the temp file.	*/
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d206 2
a207 3
     *  Get the Subject header, offering the current
     *  document's title as the default if this is a
     *  followup rather than a new post. - FM
d214 1
a214 1
	 *  Add the default subject.
d217 1
a217 1
#ifdef CJK_EX	/* 1998/05/15 (Fri) 09:10:38 */
d220 1
a220 1
	    switch(kanji_code) {
d222 1
a222 1
		TO_EUC((const unsigned char *)kp, (unsigned char *)CJKinput);
d226 1
a226 1
		TO_SJIS((const unsigned char *)kp, (unsigned char *)CJKinput);
d245 2
a246 2
	LYCloseTempFP(fd);		/* Close the temp file. */
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d249 1
a249 1
    fprintf(fd,"%s\n",user_input);
d252 1
a252 1
     *  Add Organization: header.
d263 1
d274 1
a274 1
#ifdef _WINDOWS	/* 1998/05/14 (Thu) 17:47:01 */
d304 2
a305 2
	LYCloseTempFP(fd);		/* Close the temp file. */
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d314 1
a314 1
     *  Add Newsgroups Summary and Keywords headers.
d319 1
a319 1
     *  Have the user create the message body.
d325 1
a325 1
	     *  Ask if the user wants to include the original message.
d331 5
a335 5
		 *  The 'TRUE' will add the reply ">" in front of every line.
		 *  We're assuming that if the display character set is
		 *  Japanese and the document did not have a CJK charset,
		 *  any non-EUC or non-SJIS 8-bit characters in it where
		 *  converted to 7-bit equivalents. - FM
d340 2
a341 2
	LYCloseTempFP(fd);		/* Close the temp file. */
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d346 1
a346 1
	 *  Spawn the user's editor on the news file.
d354 1
a354 1
	 *  Use the built in line editior.
d366 2
a367 2
	    LYCloseTempFP(fd);		/* Close the temp file.	*/
	    scrollok(LYwin, FALSE);	/* Stop scrolling.	*/
d370 1
a370 1
	while (!STREQ(user_input,".") && !term_message) {
d372 1
a372 1
	    fprintf(fd,"%s\n",user_input);
d380 1
a380 1
		scrollok(LYwin, FALSE);	/* Stop scrolling.	*/
d385 2
a386 2
	LYCloseTempFP(fd);		/* Close the temp file. */
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d391 2
a392 2
	 *  Confirm whether to post, and if so,
	 *  whether to append the sig file. - FM
d398 1
a398 1
	    LYclear();  /* clear the screen */
d404 1
a404 1
	 || HTConfirmDefault(POST_MSG_PROMPT, NO) != YES)
d409 1
d416 1
a416 1
	    if ((fd = LYAppendToTxtFile (my_tempfile)) != NULL) {
d418 1
d430 1
a430 1
    LYclear();  /* clear the screen */
d433 4
a436 5
     *  If we are using a Japanese display character
     *  set, convert the contents of the temp file to
     *  JIS (nothing should change if it does not, in
     *  fact, contain EUC or SJIS di-bytes).  Otherwise,
     *  use the temp file as is. - FM
d441 1
d443 2
a444 2
		TO_JIS((unsigned char *)buffer,
		       (unsigned char *)CJKinput);
d461 5
a465 7
	 *  If it's not a followup, the current document
	 *  most likely is the group listing, so force a
	 *  to have the article show up in the list after
	 *  the posting.  Note, that if it's a followup
	 *  via a link in a news article, the user must
	 *  do a reload manually on returning to the
	 *  group listing. - FM
d474 1
a474 1
     *  Come here to cleanup and exit.
d476 1
a476 1
cleanup:
d487 1
a487 1
    return(postfile);
d490 1
a490 2
static void terminate_message (
	int	sig GCC_UNUSED)
d494 1
a494 1
     *  Reassert the AST.
d499 1
a499 1
     *  Refresh the screen to get rid of the "interrupt" message.
@


1.3
log
@un-tar the file
>>> lynx2.8.5dev.16.tar.gz
from http://lynx.isc.org/current/

the following files need -kb:
- LYStyle.c
- Xsystem.c
- WWW HTMIME.c
@
text
@d27 1
a27 1
PRIVATE void terminate_message  PARAMS((int sig));
d29 3
a31 3
PRIVATE BOOLEAN message_has_content ARGS2(
    CONST char *,	filename,
    BOOLEAN *,		nonspaces)
d82 3
a84 3
PUBLIC char *LYNewsPost ARGS2(
	char *,		newsgroups,
	BOOLEAN,	followup)
d89 1
a89 1
    CONST char *kp = NULL;
d227 1
a227 1
		TO_EUC((CONST unsigned char *)kp, (unsigned char *)CJKinput);
d231 1
a231 1
		TO_SJIS((CONST unsigned char *)kp, (unsigned char *)CJKinput);
d341 1
a341 1
		print_wwwfile_to_fd(fd, TRUE);
d494 2
a495 2
PRIVATE void terminate_message ARGS1(
	int,	sig GCC_UNUSED)
@


1.2
log
@remove lynx 2.8.4 patchlevel 1d
@
text
@d17 1
d29 3
a31 2
PRIVATE BOOLEAN message_has_content ARGS1(
    CONST char *,		filename)
d37 2
d40 2
a41 2
	CTRACE(tfp, "Failed to open file %s for reading!\n",
	       filename ? filename : "(<null>)");
d47 1
a47 3
	if (*cp == '\0') {
	    break;
	}
d49 4
a52 13
	    if (*cp == '\n') {
		break;
	    } else if (*cp != ' ') {
		if (!firstnonblank && isgraph((unsigned char)*cp)) {
		    firstnonblank = *cp;
		}
	    }
	}
	if (*cp != '\n') {
	    int c;
	    while ((c = getc(fp)) != EOF && c != (int)(unsigned char)'\n') {
		if (!firstnonblank && isgraph((unsigned char)c))
		    firstnonblank = (char)c;
d57 1
a57 1
		fclose(fp);
d67 1
a67 1
    fclose(fp);
d91 1
d102 1
d112 7
d122 6
a127 1
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, "w")) == NULL) {
d164 1
a164 1
	      isalnum(cp[1]))) {
d184 7
a190 7
    clear();
    move(2,0);
    scrollok(stdscr, TRUE);	/* Enable scrolling. */
    addstr(gettext("You will be posting to:"));
    addstr("\n\t");
    addstr(NewsGroups);
    addch('\n');
d196 3
a198 4
    addstr(gettext("\n\n Please provide your mail address for the From: header\n"));
    strcpy(user_input, "From: ");
    if (personal_mail_address)
	strcat(user_input, personal_mail_address);
d204 1
a204 1
	scrollok(stdscr, FALSE);	/* Stop scrolling.	*/
d214 1
a214 1
    addstr(gettext("\n\n Please provide or edit the Subject: header\n"));
d222 17
d242 2
a243 1
	strcat(user_input, kp);
d251 1
a251 1
	scrollok(stdscr, FALSE);	/* Stop scrolling.	*/
d260 1
a260 1
    if (((org = getenv("ORGANIZATION")) != NULL) && *org != '\0') {
d262 1
a262 2
    } else if (((org = getenv("NEWS_ORGANIZATION")) != NULL) &&
	       *org != '\0') {
d264 3
a266 2
#ifndef VMS
    } else if ((fp = fopen("/etc/organization", "r")) != NULL) {
a268 3
	    if ((org = strchr(buffer, '\n')) != NULL) {
		*org = '\0';
	    }
d270 1
d275 23
a297 2
	fclose(fp);
#endif /* !VMS */
d299 2
d303 1
a303 1
    addstr(gettext("\n\n Please provide or edit the Organization: header\n"));
d309 1
a309 1
	scrollok(stdscr, FALSE);	/* Stop scrolling.	*/
a325 4
	/*
	 *  Use an external editor.
	 */
	char *editor_arg = "";
d335 1
a335 1
		 *  The 1 will add the reply ">" in front of every line.
d341 1
a341 1
		print_wwwfile_to_fd(fd, 1);
d345 2
a346 2
	scrollok(stdscr, FALSE);	/* Stop scrolling.	*/
	if (term_message || c == 7 || c == 3)
d352 1
a352 12
	if (strstr(editor, "pico")) {
	    editor_arg = " -t"; /* No prompt for filename to use */
	}
	sprintf(user_input,"%s%s %s", editor, editor_arg, my_tempfile);
	_statusline(SPAWNING_EDITOR_FOR_NEWS);
	stop_curses();
	if (LYSystem(user_input)) {
	    start_curses();
	    HTAlert(ERROR_SPAWNING_EDITOR);
	} else {
	    start_curses();
	}
d354 1
a354 1
	nonempty = message_has_content(my_tempfile);
d360 5
a364 5
	addstr(gettext("\n\n Please enter your message below."));
	addstr(gettext("\n When you are done, press enter and put a single period (.)"));
	addstr(gettext("\n on a line and press enter again."));
	addstr("\n\n");
	refresh();
d371 1
a371 1
	    scrollok(stdscr, FALSE);	/* Stop scrolling.	*/
d375 1
a375 1
	    addch('\n');
d383 2
a384 2
		LYCloseTempFP(fd);		/* Close the temp file. */
		scrollok(stdscr, FALSE);	/* Stop scrolling.	*/
d390 1
a390 1
	scrollok(stdscr, FALSE);	/* Stop scrolling.	*/
d393 13
a405 1
    if (!nonempty) {
d407 3
a409 12
	goto cleanup;
    }
    /*
     *  Confirm whether to post, and if so,
     *  whether to append the sig file. - FM
     */
    LYStatusLine = (LYlines - 1);
    c = HTConfirm(POST_MSG_PROMPT);
    LYStatusLine = -1;
    if (c != YES) {
	clear();  /* clear the screen */
	goto cleanup;
d411 1
a411 1
    if ((LynxSigFile != NULL) && (fp = fopen(LynxSigFile, "r")) != NULL) {
d425 1
a425 1
		fclose(fd);
d428 1
a428 1
	fclose(fp);
d432 1
a432 1
    clear();  /* clear the screen */
d442 1
a442 1
	if ((fd = fopen(my_tempfile, "r")) != NULL) {
d451 1
a451 1
	    fclose(fd);
d507 1
a507 1
    refresh();
@


1.1
log
@Initial revision
@
text
@@


1.1.2.1
log
@Lynx 2.8.6dev.10 as imported into ncvs
@
text
@a16 1
#include <LYEdit.h>
d23 2
a24 2
 *  Global variable for async i/o.
 */
d26 1
a26 1
static void terminate_message(int sig);
d28 2
a29 2
static BOOLEAN message_has_content(const char *filename,
				   BOOLEAN *nonspaces)
a34 2
    *nonspaces = FALSE;

d36 2
a37 2
	CTRACE((tfp, "Failed to open file %s for reading!\n",
		NONNULL(filename)));
d43 3
a45 2

	LYTrimNewline(cp);
d47 13
a59 4
	    if (!firstnonblank && isgraph(UCH(*cp))) {
		firstnonblank = *cp;
	    } else if (!isspace(UCH(*cp))) {
		*nonspaces = TRUE;
d64 1
a64 1
		LYCloseInput(fp);
d74 1
a74 1
    LYCloseInput(fp);
d79 13
a91 12
 *  This function is called from HTLoadNews() to have the user
 *  create a file with news headers and a body for posting of
 *  a new message (based on a newspost://nntp_host/newsgroups
 *  or snewspost://secure_nntp_host/newsgroups URL), or to post
 *  a followup (based on a newsreply://nntp_host/newsgroups or
 *  snewsreply://secure_nntp_host/newsgroups URL). The group
 *  or comma-separated list of newsgroups is passed without
 *  a lead slash, and followup is TRUE for newsreply or
 *  snewsreply URLs.  - FM
 */
char *LYNewsPost(char *newsgroups,
		 BOOLEAN followup)
d96 2
a97 3
    const char *kp = NULL;
    int c = 0;			/* user input */
    int len;
a107 8
    BOOLEAN nonspaces = FALSE;

    /*
     * Make sure a non-zero length newspost, newsreply, snewspost or snewsreply
     * path was sent to us.  - FM
     */
    if (isEmpty(newsgroups))
	return (postfile);
d110 2
a111 2
     * Return immediately if we do get called, maybe by some quirk of HTNews.c,
     * when we shouldn't.  - kw
d113 2
a114 2
    if (no_newspost)
	return (postfile);
d117 2
a118 1
     * Open a temporary file for the headers and message body.  - FM
d120 1
a120 6
#ifdef __DJGPP__
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, BIN_W)) == NULL)
#else
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, "w")) == NULL)
#endif /* __DJGPP__ */
    {
d122 1
a122 1
	return (postfile);
d126 2
a127 2
     * If we're using a Japanese display character set, open a temporary file
     * for a conversion to JIS.  - FM
d135 1
a135 1
	    return (postfile);
d140 3
a142 2
     * The newsgroups could be a comma-seperated list.  It need not have
     * spaces, but deal with any that may also have been hex escaped.  - FM
d157 1
a157 1
	      isalnum(UCH(cp[1])))) {
d163 1
a163 1
	LYCloseTempFP(fd);	/* Close the temp file. */
d168 2
a169 1
     * Allow ^C to cancel the posting, i.e., don't let SIGINTs exit Lynx.
d175 1
a175 1
     * Show the list of newsgroups.  - FM
d177 16
a192 15
    LYclear();
    LYmove(2, 0);
    scrollok(LYwin, TRUE);	/* Enable scrolling. */
    LYaddstr(gettext("You will be posting to:"));
    LYaddstr("\n\t");
    LYaddstr(NewsGroups);
    LYaddch('\n');

    /*
     * Get the mail address for the From header, offering personal_mail_address
     * as default.
     */
    LYaddstr(gettext("\n\n Please provide your mail address for the From: header\n"));
    sprintf(user_input, "From: %.*s", (int) sizeof(user_input) - 8,
	    NonNull(personal_mail_address));
d197 2
a198 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d204 3
a206 2
     * Get the Subject header, offering the current document's title as the
     * default if this is a followup rather than a new post.  - FM
d208 1
a208 1
    LYaddstr(gettext("\n\n Please provide or edit the Subject: header\n"));
d213 1
a213 1
	 * Add the default subject.
a215 17
#ifdef CJK_EX			/* 1998/05/15 (Fri) 09:10:38 */
	if (HTCJK == JAPANESE) {
	    CJKinput[0] = '\0';
	    switch (kanji_code) {
	    case EUC:
		TO_EUC((const unsigned char *) kp, (unsigned char *) CJKinput);
		kp = CJKinput;
		break;
	    case SJIS:
		TO_SJIS((const unsigned char *) kp, (unsigned char *) CJKinput);
		kp = CJKinput;
		break;
	    default:
		break;
	    }
	}
#endif
d219 1
a219 2
	len = strlen(user_input);
	LYstrncpy(user_input + len, kp, sizeof(user_input) - len - 1);
d226 2
a227 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d230 1
a230 1
    fprintf(fd, "%s\n", user_input);
d233 1
a233 1
     * Add Organization:  header.
d236 1
a236 1
    if ((org = LYGetEnv("ORGANIZATION")) != NULL) {
d238 2
a239 1
    } else if ((org = LYGetEnv("NEWS_ORGANIZATION")) != NULL) {
d241 2
a242 3
    }
#ifdef UNIX
    else if ((fp = fopen("/etc/organization", TXT_R)) != NULL) {
a243 1

d245 3
a248 1
		LYTrimNewline(buffer);
d253 2
a254 23
	LYCloseInput(fp);
    }
#else
#ifdef _WINDOWS			/* 1998/05/14 (Thu) 17:47:01 */
    else {
	char *p, fname[LY_MAXPATH];

	strcpy(fname, LynxSigFile);
	p = strrchr(fname, '/');
	if (p != 0 && (p - fname) < sizeof(fname) - 15) {
	    strcpy(p + 1, "LYNX_ETC.TXT");
	    if ((fp = fopen(fname, TXT_R)) != NULL) {
		if (fgets(user_input, sizeof(user_input), fp) != NULL) {
		    if ((org = strchr(user_input, '\n')) != NULL) {
			*org = '\0';
		    }
		    if (user_input[0] != '\0') {
			StrAllocCat(cp, user_input);
		    }
		}
		LYCloseInput(fp);
	    }
	}
a255 2
#endif /* _WINDOWS */
#endif /* !UNIX */
d258 1
a258 1
    LYaddstr(gettext("\n\n Please provide or edit the Organization: header\n"));
d263 2
a264 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d273 1
a273 1
     * Add Newsgroups Summary and Keywords headers.
d278 1
a278 1
     * Have the user create the message body.
d280 5
a284 1
    if (!no_editor && non_empty(editor)) {
d288 1
a288 1
	     * Ask if the user wants to include the original message.
d294 5
a298 5
		 * The 'TRUE' will add the reply ">" in front of every line. 
		 * We're assuming that if the display character set is Japanese
		 * and the document did not have a CJK charset, any non-EUC or
		 * non-SJIS 8-bit characters in it where converted to 7-bit
		 * equivalents.  - FM
d300 1
a300 1
		print_wwwfile_to_fd(fd, FALSE, TRUE);
d303 3
a305 3
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
	if (term_message || LYCharIsINTERRUPT(c))
d309 1
a309 1
	 * Spawn the user's editor on the news file.
d311 12
a322 1
	edit_temporary_file(my_tempfile, "", SPAWNING_EDITOR_FOR_NEWS);
d324 1
a324 1
	nonempty = message_has_content(my_tempfile, &nonspaces);
d328 1
a328 1
	 * Use the built in line editior.
d330 5
a334 5
	LYaddstr(gettext("\n\n Please enter your message below."));
	LYaddstr(gettext("\n When you are done, press enter and put a single period (.)"));
	LYaddstr(gettext("\n on a line and press enter again."));
	LYaddstr("\n\n");
	LYrefresh();
d340 2
a341 2
	    LYCloseTempFP(fd);	/* Close the temp file. */
	    scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d344 3
a346 3
	while (!STREQ(user_input, ".") && !term_message) {
	    LYaddch('\n');
	    fprintf(fd, "%s\n", user_input);
d353 2
a354 2
		LYCloseTempFP(fd);	/* Close the temp file. */
		scrollok(LYwin, FALSE);		/* Stop scrolling.      */
d359 2
a360 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d363 1
a363 13
    if (nonempty) {
	/*
	 * Confirm whether to post, and if so, whether to append the sig file. 
	 * - FM
	 */
	LYStatusLine = (LYlines - 1);
	c = HTConfirm(POST_MSG_PROMPT);
	LYStatusLine = -1;
	if (c != YES) {
	    LYclear();		/* clear the screen */
	    goto cleanup;
	}
    } else {
d365 12
a376 3
	if (!nonspaces
	    || HTConfirmDefault(POST_MSG_PROMPT, NO) != YES)
	    goto cleanup;
d378 1
a378 1
    if ((LynxSigFile != NULL) && (fp = fopen(LynxSigFile, TXT_R)) != NULL) {
a379 1

d386 1
a386 1
	    if ((fd = LYAppendToTxtFile(my_tempfile)) != NULL) {
a387 1

d392 1
a392 1
		LYCloseOutput(fd);
d395 1
a395 1
	LYCloseInput(fp);
d399 1
a399 1
    LYclear();			/* clear the screen */
d402 5
a406 4
     * If we are using a Japanese display character set, convert the contents
     * of the temp file to JIS (nothing should change if it does not, in fact,
     * contain EUC or SJIS di-bytes).  Otherwise, use the temp file as is.  -
     * FM
d409 1
a409 1
	if ((fd = fopen(my_tempfile, TXT_R)) != NULL) {
a410 1

d412 2
a413 2
		TO_JIS((unsigned char *) buffer,
		       (unsigned char *) CJKinput);
d418 1
a418 1
	    LYCloseInput(fd);
d430 7
a436 5
	 * If it's not a followup, the current document most likely is the
	 * group listing, so force a to have the article show up in the list
	 * after the posting.  Note, that if it's a followup via a link in a
	 * news article, the user must do a reload manually on returning to the
	 * group listing.  - FM
d445 1
a445 1
     * Come here to cleanup and exit.
d447 1
a447 1
  cleanup:
d458 1
a458 1
    return (postfile);
d461 2
a462 1
static void terminate_message(int sig GCC_UNUSED)
d466 1
a466 1
     * Reassert the AST.
d471 1
a471 1
     * Refresh the screen to get rid of the "interrupt" message.
d474 1
a474 1
    LYrefresh();
@


1.1.3.1
log
@Import Lynx 2.8.5.dev16 again, this time via a vendor branch (tg),
to ease tracking of the upcoming dev17 (2.8.6-prerelease) update.
@
text
@a16 1
#include <LYEdit.h>
d28 2
a29 3
PRIVATE BOOLEAN message_has_content ARGS2(
    CONST char *,	filename,
    BOOLEAN *,		nonspaces)
a34 2
    *nonspaces = FALSE;

d36 2
a37 2
	CTRACE((tfp, "Failed to open file %s for reading!\n",
	       NONNULL(filename)));
d43 3
a45 1
	LYTrimNewline(cp);
d47 13
a59 4
	    if (!firstnonblank && isgraph(UCH(*cp))) {
		firstnonblank = *cp;
	    } else if (!isspace(UCH(*cp))) {
		*nonspaces = TRUE;
d64 1
a64 1
		LYCloseInput(fp);
d74 1
a74 1
    LYCloseInput(fp);
a97 1
    int len;
a107 1
    BOOLEAN nonspaces = FALSE;
a116 7
     *  Return immediately if we do get called, maybe by some quirk
     *  of HTNews.c, when we shouldn't. - kw
     */
    if (no_newspost)
	return(postfile);

    /*
d120 1
a120 6
#ifdef __DJGPP__
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, BIN_W)) == NULL)
#else
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, "w")) == NULL)
#endif /* __DJGPP__ */
    {
d157 1
a157 1
	      isalnum(UCH(cp[1])))) {
d177 7
a183 7
    LYclear();
    LYmove(2,0);
    scrollok(LYwin, TRUE);		/* Enable scrolling. */
    LYaddstr(gettext("You will be posting to:"));
    LYaddstr("\n\t");
    LYaddstr(NewsGroups);
    LYaddch('\n');
d189 4
a192 3
    LYaddstr(gettext("\n\n Please provide your mail address for the From: header\n"));
    sprintf(user_input, "From: %.*s", (int)sizeof(user_input) - 8,
	    NonNull(personal_mail_address));
d198 1
a198 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d208 1
a208 1
    LYaddstr(gettext("\n\n Please provide or edit the Subject: header\n"));
a215 17
#ifdef CJK_EX	/* 1998/05/15 (Fri) 09:10:38 */
	if (HTCJK == JAPANESE) {
	    CJKinput[0] = '\0';
	    switch(kanji_code) {
	    case EUC:
		TO_EUC((CONST unsigned char *)kp, (unsigned char *)CJKinput);
		kp = CJKinput;
		break;
	    case SJIS:
		TO_SJIS((CONST unsigned char *)kp, (unsigned char *)CJKinput);
		kp = CJKinput;
		break;
	    default:
		break;
	    }
	}
#endif
d219 1
a219 2
	len = strlen(user_input);
	LYstrncpy(user_input + len, kp, sizeof(user_input) - len - 1);
d227 1
a227 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d236 1
a236 1
    if ((org = LYGetEnv("ORGANIZATION")) != NULL) {
d238 2
a239 1
    } else if ((org = LYGetEnv("NEWS_ORGANIZATION")) != NULL) {
d241 2
a242 3
    }
#ifdef UNIX
    else if ((fp = fopen("/etc/organization", TXT_R)) != NULL) {
d245 3
a248 1
		LYTrimNewline(buffer);
d253 2
a254 1
	LYCloseInput(fp);
a255 24
#else
#ifdef _WINDOWS	/* 1998/05/14 (Thu) 17:47:01 */
    else {
	char *p, fname[LY_MAXPATH];

	strcpy(fname, LynxSigFile);
	p = strrchr(fname, '/');
	if (p != 0 && (p - fname) < sizeof(fname) - 15) {
	    strcpy(p + 1, "LYNX_ETC.TXT");
	    if ((fp = fopen(fname, TXT_R)) != NULL) {
		if (fgets(user_input, sizeof(user_input), fp) != NULL) {
		    if ((org = strchr(user_input, '\n')) != NULL) {
			*org = '\0';
		    }
		    if (user_input[0] != '\0') {
			StrAllocCat(cp, user_input);
		    }
		}
		LYCloseInput(fp);
	    }
	}
    }
#endif /* _WINDOWS */
#endif /* !UNIX */
d258 1
a258 1
    LYaddstr(gettext("\n\n Please provide or edit the Organization: header\n"));
d264 1
a264 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d281 4
d294 1
a294 1
		 *  The 'TRUE' will add the reply ">" in front of every line.
d300 1
a300 1
		print_wwwfile_to_fd(fd, TRUE);
d304 2
a305 2
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
	if (term_message || LYCharIsINTERRUPT(c))
d311 12
a322 1
	edit_temporary_file(my_tempfile, "", SPAWNING_EDITOR_FOR_NEWS);
d324 1
a324 1
	nonempty = message_has_content(my_tempfile, &nonspaces);
d330 5
a334 5
	LYaddstr(gettext("\n\n Please enter your message below."));
	LYaddstr(gettext("\n When you are done, press enter and put a single period (.)"));
	LYaddstr(gettext("\n on a line and press enter again."));
	LYaddstr("\n\n");
	LYrefresh();
d341 1
a341 1
	    scrollok(LYwin, FALSE);	/* Stop scrolling.	*/
d345 1
a345 1
	    LYaddch('\n');
d353 2
a354 2
		LYCloseTempFP(fd);	/* Close the temp file. */
		scrollok(LYwin, FALSE);	/* Stop scrolling.	*/
d360 1
a360 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d363 1
a363 13
    if (nonempty) {
	/*
	 *  Confirm whether to post, and if so,
	 *  whether to append the sig file. - FM
	 */
	LYStatusLine = (LYlines - 1);
	c = HTConfirm(POST_MSG_PROMPT);
	LYStatusLine = -1;
	if (c != YES) {
	    LYclear();  /* clear the screen */
	    goto cleanup;
	}
    } else {
d365 12
a376 3
	if (!nonspaces
	 || HTConfirmDefault(POST_MSG_PROMPT, NO) != YES)
	    goto cleanup;
d378 1
a378 1
    if ((LynxSigFile != NULL) && (fp = fopen(LynxSigFile, TXT_R)) != NULL) {
d392 1
a392 1
		LYCloseOutput(fd);
d395 1
a395 1
	LYCloseInput(fp);
d399 1
a399 1
    LYclear();  /* clear the screen */
d409 1
a409 1
	if ((fd = fopen(my_tempfile, TXT_R)) != NULL) {
d418 1
a418 1
	    LYCloseInput(fd);
d474 1
a474 1
    LYrefresh();
@


1.1.3.2
log
@A three-days old development version of Lynx, the best web browser ever,
which follows the OpenBSD paradigma to only provide high-quality, func-
tional snapshots.
@
text
@d27 1
a27 1
static void terminate_message  (int sig);
d29 3
a31 3
static BOOLEAN message_has_content (
    const char *	filename,
    BOOLEAN *		nonspaces)
d82 3
a84 3
char *LYNewsPost (
	char *		newsgroups,
	BOOLEAN	followup)
d89 1
a89 1
    const char *kp = NULL;
d227 1
a227 1
		TO_EUC((const unsigned char *)kp, (unsigned char *)CJKinput);
d231 1
a231 1
		TO_SJIS((const unsigned char *)kp, (unsigned char *)CJKinput);
d341 1
a341 1
		print_wwwfile_to_fd(fd, FALSE, TRUE);
d494 2
a495 2
static void terminate_message (
	int	sig GCC_UNUSED)
@


1.1.3.3
log
@Lynx 2.8.6dev.5 fresh from the ISC
@
text
@d24 2
a25 2
 *  Global variable for async i/o.
 */
d27 1
a27 1
static void terminate_message(int sig);
d29 3
a31 2
static BOOLEAN message_has_content(const char *filename,
				   BOOLEAN *nonspaces)
d41 1
a41 1
		NONNULL(filename)));
a46 1

d72 13
a84 12
 *  This function is called from HTLoadNews() to have the user
 *  create a file with news headers and a body for posting of
 *  a new message (based on a newspost://nntp_host/newsgroups
 *  or snewspost://secure_nntp_host/newsgroups URL), or to post
 *  a followup (based on a newsreply://nntp_host/newsgroups or
 *  snewsreply://secure_nntp_host/newsgroups URL). The group
 *  or comma-separated list of newsgroups is passed without
 *  a lead slash, and followup is TRUE for newsreply or
 *  snewsreply URLs.  - FM
 */
char *LYNewsPost(char *newsgroups,
		 BOOLEAN followup)
d90 1
a90 1
    int c = 0;			/* user input */
d105 2
a106 2
     * Make sure a non-zero length newspost, newsreply, snewspost or snewsreply
     * path was sent to us.  - FM
d109 1
a109 1
	return (postfile);
d112 2
a113 2
     * Return immediately if we do get called, maybe by some quirk of HTNews.c,
     * when we shouldn't.  - kw
d116 1
a116 1
	return (postfile);
d119 2
a120 1
     * Open a temporary file for the headers and message body.  - FM
d129 1
a129 1
	return (postfile);
d133 2
a134 2
     * If we're using a Japanese display character set, open a temporary file
     * for a conversion to JIS.  - FM
d142 1
a142 1
	    return (postfile);
d147 3
a149 2
     * The newsgroups could be a comma-seperated list.  It need not have
     * spaces, but deal with any that may also have been hex escaped.  - FM
d170 1
a170 1
	LYCloseTempFP(fd);	/* Close the temp file. */
d175 2
a176 1
     * Allow ^C to cancel the posting, i.e., don't let SIGINTs exit Lynx.
d182 1
a182 1
     * Show the list of newsgroups.  - FM
d185 2
a186 2
    LYmove(2, 0);
    scrollok(LYwin, TRUE);	/* Enable scrolling. */
d193 2
a194 2
     * Get the mail address for the From header, offering personal_mail_address
     * as default.
d197 1
a197 1
    sprintf(user_input, "From: %.*s", (int) sizeof(user_input) - 8,
d203 2
a204 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d210 3
a212 2
     * Get the Subject header, offering the current document's title as the
     * default if this is a followup rather than a new post.  - FM
d219 1
a219 1
	 * Add the default subject.
d222 1
a222 1
#ifdef CJK_EX			/* 1998/05/15 (Fri) 09:10:38 */
d225 1
a225 1
	    switch (kanji_code) {
d227 1
a227 1
		TO_EUC((const unsigned char *) kp, (unsigned char *) CJKinput);
d231 1
a231 1
		TO_SJIS((const unsigned char *) kp, (unsigned char *) CJKinput);
d250 2
a251 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d254 1
a254 1
    fprintf(fd, "%s\n", user_input);
d257 1
a257 1
     * Add Organization:  header.
a267 1

d278 1
a278 1
#ifdef _WINDOWS			/* 1998/05/14 (Thu) 17:47:01 */
d308 2
a309 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d318 1
a318 1
     * Add Newsgroups Summary and Keywords headers.
d323 1
a323 1
     * Have the user create the message body.
d329 1
a329 1
	     * Ask if the user wants to include the original message.
d335 5
a339 5
		 * The 'TRUE' will add the reply ">" in front of every line. 
		 * We're assuming that if the display character set is Japanese
		 * and the document did not have a CJK charset, any non-EUC or
		 * non-SJIS 8-bit characters in it where converted to 7-bit
		 * equivalents.  - FM
d344 2
a345 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d350 1
a350 1
	 * Spawn the user's editor on the news file.
d358 1
a358 1
	 * Use the built in line editior.
d370 2
a371 2
	    LYCloseTempFP(fd);	/* Close the temp file. */
	    scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d374 1
a374 1
	while (!STREQ(user_input, ".") && !term_message) {
d376 1
a376 1
	    fprintf(fd, "%s\n", user_input);
d384 1
a384 1
		scrollok(LYwin, FALSE);		/* Stop scrolling.      */
d389 2
a390 2
	LYCloseTempFP(fd);	/* Close the temp file. */
	scrollok(LYwin, FALSE);	/* Stop scrolling.      */
d395 2
a396 2
	 * Confirm whether to post, and if so, whether to append the sig file. 
	 * - FM
d402 1
a402 1
	    LYclear();		/* clear the screen */
d408 1
a408 1
	    || HTConfirmDefault(POST_MSG_PROMPT, NO) != YES)
a412 1

d419 1
a419 1
	    if ((fd = LYAppendToTxtFile(my_tempfile)) != NULL) {
a420 1

d432 1
a432 1
    LYclear();			/* clear the screen */
d435 5
a439 4
     * If we are using a Japanese display character set, convert the contents
     * of the temp file to JIS (nothing should change if it does not, in fact,
     * contain EUC or SJIS di-bytes).  Otherwise, use the temp file as is.  -
     * FM
a443 1

d445 2
a446 2
		TO_JIS((unsigned char *) buffer,
		       (unsigned char *) CJKinput);
d463 7
a469 5
	 * If it's not a followup, the current document most likely is the
	 * group listing, so force a to have the article show up in the list
	 * after the posting.  Note, that if it's a followup via a link in a
	 * news article, the user must do a reload manually on returning to the
	 * group listing.  - FM
d478 1
a478 1
     * Come here to cleanup and exit.
d480 1
a480 1
  cleanup:
d491 1
a491 1
    return (postfile);
d494 2
a495 1
static void terminate_message(int sig GCC_UNUSED)
d499 1
a499 1
     * Reassert the AST.
d504 1
a504 1
     * Refresh the screen to get rid of the "interrupt" message.
@


1.1.3.4
log
@fix important bugs in lynx by updating to latest -current snapshot
@
text
@d107 1
a107 1
    if (isEmpty(newsgroups))
d321 1
a321 1
    if (!no_editor && non_empty(editor)) {
@


1.1.1.1
log
@Import OpenBSD 3.3 source repository from CTM 3132 the first time
This opens an OpenBSD-mirabile (aka MirBSD) repository.

### MirBSD is:
# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
# Copyright © 1968-2003  The authors of And contributors to UNIX®, the
#       C Language, BSD/Berkeley Unix; 386BSD, NetBSD 1.1 and OpenBSD.
#
# Anyone who obtained a copy of this work is hereby permitted to freely use,
# distribute, modify, merge, sublicence, give away or sell it as long as the
# authors are given due credit and the following notice is retained:
#
# This work is provided "as is", with no explicit or implicit warranty what-
# soever. Use it only at your own risk. In no event may an author or contri-
# butor be held liable for any damage, directly or indirectly, that origina-
# ted through or is caused by creation or modification of this work.

MirBSD is my private tree. MirBSD does not differ very much from OpenBSD
and intentionally tracks OpenBSD. That's why it _is_ OpenBSD, just not the
official one. It's like with DarrenBSD.

At time of this writing, no advertising for MirBSD must be done,
because the advertising clause has not yet been sorted out.

http://templeofhate.com/tglaser/MirBSD/index.php
@
text
@@


1.1.1.2
log
@Import OpenBSD source tree of short before 17:00 UTC today
@
text
@a16 1
#include <LYEdit.h>
d28 2
a29 3
PRIVATE BOOLEAN message_has_content ARGS2(
    CONST char *,	filename,
    BOOLEAN *,		nonspaces)
a34 2
    *nonspaces = FALSE;

d36 2
a37 2
	CTRACE((tfp, "Failed to open file %s for reading!\n",
	       NONNULL(filename)));
d50 1
a50 1
		if (!firstnonblank && isgraph(UCH(*cp))) {
a51 2
		} else if (!isspace(UCH(*cp))) {
		    *nonspaces = TRUE;
d57 2
a58 2
	    while ((c = getc(fp)) != EOF && c != '\n') {
		if (!firstnonblank && isgraph(UCH(c))) {
a59 3
		} else if (!isspace(UCH(*cp))) {
		    *nonspaces = TRUE;
		}
d64 1
a64 1
		LYCloseInput(fp);
d74 1
a74 1
    LYCloseInput(fp);
a97 1
    int len;
a107 1
    BOOLEAN nonspaces = FALSE;
a116 7
     *  Return immediately if we do get called, maybe by some quirk
     *  of HTNews.c, when we shouldn't. - kw
     */
    if (no_newspost)
	return(postfile);

    /*
d120 1
a120 6
#ifdef __DJGPP__
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, BIN_W)) == NULL)
#else
    if ((fd = LYOpenTemp(my_tempfile, HTML_SUFFIX, "w")) == NULL)
#endif /* __DJGPP__ */
    {
d157 1
a157 1
	      isalnum(UCH(cp[1])))) {
d177 7
a183 7
    LYclear();
    LYmove(2,0);
    scrollok(LYwin, TRUE);		/* Enable scrolling. */
    LYaddstr(gettext("You will be posting to:"));
    LYaddstr("\n\t");
    LYaddstr(NewsGroups);
    LYaddch('\n');
d189 4
a192 3
    LYaddstr(gettext("\n\n Please provide your mail address for the From: header\n"));
    sprintf(user_input, "From: %.*s", (int)sizeof(user_input) - 8,
	    (personal_mail_address != NULL) ? personal_mail_address : "");
d198 1
a198 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d208 1
a208 1
    LYaddstr(gettext("\n\n Please provide or edit the Subject: header\n"));
a215 17
#ifdef CJK_EX	/* 1998/05/15 (Fri) 09:10:38 */
	if (HTCJK == JAPANESE) {
	    CJKinput[0] = '\0';
	    switch(kanji_code) {
	    case EUC:
		TO_EUC((CONST unsigned char *)kp, (unsigned char *)CJKinput);
		kp = CJKinput;
		break;
	    case SJIS:
		TO_SJIS((CONST unsigned char *)kp, (unsigned char *)CJKinput);
		kp = CJKinput;
		break;
	    default:
		break;
	    }
	}
#endif
d219 1
a219 2
	len = strlen(user_input);
	LYstrncpy(user_input + len, kp, sizeof(user_input) - len - 1);
d227 1
a227 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d241 2
a242 3
    }
#ifdef UNIX
    else if ((fp = fopen("/etc/organization", TXT_R)) != NULL) {
d253 2
a254 1
	LYCloseInput(fp);
a255 24
#else
#ifdef _WINDOWS	/* 1998/05/14 (Thu) 17:47:01 */
    else {
	char *p, fname[LY_MAXPATH];

	strcpy(fname, LynxSigFile);
	p = strrchr(fname, '/');
	if (p != 0 && (p - fname) < sizeof(fname) - 15) {
	    strcpy(p + 1, "LYNX_ETC.TXT");
	    if ((fp = fopen(fname, TXT_R)) != NULL) {
		if (fgets(user_input, sizeof(user_input), fp) != NULL) {
		    if ((org = strchr(user_input, '\n')) != NULL) {
			*org = '\0';
		    }
		    if (user_input[0] != '\0') {
			StrAllocCat(cp, user_input);
		    }
		}
		LYCloseInput(fp);
	    }
	}
    }
#endif /* _WINDOWS */
#endif /* !UNIX */
d258 1
a258 1
    LYaddstr(gettext("\n\n Please provide or edit the Organization: header\n"));
d264 1
a264 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d281 4
d294 1
a294 1
		 *  The 'TRUE' will add the reply ">" in front of every line.
d300 1
a300 1
		print_wwwfile_to_fd(fd, TRUE);
d304 2
a305 2
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
	if (term_message || LYCharIsINTERRUPT(c))
d311 12
a322 1
	edit_temporary_file(my_tempfile, "", SPAWNING_EDITOR_FOR_NEWS);
d324 1
a324 1
	nonempty = message_has_content(my_tempfile, &nonspaces);
d330 5
a334 5
	LYaddstr(gettext("\n\n Please enter your message below."));
	LYaddstr(gettext("\n When you are done, press enter and put a single period (.)"));
	LYaddstr(gettext("\n on a line and press enter again."));
	LYaddstr("\n\n");
	LYrefresh();
d341 1
a341 1
	    scrollok(LYwin, FALSE);	/* Stop scrolling.	*/
d345 1
a345 1
	    LYaddch('\n');
d353 2
a354 2
		LYCloseTempFP(fd);	/* Close the temp file. */
		scrollok(LYwin, FALSE);	/* Stop scrolling.	*/
d360 1
a360 1
	scrollok(LYwin, FALSE);		/* Stop scrolling.	*/
d363 1
a363 13
    if (nonempty) {
	/*
	 *  Confirm whether to post, and if so,
	 *  whether to append the sig file. - FM
	 */
	LYStatusLine = (LYlines - 1);
	c = HTConfirm(POST_MSG_PROMPT);
	LYStatusLine = -1;
	if (c != YES) {
	    LYclear();  /* clear the screen */
	    goto cleanup;
	}
    } else {
d365 12
a376 3
	if (!nonspaces
	 || HTConfirmDefault(POST_MSG_PROMPT, NO) != YES)
	    goto cleanup;
d378 1
a378 1
    if ((LynxSigFile != NULL) && (fp = fopen(LynxSigFile, TXT_R)) != NULL) {
d392 1
a392 1
		LYCloseOutput(fd);
d395 1
a395 1
	LYCloseInput(fp);
d399 1
a399 1
    LYclear();  /* clear the screen */
d409 1
a409 1
	if ((fd = fopen(my_tempfile, TXT_R)) != NULL) {
d418 1
a418 1
	    LYCloseInput(fd);
d474 1
a474 1
    LYrefresh();
@

