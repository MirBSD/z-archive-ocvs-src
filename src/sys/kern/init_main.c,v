head	1.25;
access;
symbols
	tg-mergetmp-mirosx-1:1.25
	tg-mergefixes-1-branch:1.25.0.4
	tg-mergefixes-1-base:1.25
	MIROS_X:1.25.0.2
	MIROS_X_BASE:1.25
	tg-mergetmp-3:1.25
	MIRBSD_XP_MIRPPC:1.22.0.4
	MIRBSD_XP_SPARC_BASE:1.22
	MIRBSD_XP_SPARC:1.22.0.2
	MIRBSD_7quater:1.10
	cvs-200405160640:1.1.1.9
	cvs-200401271800:1.1.1.8
	cvs-200401261630:1.1.1.8
	cvs-200401021645:1.1.1.7
	MIRBSD_7_ALPHA:1.10.0.6
	MIRBSD_7:1.10.0.4
	cvs-200312222040:1.1.1.6
	MIRBSD_7ter:1.10
	MIRBSD_7_DEV:1.10.0.2
	cvs-200310020700:1.1.1.5
	cvs-200309271030:1.1.1.5
	cvs-200309261655:1.1.1.5
	cvs-200309251530:1.1.1.5
	cvs-200308302005:1.1.1.4
	cvs-200308171200:1.1.1.3
	ctm-3496:1.1.1.3
	ctm-3449:1.1.1.3
	ctm-3437:1.1.1.3
	cvs-200307191805:1.1.1.3
	ctm-3425:1.1.1.3
	cvs-200307091500:1.1.1.3
	cvs-200307072125:1.1.1.3
	ctm-3389:1.1.1.3
	cvs-200307021520:1.1.1.3
	cvs-200306291430:1.1.1.3
	ctm-3341:1.1.1.3
	MIRBSD_5:1.5
	cvs-200306082100:1.1.1.3
	ctm-3316:1.1.1.3
	ctm-3272:1.1.1.2
	ctm-3264:1.1.1.1
	cvs-200305071630:1.1.1.1
	ctm-3255:1.1.1.1
	ctm-3229:1.1.1.1
	MIRBSD_4:1.2
	ctm-3203:1.1.1.1
	cvs-20030410-1130:1.1.1.1
	ctm-3155:1.1.1.1
	ctm-3132:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@ * @;


1.25
date	2004.12.11.16.50.14;	author tg;	state Exp;
branches;
next	1.24;

1.24
date	2004.11.14.13.50.38;	author tg;	state Exp;
branches;
next	1.23;

1.23
date	2004.11.14.13.47.14;	author tg;	state Exp;
branches;
next	1.22;

1.22
date	2004.09.16.19.40.13;	author tg;	state Exp;
branches;
next	1.21;

1.21
date	2004.09.16.10.08.02;	author tg;	state Exp;
branches;
next	1.20;

1.20
date	2004.06.19.01.48.16;	author tg;	state Stab;
branches;
next	1.19;

1.19
date	2004.05.27.19.10.49;	author tg;	state Exp;
branches;
next	1.18;

1.18
date	2004.05.23.20.16.27;	author tg;	state Exp;
branches;
next	1.17;

1.17
date	2004.05.15.14.05.53;	author tg;	state Exp;
branches;
next	1.16;

1.16
date	2004.04.26.17.16.44;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2004.04.26.16.39.57;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2004.01.27.17.42.33;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2004.01.03.02.31.29;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2003.12.25.21.25.31;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2003.12.21.22.06.49;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2003.09.25.21.00.12;	author tg;	state Exp;
branches
	1.10.2.1;
next	1.9;

1.9
date	2003.09.19.21.54.50;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2003.08.31.20.54.57;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2003.07.08.18.08.55;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2003.07.05.15.15.40;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2003.06.06.18.29.13;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2003.06.02.20.03.42;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2003.05.22.14.08.41;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2003.03.30.00.55.11;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2003.03.22.17.51.50;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2003.03.22.17.51.50;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2003.05.21.19.10.26;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2003.06.05.17.40.25;	author tg;	state Exp;
branches;
next	1.1.1.4;

1.1.1.4
date	2003.08.30.23.25.00;	author tg;	state Exp;
branches;
next	1.1.1.5;

1.1.1.5
date	2003.09.25.16.39.16;	author tg;	state Exp;
branches;
next	1.1.1.6;

1.1.1.6
date	2003.12.22.21.04.06;	author tg;	state Exp;
branches;
next	1.1.1.7;

1.1.1.7
date	2004.01.02.17.54.21;	author tg;	state Exp;
branches;
next	1.1.1.8;

1.1.1.8
date	2004.01.26.18.52.37;	author tg;	state Exp;
branches;
next	1.1.1.9;

1.1.1.9
date	2004.05.16.09.06.09;	author tg;	state Exp;
branches;
next	;

1.10.2.1
date	2003.11.30.22.42.53;	author wbx;	state Exp;
branches;
next	;


desc
@@


1.25
log
@Another round of mega-commit-death:
* compile fixes (pre-removal)
* distrib list sync (pre-removal)
* throw out more orphaned profiling stuff
* sync with reality (post-removal)
  -> e.g. don't call comsatd in inetd.conf
* general clean-up phase for touched files,
  or stuff "while here"
* partial distrib list sync (post-removal)
* replace echo with print in /etc/profile

kernel builds; will do a make b-r in two jiffies
@
text
@/**	$MirBSD: src/sys/kern/init_main.c,v 1.23 2004/11/14 13:47:14 tg Exp $ */
/*	$OpenBSD: init_main.c,v 1.113 2004/04/01 00:27:51 tedu Exp $	*/
/*	$NetBSD: init_main.c,v 1.84.4.1 1996/06/02 09:08:06 mrg Exp $	*/
/*	$OpenBSD: kern_xxx.c,v 1.9 2003/08/15 20:32:18 tedu Exp $	*/
/*	$NetBSD: kern_xxx.c,v 1.32 1996/04/22 01:38:41 christos Exp $	*/

/*
 * Copyright (c) 2002, 2003, 2004
 *	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
 * Copyright (c) 1995 Christopher G. Demetriou.  All rights reserved.
 * Copyright (c) 1982, 1986, 1989, 1991, 1992, 1993
 *	The Regents of the University of California.  All rights reserved.
 * (c) UNIX System Laboratories, Inc.
 * All or some portions of this file are derived from material licensed
 * to the University of California by American Telephone and Telegraph
 * Co. or Unix System Laboratories, Inc. and are reproduced herein with
 * the permission of UNIX System Laboratories, Inc.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)init_main.c	8.9 (Berkeley) 1/21/94
 */

#include <sys/param.h>
#include <sys/filedesc.h>
#include <sys/file.h>
#include <sys/errno.h>
#include <sys/exec.h>
#include <sys/kernel.h>
#include <sys/kthread.h>
#include <sys/mount.h>
#include <sys/proc.h>
#include <sys/resourcevar.h>
#include <sys/signalvar.h>
#include <sys/systm.h>
#include <sys/namei.h>
#include <sys/vnode.h>
#include <sys/tty.h>
#include <sys/conf.h>
#include <sys/buf.h>
#include <sys/device.h>
#include <sys/socketvar.h>
#include <sys/lockf.h>
#include <sys/protosw.h>
#include <sys/reboot.h>
#include <sys/user.h>
#ifdef	SYSVSHM
#include <sys/shm.h>
#endif
#ifdef	SYSVSEM
#include <sys/sem.h>
#endif
#ifdef	SYSVMSG
#include <sys/msg.h>
#endif
#include <sys/domain.h>
#include <sys/mbuf.h>
#include <sys/pipe.h>

#include <sys/syscall.h>
#include <sys/syscallargs.h>

#include <dev/rndvar.h>

#include <ufs/ufs/quota.h>

#include <machine/cpu.h>

#include <uvm/uvm.h>

#include <net/if.h>
#include <net/raw_cb.h>

#if defined(CRYPTO)
#include <crypto/cryptodev.h>
#include <crypto/cryptosoft.h>
#endif

#if defined(NFSSERVER) || defined(NFSCLIENT)
extern void nfs_init(void);
#endif

const char	copyright[] =
"Copyright (c) 1982, 1986, 1989, 1991, 1993\n"
"\tThe Regents of the University of California.  All rights reserved.\n"
"Copyright (c) 1995-2004 OpenBSD. All rights reserved.  http://www.OpenBSD.org\n"
"Copyright (c) 1997-2002 MirBSD; 2002-2004 The MirOS Project.  http://mirbsd.de/\n";

/* Components of the first process -- never freed. */
struct	session session0;
struct	pgrp pgrp0;
struct	proc proc0;
struct	pcred cred0;
struct	plimit limit0;
struct	vmspace vmspace0;
struct	sigacts sigacts0;
#ifndef curproc
struct	proc *curproc;
#endif
struct	proc *initproc;

int	cmask = CMASK;
extern	struct user *proc0paddr;
extern volatile int ticks;	/* XXX should move to sys/x*.h */

void	(*md_diskconf)(void) = NULL;
struct	vnode *rootvp, *swapdev_vp;
int	boothowto;
struct	timeval boottime;
struct	timeval runtime;

/* XXX return int so gcc -Werror won't complain */
int	main(void *);
void	check_console(struct proc *);
void	start_init(void *);
void	start_cleaner(void *);
void	start_update(void *);
void	start_reaper(void *);
void	start_crypto(void *);
void	init_exec(void);
void	init_ssp(void);
void	kqueue_init(void);

extern char sigcode[], esigcode[];
#ifdef	SYSCALL_DEBUG
extern char *syscallnames[];
#endif

struct emul emul_native = {
	"native",
	NULL,
	sendsig,
	SYS_syscall,
	SYS_MAXSYSCALL,
	sysent,
#ifdef	SYSCALL_DEBUG
	syscallnames,
#else
	NULL,
#endif
	0,
	copyargs,
	setregs,
	NULL,
	sigcode,
	esigcode,
	EMUL_ENABLED | EMUL_NATIVE,
};


/*
 * System startup; initialize the world, create process 0, mount root
 * filesystem, and fork to create init and pagedaemon.  Most of the
 * hard work is done in the lower-level initialization routines including
 * startup(), which does memory initialization and autoconfiguration.
 */
int
main(/* XXX should go away */ void *framep)
{
	struct proc *p;
	struct pdevinit *pdev;
	struct timeval rtv;
	quad_t lim;
	int s, i;
	register_t rval[2];
	extern struct pdevinit pdevinit[];
	extern void scheduler_start(void);
	extern void disk_init(void);
	extern void endtsleep(void *);
	extern void realitexpire(void *);

	/*
	 * Initialize the current process pointer (curproc) before
	 * any possible traps/probes to simplify trap processing.
	 */
	curproc = p = &proc0;

	/*
	 * Initialize timeouts.
	 */
	timeout_startup();

	/*
	 * Attempt to find console and initialize
	 * in case of early panic or other messages.
	 */
	config_init();		/* init autoconfiguration data structures */
	consinit();
	printf("%s\n", copyright);
	rnd_addpool_add((u_long)ticks);

	uvm_init();
	disk_init();		/* must come before autoconfiguration */
	tty_init();		/* initialise ttys */
	cpu_startup();

	/*
	 * Initialize mbufs.  Do this now because we might attempt to
	 * allocate mbufs or mbuf clusters during autoconfiguration.
	 */
	mbinit();

	/* Initalize sockets. */
	soinit();

	/* Initialize sysctls (must be done before any processes run) */
	sysctl_init();

	/*
	 * Initialize process and pgrp structures.
	 */
	procinit();

	/* Initialize file locking. */
	lf_init();

	/*
	 * Initialize filedescriptors.
	 */
	filedesc_init();

	/*
	 * Initialize pipes.
	 */
	pipe_init();

	/*
	 * Initialize kqueues.
	 */
	kqueue_init();

	/*
	 * Create process 0 (the swapper).
	 */
	LIST_INSERT_HEAD(&allproc, p, p_list);
	p->p_pgrp = &pgrp0;
	LIST_INSERT_HEAD(PIDHASH(0), p, p_hash);
	LIST_INSERT_HEAD(PGRPHASH(0), &pgrp0, pg_hash);
	LIST_INIT(&pgrp0.pg_members);
	LIST_INSERT_HEAD(&pgrp0.pg_members, p, p_pglist);

	pgrp0.pg_session = &session0;
	session0.s_count = 1;
	session0.s_leader = p;

	p->p_flag = P_INMEM | P_SYSTEM | P_NOCLDWAIT;
	p->p_stat = SRUN;
	p->p_nice = NZERO;
	p->p_emul = &emul_native;
	bcopy("swapper", p->p_comm, sizeof ("swapper"));

	/* Init timeouts. */
	timeout_set(&p->p_sleep_to, endtsleep, p);
	timeout_set(&p->p_realit_to, realitexpire, p);

	/* Create credentials. */
	cred0.p_refcnt = 1;
	p->p_cred = &cred0;
	p->p_ucred = crget();
	p->p_ucred->cr_ngroups = 1;	/* group 0 */

	/* Initialize signal state for process 0. */
	signal_init();
	p->p_sigacts = &sigacts0;
	siginit(p);

	/* Create the file descriptor table. */
	p->p_fd = fdinit(NULL);

	/* Create the limits structures. */
	p->p_limit = &limit0;
	for (i = 0; i < sizeof(p->p_rlimit)/sizeof(p->p_rlimit[0]); i++)
		limit0.pl_rlimit[i].rlim_cur =
		    limit0.pl_rlimit[i].rlim_max = RLIM_INFINITY;
	limit0.pl_rlimit[RLIMIT_NOFILE].rlim_cur = NOFILE;
	limit0.pl_rlimit[RLIMIT_NOFILE].rlim_max = MIN(NOFILE_MAX,
	    (maxfiles - NOFILE > NOFILE) ?  maxfiles - NOFILE : NOFILE);
	limit0.pl_rlimit[RLIMIT_NPROC].rlim_cur = MAXUPRC;
	lim = ptoa(uvmexp.free);
	limit0.pl_rlimit[RLIMIT_RSS].rlim_max = lim;
	limit0.pl_rlimit[RLIMIT_MEMLOCK].rlim_max = lim;
	limit0.pl_rlimit[RLIMIT_MEMLOCK].rlim_cur = lim / 3;
	limit0.p_refcnt = 1;

	/* Allocate a prototype map so we have something to fork. */
	uvmspace_init(&vmspace0, pmap_kernel(), round_page(VM_MIN_ADDRESS),
	    trunc_page(VM_MAX_ADDRESS), TRUE);
	p->p_vmspace = &vmspace0;

	p->p_addr = proc0paddr;				/* XXX */

	/*
	 * We continue to place resource usage info in the
	 * user struct so they're pageable.
	 */
	p->p_stats = &p->p_addr->u_stats;

	/*
	 * Charge root for one process.
	 */
	(void)chgproccnt(0, 1);

	/* Initialize run queues */
	rqinit();

	/* Configure the devices */
	cpu_configure();

	/* Configure virtual memory system, set vm rlimits. */
	uvm_init_limits(p);

	/* Initialize the file systems. */
#if defined(NFSSERVER) || defined(NFSCLIENT)
	nfs_init();			/* initialize server/shared data */
#endif
	vfsinit();

	/* Start real time and statistics clocks. */
	initclocks();

#ifdef	SYSVSHM
	/* Initialize System V style shared memory. */
	shminit();
#endif

#ifdef	SYSVSEM
	/* Initialize System V style semaphores. */
	seminit();
#endif

#ifdef	SYSVMSG
	/* Initialize System V style message queues. */
	msginit();
#endif

	/* Attach pseudo-devices. */
	randomattach();
	for (pdev = pdevinit; pdev->pdev_attach != NULL; pdev++)
		if (pdev->pdev_count > 0)
			(*pdev->pdev_attach)(pdev->pdev_count);
	rnd_addpool_add((u_long)ticks);

#ifdef	CRYPTO
	swcr_init();
#endif	/* CRYPTO */

	/*
	 * Initialize protocols.  Block reception of incoming packets
	 * until everything is ready.
	 */
	s = splimp();
	ifinit();
	domaininit();
	if_attachdomain();
	splx(s);

	/* initialise stack protector */
	init_ssp();

	/* init exec and emul */
	init_exec();

	/* Start the scheduler */
	scheduler_start();

	dostartuphooks();

	/* Configure root/swap devices */
	if (md_diskconf)
		(*md_diskconf)();

	/* Mount the root file system. */
	if (vfs_mountroot())
		panic("cannot mount root");
	CIRCLEQ_FIRST(&mountlist)->mnt_flag |= MNT_ROOTFS;

	/* Get the vnode for '/'.  Set p->p_fd->fd_cdir to reference it. */
	if (VFS_ROOT(mountlist.cqh_first, &rootvnode))
		panic("cannot find root vnode");
	p->p_fd->fd_cdir = rootvnode;
	VREF(p->p_fd->fd_cdir);
	VOP_UNLOCK(rootvnode, 0, p);
	p->p_fd->fd_rdir = NULL;

	uvm_swap_init();

	/*
	 * Now can look at time, having had a chance to verify the time
	 * from the file system.  Reset p->p_rtime as it may have been
	 * munched in mi_switch() after the time got set.
	 */
	p->p_stats->p_start = runtime = mono_time = boottime = time;
	p->p_rtime.tv_sec = p->p_rtime.tv_usec = 0;

	/* Create process 1 (init(8)). */
	if (fork1(p, SIGCHLD, FORK_FORK, NULL, 0, start_init, NULL, rval))
		panic("fork init");

	/* Create process 2, the pageout daemon kernel thread. */
	if (kthread_create(uvm_pageout, NULL, NULL, "pagedaemon"))
		panic("fork pagedaemon");

	/* Create process 3, the reaper daemon kernel thread. */
	if (kthread_create(start_reaper, NULL, NULL, "reaper"))
		panic("fork reaper");

	/* Create process 4, the cleaner daemon kernel thread. */
	if (kthread_create(start_cleaner, NULL, NULL, "cleaner"))
		panic("fork cleaner");

	/* Create process 5, the update daemon kernel thread. */
	if (kthread_create(start_update, NULL, NULL, "update"))
		panic("fork update");

	/* Create process 6, the aiodone daemon kernel thread. */
	if (kthread_create(uvm_aiodone_daemon, NULL, NULL, "aiodoned"))
		panic("fork aiodoned");

#ifdef	CRYPTO
	/* Create process 7, the crypto kernel thread. */
	if (kthread_create(start_crypto, NULL, NULL, "crypto"))
		panic("crypto thread");
#endif	/* CRYPTO */

	/* Create any other deferred kernel threads. */
	kthread_run_deferred_queue();

	microtime(&rtv);
	srandom((u_long)(rtv.tv_sec ^ rtv.tv_usec));
	rnd_addpool_add((u_long)ticks ^ rtv.tv_usec);

	randompid = 1;
	/* The scheduler is an infinite loop. */
	uvm_scheduler();
	/* NOTREACHED */
}

/*
 * List of paths to try when searching for "init".
 */
static char *initpaths[] = {
	"/sbin/init",
	"/sbin/oinit",
	"/sbin/init.bak",
	NULL,
};

void
check_console(struct proc *p)
{
	struct nameidata nd;
	int error;

	NDINIT(&nd, LOOKUP, FOLLOW, UIO_SYSSPACE, "/dev/console", p);
	error = namei(&nd);
	if (error) {
		if (error == ENOENT)
			printf("warning: /dev/console does not exist\n");
		else
			printf("warning: /dev/console error %d\n", error);
	} else
		vrele(nd.ni_vp);
}

/*
 * Start the initial user process; try exec'ing each pathname in "initpaths".
 * The program is invoked with one argument containing the boot flags.
 */
void
start_init(void *arg)
{
	struct proc *p = arg;
	vaddr_t addr;
	struct sys_execve_args /* {
		syscallarg(const char *) path;
		syscallarg(char *const *) argp;
		syscallarg(char *const *) envp;
	} */ args;
	int options, error;
	long i;
	register_t retval[2];
	char flags[4], *flagsp;
	char **pathp, *path, *ucp, **uap, *arg0, *arg1 = NULL;

	initproc = p;

	/*
	 * Now in process 1.
	 */
	check_console(p);

	/*
	 * Need just enough stack to hold the faked-up "execve()" arguments.
	 */
#ifdef	MACHINE_STACK_GROWS_UP
	addr = USRSTACK;
#else
	addr = USRSTACK - PAGE_SIZE;
#endif
	if (uvm_map(&p->p_vmspace->vm_map, &addr, PAGE_SIZE,
	    NULL, UVM_UNKNOWN_OFFSET, 0,
	    UVM_MAPFLAG(UVM_PROT_RW, UVM_PROT_ALL, UVM_INH_COPY,
	    UVM_ADV_NORMAL, UVM_FLAG_FIXED|UVM_FLAG_OVERLAY|UVM_FLAG_COPYONW)))
		panic("init: couldn't allocate argument space");
	p->p_vmspace->vm_maxsaddr = (caddr_t)addr;

	for (pathp = &initpaths[0]; (path = *pathp) != NULL; pathp++) {
#ifdef	MACHINE_STACK_GROWS_UP
		ucp = (char *)addr;
#else
		ucp = (char *)(addr + PAGE_SIZE);
#endif
		/*
		 * Construct the boot flag argument.
		 */
		flagsp = flags;
		*flagsp++ = '-';
		options = 0;

		if (boothowto & RB_SINGLE) {
			*flagsp++ = 's';
			options = 1;
		}
#ifdef	notyet
		if (boothowto & RB_FASTBOOT) {
			*flagsp++ = 'f';
			options = 1;
		}
#endif

		/*
		 * Move out the flags (arg 1), if necessary.
		 */
		if (options != 0) {
			*flagsp++ = '\0';
			i = flagsp - flags;
#ifdef	DEBUG
			printf("init: copying out flags `%s' %d\n", flags, i);
#endif
#ifdef	MACHINE_STACK_GROWS_UP
			arg1 = ucp;
			(void)copyout((caddr_t)flags, (caddr_t)ucp, i);
			ucp += i;
#else
			(void)copyout((caddr_t)flags, (caddr_t)(ucp -= i), i);
			arg1 = ucp;
#endif
		}

		/*
		 * Move out the file name (also arg 0).
		 */
		i = strlen(path) + 1;
#ifdef	DEBUG
		printf("init: copying out path `%s' %d\n", path, i);
#endif
#ifdef	MACHINE_STACK_GROWS_UP
		arg0 = ucp;
		(void)copyout((caddr_t)path, (caddr_t)ucp, i);
		ucp += i;
		ucp = (caddr_t)ALIGN((u_long)ucp);
		uap = (char **)ucp + 3;
#else
		(void)copyout((caddr_t)path, (caddr_t)(ucp -= i), i);
		arg0 = ucp;
		uap = (char **)((u_long)ucp & ~ALIGNBYTES);
#endif

		/*
		 * Move out the arg pointers.
		 */
		i = 0;
		copyout(&i, (caddr_t)--uap, sizeof(register_t)); /* terminator */
		if (options != 0)
			copyout(&arg1, (caddr_t)--uap, sizeof(register_t));
		copyout(&arg0, (caddr_t)--uap, sizeof(register_t));

		/*
		 * Point at the arguments.
		 */
		SCARG(&args, path) = arg0;
		SCARG(&args, argp) = uap;
		SCARG(&args, envp) = NULL;

		/*
		 * Now try to exec the program.  If can't for any reason
		 * other than it doesn't exist, complain.
		 */
		if ((error = sys_execve(p, &args, retval)) == 0)
			return;
		if (error != ENOENT)
			printf("exec %s: error %d\n", path, error);
	}
	printf("init: not found\n");
	panic("no init");
}

void
start_update(void *arg)
{
	sched_sync(curproc);
	/* NOTREACHED */
}

void
start_cleaner(void *arg)
{
	buf_daemon(curproc);
	/* NOTREACHED */
}

void
start_reaper(void *arg)
{
	reaper();
	/* NOTREACHED */
}

#ifdef	CRYPTO
void
start_crypto(void *arg)
{
	crypto_thread();
	/* NOTREACHED */
}
#endif	/* CRYPTO */

/* ARGSUSED */
int
sys_reboot(struct proc *p, void *v, register_t *retval)
{
	struct sys_reboot_args /* {
		syscallarg(int) opt;
	} */ *uap = v;
	int error;

	if ((error = suser(p, 0)) != 0)
		return (error);
	boot(SCARG(uap, opt));
	return (0);
}

#ifdef SYSCALL_DEBUG
#define	SCDEBUG_CALLS		0x0001	/* show calls */
#define	SCDEBUG_RETURNS		0x0002	/* show returns */
#define	SCDEBUG_ALL		0x0004	/* even syscalls that are implemented */
#define	SCDEBUG_SHOWARGS	0x0008	/* show arguments to calls */

int	scdebug = SCDEBUG_CALLS|SCDEBUG_RETURNS|SCDEBUG_SHOWARGS;

void
scdebug_call(struct proc *p, register_t code, register_t args[])
{
	struct sysent *sy;
	struct emul *em;
	int i;

	if (!(scdebug & SCDEBUG_CALLS))
		return;

	em = p->p_emul;
	sy = &em->e_sysent[code];
	if (!(scdebug & SCDEBUG_ALL || code < 0 || code >= em->e_nsysent ||
	     sy->sy_call == sys_nosys))
		return;

	printf("proc %d (%s): %s num ", p->p_pid, p->p_comm, em->e_name);
	if (code < 0 || code >= em->e_nsysent)
		printf("OUT OF RANGE (%d)", code);
	else {
		printf("%d call: %s", code, em->e_syscallnames[code]);
		if (scdebug & SCDEBUG_SHOWARGS) {
			printf("(");
			for (i = 0; i < sy->sy_argsize / sizeof(register_t);
			    i++)
				printf("%s0x%lx", i == 0 ? "" : ", ",
				    (long)args[i]);
			printf(")");
		}
	}
	printf("\n");
}

void
scdebug_ret(p, code, error, retval)
	struct proc *p;
	register_t code;
	int error;
	register_t retval[];
{
	struct sysent *sy;
	struct emul *em;

	if (!(scdebug & SCDEBUG_RETURNS))
		return;

	em = p->p_emul;
	sy = &em->e_sysent[code];
	if (!(scdebug & SCDEBUG_ALL || code < 0 || code >= em->e_nsysent ||
	    sy->sy_call == sys_nosys))
		return;

	printf("proc %d (%s): %s num ", p->p_pid, p->p_comm, em->e_name);
	if (code < 0 || code >= em->e_nsysent)
		printf("OUT OF RANGE (%d)", code);
	else
		printf("%d ret: err = %d, rv = 0x%lx,0x%lx", code,
		    error, (long)retval[0], (long)retval[1]);
	printf("\n");
}
#endif /* SYSCALL_DEBUG */
@


1.24
log
@kern_xxx.c can die; move syscall debug code to init_main.c too
@
text
@a378 5
#ifdef	GPROF
	/* Initialize kernel profiling. */
	kmstartup();
#endif

@


1.23
log
@reduce diff to obsd; move sys_reboot to init_main.c
@
text
@d1 1
a1 1
/**	$MirBSD$ */
d669 70
@


1.22
log
@while here, fix some apostophe catastrophes
@
text
@d1 5
a5 3
/* $MirBSD: src/sys/kern/init_main.c,v 1.21 2004/09/16 10:08:02 tg Exp $	*/
/* $OpenBSD: init_main.c,v 1.113 2004/04/01 00:27:51 tedu Exp $	*/
/* $NetBSD: init_main.c,v 1.84.4.1 1996/06/02 09:08:06 mrg Exp $	*/
d8 2
d96 1
a96 1
#ifdef	CRYPTO
d109 1
a109 2
"Copyright (c) 1997-2004 The MirOS Project.  http://mirbsd.de/\n"
"Full text: /usr/share/man/COPYRIGHT or http://MirBSD.BSDadvocacy.org/?about\n";
d119 1
a119 1
#ifndef	curproc
d654 15
@


1.21
log
@another price.
the __guard[] setup functions (obviously) must not be ssp protected,
since __guard[0] before and after will differ (previously, they used
to work, and I could use -fno-stack-protector-all, but this way it's
a lot safer)

libc tested; kernel crash without this diff confirmed, new kernel not
yet tested
@
text
@d1 1
a1 1
/* $MirBSD: src/sys/kern/init_main.c,v 1.20 2004/06/19 01:48:16 tg Stab $	*/
d213 1
a213 1
	tty_init();		/* initialise tty's */
d217 1
a217 1
	 * Initialize mbuf's.  Do this now because we might attempt to
@


1.20
log
@* sync
* make msdosfs not spit out E2BIG diagnostics to console unmotiviedly
  (msdosfs sucks, someone ought to do a better FAT-compatible FS impl)
* speed up make by defining OSNAME only if it's not already defined
  in <sys.mk> (you might use the environment for example)
* bump OS patchlevel
@
text
@d1 1
a1 1
/* $MirBSD: src/sys/kern/init_main.c,v 1.19 2004/05/27 19:10:49 tg Exp $	*/
a130 4
#ifndef	NO_PROPOLICE
long	__guard[8];
#endif

d140 1
d381 2
a382 3
#ifndef	NO_PROPOLICE
	arc4random_bytes(__guard, sizeof(__guard));
#endif
@


1.19
log
@* make kernel (GENERIC i386) build
* nuke more NS parts
* nuke more SVR4 compat
* fix compats
* more MirOS RCS IDs
* better randomness usage/distribution
* better paranoia checks in random stuff
* use \$SHELL instead of sh
etc.pp
@
text
@d1 1
a1 1
/* $MirBSD: init_main.c,v 1.18 2004/05/23 20:16:27 tg Exp $	*/
d105 2
a106 3
"Copyright (c) 1997-2003 Th.Glaser;  (c) 2002-2004 The MirOS Project.\n"
"View the full licence statement in /usr/share/man/COPYRIGHT or\n"
"\tat https://MirBSD.BSDadvocacy.org:8890/?about\n";
@


1.18
log
@* first futile attempt to merge OpenBSD 3.5-current
* damn! they got pxeboot! -> disable for now
  (there's still ports/sysutils/pxegrub; we'll have pxeboot later)
* I don't know if that ... bootloader still works
* nuke netbsd emul (was unused anyways)
* nuke a plethora of syscalls not being used, and mark
  the other two (COMPAT_35) for deletion RSN
* merge new MI-GENERIC into i386 GENERIC
* resolve numeric conflicts for
  - syscalls
  - sysctls
  - device majors
  - pcidevs
* (c) cleanup - no need to add a bsd-like licence when
  there's already one; just add my name
* and much more
@
text
@d1 1
a1 1
/* $MirBSD: src/sys/kern/init_main.c,v 1.17 2004/05/15 14:05:53 tg Exp $	*/
d105 1
a105 1
"Copyright (c) 1997-2003 Th.Glaser;  (c) 2003-2004 The MirOS Project.\n"
d213 1
d364 1
a364 1
	add_true_randomness((u_long)ticks);
d459 1
@


1.17
log
@* no need to add our own licence template on top of the UCB/ATT one;
  if desired, we can always add our names to their boilerplate
  [hint: this foreshadows a much larger diff]
* refer to /usr/share/man/COPYRIGHT too, in case the website's down
* shrink baby shrink
@
text
@d1 2
a2 2
/* $MirBSD: src/sys/kern/init_main.c,v 1.16 2004/04/26 17:16:44 tg Exp $	*/
/* $OpenBSD: init_main.c,v 1.111 2004/01/21 19:03:44 tedu Exp $	*/
d107 1
a107 1
"\tat https://MirBSD.BSDadvocacy.org:8890/?about\n\n";
d143 1
a143 1
void    start_crypto(void *);
d145 1
d212 1
a212 1
	printf(copyright);
d248 5
@


1.16
log
@oops, mis-understood the add_*_randomness() functions
@
text
@d1 3
a3 26
/*	$MirBSD: src/sys/kern/init_main.c,v 1.15 2004/04/26 16:39:57 tg Exp $	*/
/*	$OpenBSD: init_main.c,v 1.111 2004/01/21 19:03:44 tedu Exp $	*/
/*	$NetBSD: init_main.c,v 1.84.4.1 1996/06/02 09:08:06 mrg Exp $	*/

/*-
 * Copyright (c) 2003, 2004
 *	Thorsten "mirabile" Glaser <x86@@ePost.de>
 *
 * Subject to these terms, everybody who obtained a copy of this work
 * is hereby permitted to deal in the work without restriction inclu-
 * ding without limitation the rights to use, distribute, sell, modi-
 * fy, publically perform, give away, merge or sublicence it provided
 * this notice is kept and the authors and contributors are given due
 * credit in derivates or accompanying documents.
 *
 * This work is provided by its developers (authors and contributors)
 * "as is" and without any warranties whatsoever, express or implied,
 * to the maximum extent permitted by applicable law; in no event may
 * developers be held liable for damage caused, directly or indirect-
 * ly, but not by a developer's malice intent, even if advised of the
 * possibility of such damage.
 *
 * State of court is Bonn, Germany. German laws are hereby implied
 * into this agreement. For details, read on below or refer to the
 * file /usr/src/share/man/man0/COPYRIGHT (/usr/share/man/COPYRIGHT).
 */
d106 2
a107 1
"View the full statement at https://MirBSD.BSDadvocacy.org:8890/?about\n";
d211 1
a211 3
	printf("%s\nThis open software comes WITHOUT WARRANTY of any kind, neither express nor"
	    "\n implied. You are hereby advised to use this work at YOUR OWN RISK only!\n\n",
	    copyright);
@


1.15
log
@update (c) statement
add more randomness
@
text
@d1 1
a1 1
/*	$MirBSD: src/sys/kern/init_main.c,v 1.14 2004/01/27 17:42:33 tg Exp $	*/
d381 1
a381 1
	add_timer_randomness((u_long)ticks);
@


1.14
log
@first part of mergeing OpenBSD and fixing whitespace and RCS IDs
@
text
@d1 1
a1 1
/*	$MirBSD: init_main.c,v 1.13 2004/01/03 02:31:29 tg Exp $	*/
d5 3
a7 2
/* Copyright (c) 2003, 2004
 *	Thorsten Glaser <x86@@ePost.de>
d16 6
a21 5
 * This work is provided "as is" with no explicit or implicit warran-
 * ties whatsoever to the maximum extent permitted by applicable law;
 * in no event may an author or contributor be held liable for damage
 * that is, directly or indirectly, caused by the work, even if advi-
 * sed of the possibility of such damage.
d88 1
a88 1
#ifdef SYSVSHM
d91 1
a91 1
#ifdef SYSVSEM
d94 1
a94 1
#ifdef SYSVMSG
d115 1
a115 1
#if defined(CRYPTO)
d129 1
a129 1
"View the full copyright statement at https://MirBSD.BSDadvocacy.org:8890/\n";
d139 1
a139 1
#ifndef curproc
d146 1
d154 1
a154 1
#if !defined(NO_PROPOLICE)
d169 1
a169 1
#ifdef SYSCALL_DEBUG
d180 1
a180 1
#ifdef SYSCALL_DEBUG
a200 1
/* XXX return int, so gcc -Werror won't complain */
d202 1
a202 2
main(framep)
	void *framep;				/* XXX should go away */
d361 1
a361 1
#ifdef SYSVSHM
d366 1
a366 1
#ifdef SYSVSEM
d371 1
a371 1
#ifdef SYSVMSG
d381 1
d383 1
a383 1
#ifdef CRYPTO
d385 2
a386 2
#endif /* CRYPTO */
	
d397 1
a397 1
#ifdef GPROF
d402 1
a402 1
#if !defined(NO_PROPOLICE)
d461 1
a461 1
	/* Create process 6, the aiodone daemon kernel thread. */ 
d465 1
a465 1
#ifdef CRYPTO
d469 1
a469 1
#endif /* CRYPTO */
d540 1
a540 1
#ifdef MACHINE_STACK_GROWS_UP
d545 1
a545 1
	if (uvm_map(&p->p_vmspace->vm_map, &addr, PAGE_SIZE, 
d553 1
a553 1
#ifdef MACHINE_STACK_GROWS_UP
d569 1
a569 1
#ifdef notyet
d582 1
a582 1
#ifdef DEBUG
d585 1
a585 1
#ifdef MACHINE_STACK_GROWS_UP
d599 1
a599 1
#ifdef DEBUG
d602 1
a602 1
#ifdef MACHINE_STACK_GROWS_UP
d664 1
a664 1
#ifdef CRYPTO
d671 1
a671 1
#endif /* CRYPTO */
@


1.13
log
@Merge OpenBSD; extend (c) to 2004
@
text
@d1 2
a2 2
/*	$MirBSD: init_main.c,v 1.12 2003/12/25 21:25:31 tg Exp $	*/
/*	$OpenBSD: init_main.c,v 1.109 2004/01/01 00:04:35 deraadt Exp $	*/
d82 1
d222 5
a249 5
	/*
	 * Initialize timeouts.
	 */
	timeout_startup();

d257 3
@


1.12
log
@* complete merging OpenBSD import for src/sys
* in addition to that, cope for some miros specialties
new:
+ the "OpenBSD" and "OpenBSDx_y" (x=3 y=4) preprocessor syms
	aren't defined any more
+ the "MirOS" symbol is defined to the same as MACHINE_OS
	(ie, BSD or Linux without string operator) iff
	the system is running MirBSD or MirLinux
bump patchlevel
@
text
@d1 2
a2 2
/*	$MirBSD: init_main.c,v 1.11 2003/12/21 22:06:49 tg Exp $	*/
/*	$OpenBSD: init_main.c,v 1.108 2003/11/03 18:24:52 tedu Exp $	*/
d5 2
a6 1
/* Copyright (c) 2003 Thorsten Glaser <x86@@ePost.de>
d124 3
a126 3
"Copyright (c) 1995-2003 OpenBSD. All rights reserved.  http://www.OpenBSD.org/\n"
"Copyright (c) 1997-2003 Th.Glaser;  Copyright (c) 2003 The MirOS Project.\n"
"The full copyright statement is at https://MirBSD.BSDadvocacy.org:8890/\n";
@


1.11
log
@minor updates and corrections
point better to licencing info (matches website commit)
@
text
@d1 2
a2 2
/*	$MirBSD: init_main.c,v 1.10 2003/09/25 21:00:12 tg Exp $	*/
/*	$OpenBSD: init_main.c,v 1.107 2003/09/01 18:06:03 henning Exp $	*/
a206 3
#if !defined(NO_PROPOLICE)
	int *guard = (int *)&__guard[0];
#endif
d396 1
a396 2
	for (i = 0; i < sizeof(__guard) / 4; i++)
		guard[i] = arc4random();
@


1.10
log
@Merge OpenBSD-current
@
text
@d1 1
a1 1
/*	$MirBSD: init_main.c,v 1.9 2003/09/19 21:54:50 tg Exp $	*/
d10 1
a10 1
 * fy, publically perform, give away, merge or sublicense it provided
d13 1
d15 1
a15 1
 * ties whatsoever to the maximum extend permitted by applicable law;
d20 3
a22 5
 * German laws. The authors and contributors disclaim any liability
 * for damage done by MirBSD, up to the maximum extent possible by
 * applicable law. The authors and contributors only ensure they have
 * not put in harmful code or work on which third partys have rights
 * by will. THERE IS NO LIABILITY.
d124 2
a125 1
"Copyright (c) 1997-2003 Thorsten Glaser.  https://MirBSD.BSDadvocacy.org:8890/\n";
d228 3
a230 3
	printf(copyright);
	printf("\nThis open software comes WITHOUT WARRANTY of any kind, neither express nor"
	    "\n implied. You are hereby advised to use this work at YOUR OWN RISK only!\n\n");
d491 1
a491 2
check_console(p)
	struct proc *p;
d512 1
a512 2
start_init(arg)
	void *arg;
d641 1
a641 2
start_update(arg)
	void *arg;
d648 1
a648 2
start_cleaner(arg)
	void *arg;
d655 1
a655 2
start_reaper(arg)
	void *arg;
d663 1
a663 2
start_crypto(arg)
	void *arg;
@


1.10.2.1
log
@verified exec ported from NetBSD 1.6.1 / Stephanie patches for OpenBSD 3.4:
 - prevent execution of trojaned applications (f.e. netstat,ps,..)
 - activated in GENERIC, but must be enabled with sysctl -w kern.vexec.op=1
 - you have to generate the fingerprint database with fpgen.sh from sbin/vexecctl/

TODO:
- fix a problem with hardlinked applications (f.e. /bin/chown and /bin/chgrp)
  error: "vexec_inodeadd: Received invalid fingerprint for an existing entry! Entry not modified."
- patch MAKEDEV.mi to create devicenode /dev/vexec
- create sample database when doing make release (/etc/vexec.conf.release)
- more testing, test it on sparc
- do performance tests
@
text
@d1 1
a1 1
/*	$MirBSD: init_main.c,v 1.10 2003/09/25 21:00:12 tg Exp $	*/
a474 3

	printf("verified exec activated in kernel.\n");

@


1.9
log
@wording
@
text
@d1 2
a2 2
/*	$MirBSD: init_main.c,v 1.8 2003/08/31 20:54:57 tg Exp $	*/
/*	$OpenBSD: init_main.c,v 1.106 2003/08/21 18:56:07 tedu Exp $	*/
d519 3
a521 3
		syscallarg(char *) path;
		syscallarg(char **) argp;
		syscallarg(char **) envp;
@


1.8
log
@Merge import of OpenBSD source, ports and XF4 tree.

While here,
o clean up differences where possible
o whitespace cleanup
o ifdef ./. if defined()
o '...' ./. "..."
o echo foo > bar ./. echo foo >bar
o `...` ./. $(...) ./. $$(...)
o `...' ./. '...'
o modernize "our" tree, e.g. WWW in ports
o fix some typos and brainos introduced when renaming OpenBSD to MirBSD
o use hardware 80387 by default
o migrate Apache 1.3.28 OpenBSD ./. MirBSD ./. KAME
o work around as many CVS bugs as possible (add back/delete files, ...)

Synchronize stuff, ready for ongoing changes.
@
text
@d1 1
a1 1
/*	$MirBSD: init_main.c,v 1.7 2003/07/08 18:08:55 tg Exp $	*/
d229 2
a230 3
	printf("\nThis is open source software and comes WITHOUT WARRANTY"
	    "\n of any kind, neither express nor implied. You have hereby"
	    "\n been advised to use this work at YOUR OWN RISK only!\n\n");
@


1.7
log
@merge
@
text
@d1 2
a2 2
/*	$MirBSD: init_main.c,v 1.6 2003/07/05 15:15:40 tg Exp $	*/
/*	$OpenBSD: init_main.c,v 1.105 2003/06/02 23:28:05 millert Exp $	*/
d161 1
d186 1
d189 1
d403 3
@


1.6
log
@additional legalese
@
text
@d1 1
a1 1
/*	$MirBSD: init_main.c,v 1.5 2003/06/06 18:29:13 tg Exp $	*/
d10 3
a12 3
 * fy, give away, merge or sublicense it provided this notice is kept
 * and the authors and contributors are given due credit in derivates
 * or accompanying documents.
a18 1
 * MirBSD is edited in Germany and its distribution is covered by
@


1.5
log
@Merge OpenBSD-current
@
text
@d1 1
a1 1
/*	$MirBSD: init_main.c,v 1.4 2003/06/02 20:03:42 tg Exp $	*/
d5 22
d125 2
a126 2
"Copyright (c) 1995-2003 OpenBSD. All rights reserved.  http://www.OpenBSD.org\n"
"Copyright (c) 1982-2003 Thorsten Glaser <x86@@ePost.de>\n";
d227 3
a229 1
	printf("\n");
@


1.4
log
@licence cleanup
@
text
@d1 2
a2 2
/*	$MirBSD$	*/
/*	$OpenBSD: init_main.c,v 1.104 2003/05/13 22:45:11 miod Exp $	*/
d23 1
a23 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
@


1.3
log
@merge CVS import stuff
@
text
@d1 1
d108 1
a108 1
"Copyright (c) 1982-2003 Thorsten \"mirabile\" Glaser <x86@@ePost.de>\n";
@


1.2
log
@all your credits are belong to us
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.101 2003/03/06 17:06:18 mickey Exp $	*/
d83 2
d131 4
d186 3
d376 5
d521 1
a521 1
	    UVM_MAPFLAG(UVM_PROT_ALL, UVM_PROT_ALL, UVM_INH_COPY,
@


1.1
log
@Initial revision
@
text
@d104 2
a105 1
"Copyright (c) 1995-2003 OpenBSD. All rights reserved.  http://www.OpenBSD.org\n";
@


1.1.1.1
log
@Import OpenBSD 3.3 source repository from CTM 3132 the first time
This opens an OpenBSD-mirabile (aka MirBSD) repository.

### MirBSD is:
# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
# Copyright © 1968-2003  The authors of And contributors to UNIX®, the
#       C Language, BSD/Berkeley Unix; 386BSD, NetBSD 1.1 and OpenBSD.
#
# Anyone who obtained a copy of this work is hereby permitted to freely use,
# distribute, modify, merge, sublicence, give away or sell it as long as the
# authors are given due credit and the following notice is retained:
#
# This work is provided "as is", with no explicit or implicit warranty what-
# soever. Use it only at your own risk. In no event may an author or contri-
# butor be held liable for any damage, directly or indirectly, that origina-
# ted through or is caused by creation or modification of this work.

MirBSD is my private tree. MirBSD does not differ very much from OpenBSD
and intentionally tracks OpenBSD. That's why it _is_ OpenBSD, just not the
official one. It's like with DarrenBSD.

At time of this writing, no advertising for MirBSD must be done,
because the advertising clause has not yet been sorted out.

http://templeofhate.com/tglaser/MirBSD/index.php
@
text
@@


1.1.1.2
log
@Sync MirBSD main source tree against OpenBSD-current,
which should be fairly stable after the Hackathon now.
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.104 2003/05/13 22:45:11 miod Exp $	*/
a82 2
#include <dev/rndvar.h>

a127 4
#if !defined(NO_PROPOLICE)
long	__guard[8];
#endif

a178 3
#if !defined(NO_PROPOLICE)
	int *guard = (int *)&__guard[0];
#endif
a365 5
#if !defined(NO_PROPOLICE)
	for (i = 0; i < sizeof(__guard) / 4; i++)
		guard[i] = arc4random();
#endif

d506 1
a506 1
	    UVM_MAPFLAG(UVM_PROT_RW, UVM_PROT_ALL, UVM_INH_COPY,
@


1.1.1.3
log
@Import latest OpenBSD CVS tree by CTM in order
to sync the base system and ports tree with Them.

This includes the recent licence changes as well - by
importing the changed base and re-applying the diffs
(with cvs up -j -j) they are inherited, and we're not
bound to the removed clauses any longer.
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.105 2003/06/02 23:28:05 millert Exp $	*/
d22 5
a26 1
 * 3. Neither the name of the University nor the names of its contributors
@


1.1.1.4
log
@Synchronize with OpenBSD 3.4-beta
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.106 2003/08/21 18:56:07 tedu Exp $	*/
a137 1
void	init_exec(void);
a161 1
	EMUL_ENABLED | EMUL_NATIVE,
a163 1

a374 3

	/* init exec and emul */
	init_exec();
@


1.1.1.5
log
@Release Time. Synchronize with OpenBSD 3.4-current (base system).
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.107 2003/09/01 18:06:03 henning Exp $	*/
d495 3
a497 3
		syscallarg(const char *) path;
		syscallarg(char *const *) argp;
		syscallarg(char *const *) envp;
@


1.1.1.6
log
@Time to import OpenBSD once again. Expect breakage.
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.108 2003/11/03 18:24:52 tedu Exp $	*/
d184 3
d375 2
a376 1
	arc4random_bytes(__guard, sizeof(__guard));
@


1.1.1.7
log
@Import OpenBSD again, for various reasons.
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.109 2004/01/01 00:04:35 deraadt Exp $	*/
d102 1
a102 1
"Copyright (c) 1995-2004 OpenBSD. All rights reserved.  http://www.OpenBSD.org\n";
@


1.1.1.8
log
@Import OpenBSD as of today again (seems pretty stable, I hope)

Prominent changes: more bgpd, tcpmd5; tcpdump/isakmpd fixes
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.111 2004/01/21 19:03:44 tedu Exp $	*/
a59 1
#include <sys/lockf.h>
a196 5
	 * Initialize timeouts.
	 */
	timeout_startup();

	/*
d219 5
a230 3

	/* Initialize file locking. */
	lf_init();
@


1.1.1.9
log
@large-scale import of OpenBSD 3.5-current source base including many fixes
note: from now, we will not be binary compatible with OpenBSD apps any
longer (due to syscall numbering differences); both an OpenBSD compat and
a conversion tool for old MirOS #7 apps will be delivered later.

The src/ tree is locked from now.
@
text
@d1 1
a1 1
/*	$OpenBSD: init_main.c,v 1.113 2004/04/01 00:27:51 tedu Exp $	*/
d138 1
a138 1
void	start_crypto(void *);
a139 1
void	kqueue_init(void);
d208 2
a209 1
	printf("%s\n", copyright);
a244 5

	/*
	 * Initialize kqueues.
	 */
	kqueue_init();
@


