head	1.39;
access;
symbols
	tg-mergetmp-mirosx-1:1.39
	tg-mergefixes-1-branch:1.39.0.4
	tg-mergefixes-1-base:1.39
	MIROS_X:1.39.0.2
	MIROS_X_BASE:1.39
	tg-mergetmp-3:1.39
	MIRBSD_XP_MIRPPC:1.33.0.4
	MIRBSD_XP_SPARC_BASE:1.33
	MIRBSD_XP_SPARC:1.33.0.2
	MIRBSD_7quater:1.19
	cvs-200405160640:1.1.1.10
	cvs-200401271800:1.1.1.9
	cvs-200401261630:1.1.1.9
	cvs-200401021645:1.1.1.8
	MIRBSD_7_ALPHA:1.19.0.6
	MIRBSD_7:1.19.0.4
	cvs-200312222040:1.1.1.7
	cvs-200312031730:1.1.1.6
	MIRBSD_7ter:1.19
	MIRBSD_7_DEV:1.19.0.2
	cvs-200310020700:1.1.1.5
	cvs-200309271030:1.1.1.5
	cvs-200309251530:1.1.1.5
	cvs-200308302005:1.1.1.5
	cvs-200308221505:1.1.1.5
	cvs-200308171200:1.1.1.5
	ctm-3496:1.1.1.5
	ctm-3449:1.1.1.4
	ctm-3437:1.1.1.4
	cvs-200307191805:1.1.1.4
	ctm-3425:1.1.1.4
	cvs-200307091500:1.1.1.4
	cvs-200307072125:1.1.1.4
	ctm-3389:1.1.1.4
	cvs-200307021520:1.1.1.4
	cvs-200306291430:1.1.1.4
	ctm-3341:1.1.1.4
	MIRBSD_5:1.7
	cvs-200306082100:1.1.1.4
	ctm-3316:1.1.1.4
	ctm-3272:1.1.1.4
	ctm-3264:1.1.1.3
	cvs-200305071630:1.1.1.3
	MIRBSD_4:1.4
	ctm-3203:1.1.1.3
	cvs-20030410-1130:1.1.1.3
	ctm-3155:1.1.1.2
	ctm-3132:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.39
date	2004.11.18.16.01.49;	author tg;	state Exp;
branches;
next	1.38;

1.38
date	2004.11.18.15.53.08;	author tg;	state Exp;
branches;
next	1.37;

1.37
date	2004.11.13.18.51.38;	author tg;	state Exp;
branches;
next	1.36;

1.36
date	2004.10.22.20.08.18;	author tg;	state Exp;
branches;
next	1.35;

1.35
date	2004.10.22.19.38.02;	author tg;	state Exp;
branches;
next	1.34;

1.34
date	2004.10.14.19.50.23;	author tg;	state Exp;
branches;
next	1.33;

1.33
date	2004.06.29.14.59.58;	author tg;	state Stab;
branches;
next	1.32;

1.32
date	2004.05.23.20.48.23;	author tg;	state Exp;
branches;
next	1.31;

1.31
date	2004.05.10.16.44.00;	author tg;	state Exp;
branches;
next	1.30;

1.30
date	2004.04.29.19.57.40;	author tg;	state Exp;
branches;
next	1.29;

1.29
date	2004.04.26.18.33.33;	author tg;	state Exp;
branches;
next	1.28;

1.28
date	2004.04.26.16.59.06;	author tg;	state Exp;
branches;
next	1.27;

1.27
date	2004.04.26.16.51.50;	author tg;	state Exp;
branches;
next	1.26;

1.26
date	2004.01.27.18.42.50;	author tg;	state Exp;
branches;
next	1.25;

1.25
date	2004.01.27.17.41.37;	author tg;	state Exp;
branches;
next	1.24;

1.24
date	2004.01.03.01.25.11;	author tg;	state Exp;
branches;
next	1.23;

1.23
date	2003.12.23.13.57.48;	author tg;	state Exp;
branches;
next	1.22;

1.22
date	2003.12.23.13.55.06;	author tg;	state Exp;
branches;
next	1.21;

1.21
date	2003.12.03.21.50.58;	author tg;	state Exp;
branches;
next	1.20;

1.20
date	2003.11.19.17.31.21;	author tg;	state Exp;
branches;
next	1.19;

1.19
date	2003.10.09.14.15.51;	author tg;	state Exp;
branches;
next	1.18;

1.18
date	2003.10.08.18.04.22;	author tg;	state Exp;
branches;
next	1.17;

1.17
date	2003.10.08.15.40.02;	author tg;	state Exp;
branches;
next	1.16;

1.16
date	2003.10.07.14.07.34;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2003.10.07.13.25.13;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2003.10.06.14.57.00;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2003.10.06.14.46.38;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2003.10.05.21.17.13;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2003.10.01.16.15.58;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2003.09.02.08.45.16;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2003.08.17.08.38.26;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2003.08.16.15.19.58;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2003.05.22.14.06.13;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2003.05.17.23.02.22;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2003.05.17.20.14.28;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2003.04.10.20.10.51;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2003.03.29.21.33.32;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2003.03.23.21.47.59;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2003.03.22.17.35.20;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2003.03.22.17.35.20;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2003.03.29.19.07.33;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2003.04.10.13.56.28;	author tg;	state Exp;
branches;
next	1.1.1.4;

1.1.1.4
date	2003.05.21.18.36.43;	author tg;	state Exp;
branches;
next	1.1.1.5;

1.1.1.5
date	2003.08.11.17.46.09;	author tg;	state Exp;
branches;
next	1.1.1.6;

1.1.1.6
date	2003.12.03.17.58.23;	author tg;	state Exp;
branches;
next	1.1.1.7;

1.1.1.7
date	2003.12.22.20.23.02;	author tg;	state Exp;
branches;
next	1.1.1.8;

1.1.1.8
date	2004.01.02.17.08.22;	author tg;	state Exp;
branches;
next	1.1.1.9;

1.1.1.9
date	2004.01.26.16.55.29;	author tg;	state Exp;
branches;
next	1.1.1.10;

1.1.1.10
date	2004.05.16.07.18.04;	author tg;	state Exp;
branches;
next	;


desc
@@


1.39
log
@generate host (sendmail / httpd) key before isakmpd key
(randomness should not be too drained then already)
@
text
@#!/bin/ksh
# $MirBSD: src/etc/rc,v 1.38 2004/11/18 15:53:08 tg Exp $
# $OpenBSD: rc,v 1.258 2004/10/22 00:59:09 itojun Exp $
#-
# Copyright (c) 2003, 2004
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of covered work, even if advised of the possibility of such damage.
#-
# System startup script run by init on autoboot or after single-user.
# Output and error are redirected to console by init, and the console
# is the controlling terminal.
# This script must be run with the korn shell as /bin/sh.

# Subroutines (have to come first).

# Strip comments (and leading/trailing whitespace if IFS is set)
# from one or more file(s) given (or stdin if none) and spew to stdout
function stripcom
{
	local _line

	set -o noglob
	cat "$@@" | while read _line; do
		_line=${_line%%#*}
		[[ -n $_line ]] && echo $_line
	done
	set +o noglob
}

# Sort the "/etc/fstab" arrays:
# -> sorting is done on $_mp[] from 0 to $_fstab - 1
# -> swapping is done on $_dev[] $_mp[] $_fstype[] $_opt[] $_rest[]
function _fsswap
{
	local dev mp fstype opt rest

	dev="${_dev[$1]}"
	mp="${_mp[$1]}"
	fstype="${_fstype[$1]}"
	opt="${_opt[$1]}"
	rest="${_rest[$1]}"

	_dev[$1]="${_dev[$2]}"
	_mp[$1]="${_mp[$2]}"
	_fstype[$1]="${_fstype[$2]}"
	_opt[$1]="${_opt[$2]}"
	_rest[$1]="${_rest[$2]}"

	_dev[$2]="$dev"
	_mp[$2]="$mp"
	_fstype[$2]="$fstype"
	_opt[$2]="$opt"
	_rest[$2]="$rest"
}
function _fssort
{
	local i j k

	let i=0
	while [[ $i -lt $((_fstab-1)) ]]; do
		let j=i
		let k='i+1'
		while [[ $k -lt $_fstab ]]; do
			if [[ ${_mp[k]} < ${_mp[j]} ]]; then
				let j=k
			fi
			let k='k+1'
		done
		_fsswap $i $j
		let i='i+1'
	done
}

# End subroutines

stty status '^T'

# Set shell to ignore SIGINT (2), but not children;
# shell catches SIGQUIT (3) and returns to single user after fsck.
trap : 2
trap : 3	# shouldn't be needed

export HOME=/
export PATH=/sbin:/bin:/usr/sbin:/usr/bin

if [[ $1 == shutdown ]]; then
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 \
	    >/dev/null 2>&1
	chmod 600 /var/db/host.random >/dev/null 2>&1
	if [[ $? -eq 0 && -f /etc/rc.shutdown ]]; then
		echo /etc/rc.shutdown in progress...
		. /etc/rc.shutdown
		echo /etc/rc.shutdown complete.

		# bring carp interfaces down gracefully
		for hn in /etc/hostname.carp[0-9]*; do
			# Strip off /etc/hostname. prefix
			if=${hn#/etc/hostname.}
			test "$if" = "carp[0-9]*" && continue

			ifconfig $if >/dev/null 2>&1
			if [[ $? != 0 ]]; then
				ifconfig $if down
			fi
		done

		if [[ $powerdown == YES ]]; then
			exit 2
		fi

	else
		echo single user: not running /etc/rc.shutdown
	fi
	exit 0
fi

# Configure ccd devices.
if [[ -f /etc/ccd.conf ]]; then
	ccdconfig -C
fi

# Configure raid devices.
for dev in 0 1 2 3 4 5 6 7; do
	if [[ -f /etc/raid${dev}.conf ]]; then
		raidctl -c /etc/raid${dev}.conf raid$dev
	fi
done

# Check parity on raid devices.
raidctl -P all

swapctl -A -t blk

# pick up configuration options
. /etc/rc.conf

# Read /etc/fstab into arrays and sort by mountpoint
# Must use a co-process because pipes are executed in a subshell in pdksh
let _fstab=0
stripcom /etc/fstab |&
while read -p _fdev _fmp _ffstype _fopt _frest; do
	_dev[_fstab]="$_fdev"
	_mp[_fstab]="$_fmp"
	_fstype[_fstab]="$_ffstype"
	_opt[_fstab]="${_fopt:-rw}"
	_rest[_fstab]="$_frest"
	let _fstab='_fstab+1'
done
_fssort

# Examine the filesystems whether there are IDE drives
let i=0
[[ $softdrives_ide = NO ]] && softdrives_ide=""
while [[ $i -lt $_fstab ]]; do
	case "${_dev[i]}" {
	  /dev/wd+([0-9])[a-p])
		_fdev="${_dev[i]#/dev/}"
		softdrives_ide="$softdrives_ide ${_fdev%[a-p]}"
		;;
	  *)	;;
	}
	let i='i+1'
done

# Needed for softdep to work correctly (SCSI drives, too!)
if [[ -n $softdrives_ide ]]; then
	echo -n "Disabling HDD hardware write caches..."
	_flags=""
	set -o noglob
	for drv in $softdrives_ide; do
		case "$_flags" {
			*${drv}*)
				;;	# Already done
			*)
				echo -n " $drv"
				/sbin/atactl /dev/r${drv}c writecachedisable \
				    >/dev/null 2>&1 || echo -n !
				_flags="$_flags $drv"
				;;
		}
	done
	set +o noglob
	echo .
fi

# Check filesystems
if [[ -e /fastboot ]]; then
	echo "Fast boot: skipping disk checks."
  elif [[ $1 == autoboot ]]; then
	echo "Automatic boot in progress: starting file system checks."
	fsck -p
	case $? {
	  0)
		;;
	  2)
		exit 1
		;;
	  4)
		echo "Rebooting..."
		reboot
		echo "Reboot failed; help!"
		exit 1
		;;
	  8)
		echo "Automatic file system check failed; help!"
		exit 1
		;;
	  12)
		echo "Boot interrupted."
		exit 1
		;;
	  130)
		# interrupt before catcher installed
		exit 1
		;;
	  *)
		echo "Unknown error; help!"
		exit 1
		;;
	}
fi

trap "echo 'Boot interrupted.'; exit 1" 3

umount -a >/dev/null 2>&1
let i=0
while [[ $i -lt $_fstab ]]; do
	if [[ ${_mp[i]} == / ]]; then
		mount -uwo "${_opt[i]}" "${_dev[i]}" / >/dev/null 2>&1
		if [[ $? -ne 0 ]]; then
			case "${_opt[i]}" {
			  *softdep*)	;;
			  *)	echo -n 'WARNING: Your root filesystem failed'
				echo -n ' to remount read-write! <forcing...>'
				echo 'The system is probably severely damaged'
				;;
			}
			mount -ufwo "${_opt[i]}" "${_dev[i]}" /
		fi
	  else
		case "${_opt[i]}" {
		  *noauto*)	;;
		  sw*)		;;	# Swap
		  xx*)		;;	# ignore totally
		  *)	if [[ ${_fstype[i]} == ffs ]]; then
				mount -t ffs -o "${_opt[i]}" "${_dev[i]}" \
					"${_mp[i]}" >/dev/null 2>&1
				if [[ $? -ne 0 ]]; then
					case "${_opt[i]}" {
					  *softdep*)	;;
					  *)	echo -n "Warning: force-mounti"
						echo -n "ng unchecked ffs file"
						echo -n "system: ${_dev[i]}"
						echo " -> ${_mp[i]}  nosoftdep"
						;;
					}
					mount -f -t ffs -o "${_opt[i]}" \
					    "${_dev[i]}" "${_mp[i]}"
				fi
			  else
				mount -t "${_fstype[i]}" -o "${_opt[i]}" \
				    "${_dev[i]}" "${_mp[i]}"
			fi
			;;
		}
	fi
	let i='i+1'
done
mount -a -t nonfs
rm -f /fastboot

# set flags on ttys.  (do early, in case they use tty for SLIP in netstart)
echo 'setting tty flags'
ttyflags -a

if [[ -f /sbin/kbd && -f /etc/kbdtype ]]; then
	[[ -f /etc/wsconsctl.conf ]] && \
	    echo "warning: better use wsconsctl.conf instead of /etc/kbdtype!"
	kbd $(</etc/kbdtype)
fi

if [[ $pf != NO ]]; then
	RULES="block all"
	RULES="$RULES\npass on lo0"
	RULES="$RULES\npass in proto tcp from any to any port 22 keep state"
	RULES="$RULES\npass out proto { tcp, udp } from any to any port 53 keep state"
	RULES="$RULES\npass out inet proto icmp all icmp-type echoreq keep state"
	if ifconfig lo0 inet6 >/dev/null 2>&1; then
		RULES="$RULES\npass out inet6 proto icmp6 all icmp6-type neighbrsol"
		RULES="$RULES\npass in inet6 proto icmp6 all icmp6-type neighbradv"
		RULES="$RULES\npass out inet6 proto icmp6 all icmp6-type routersol"
		RULES="$RULES\npass in inet6 proto icmp6 all icmp6-type routeradv"
	fi
	RULES="$RULES\npass proto { pfsync, carp }"
	case $(sysctl vfs.mounts.nfs 2>/dev/null) in
	*[1-9]*)
		# don't kill NFS
		RULES="scrub in all no-df\n$RULES"
		RULES="$RULES\npass in proto udp from any port { 111, 2049 } to any"
		RULES="$RULES\npass out proto udp from any to any port { 111, 2049 }"
		;;
	esac
	echo $RULES | pfctl -f - -e
fi

if [[ -f /etc/sysctl.conf ]]; then
(
	# delete comments and blank lines
	set -- $(stripcom /etc/sysctl.conf)
	while [[ $# -ge 1 ]]; do
		sysctl $1
		shift
	done
)
fi

# set hostname, turn on network
echo 'starting network'
. /etc/netstart

# load arp tables
if [[ $arptables == YES && -e /etc/arp.conf ]]; then
	echo 'Setting static ARP table entries'
	/usr/sbin/arp -f /etc/arp.conf
fi

if [[ $pf != NO ]]; then
	if [[ -f $pf_rules ]]; then
		pfctl -f "$pf_rules"
	fi
fi

mount /usr >/dev/null 2>&1
mount /var >/dev/null 2>&1

# read in old random seed; if there's no /var/db/host.random, make
# one through /dev/urandom; else reset seed file anyways, so that
# if a shutdown-less reboot occurs, the next seed is not a repeat
[[ -f /var/db/host.random ]] && cat /var/db/host.random >/dev/arandom
dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 \
    >/dev/null 2>&1
chmod 600 /var/db/host.random >/dev/null 2>&1

# clean up left-over files
rm -f /etc/nologin
rm -f /var/spool/lock/LCK.*
rm -f /var/spool/uucp/STST/*
(cd /var/run && { rm -rf -- *; install -c -m 664 -g utmp /dev/null utmp; })
(cd /var/authpf && rm -rf -- *)

# save a copy of the boot messages
dmesg >/var/run/dmesg.boot

echo 'starting system logger'
rm -f /dev/log
if [[ -d /var/empty ]]; then
	rm -f /var/empty/dev/log
	mkdir -p -m 0555 /var/empty/dev
	syslogd_flags="$syslogd_flags -a /var/empty/dev/log"
fi
syslogd $syslogd_flags

if [[ $pf != NO && $pflogd_flags != NO ]]; then
	ifconfig pflog0 up
	pflogd $pflogd_flags
fi

# $isakmpd_flags is imported from /etc/rc.conf;
# If $isakmpd_flags == NO, isakmpd isn't run.
if [[ $isakmpd_flags != NO ]]; then
	echo 'starting isakmpd';	isakmpd $isakmpd_flags
fi

echo -n 'starting rpc daemons:'

# $portmap is imported from /etc/rc.conf;
# if $portmap == YES, the portmapper is started.
if [[ $portmap == YES ]]; then
	echo -n ' portmap';		portmap
  else
	nfs_server=NO
fi

# $nfs_server is imported from /etc/rc.conf;
# if $nfs_server == YES, the machine is setup for being an nfs server
if [[ $nfs_server == YES && -s /etc/exports && \
    $(sed -e '/^#/d' </etc/exports | wc -l) -ne 0 ]]; then
	rm -f /var/db/mountdtab
	echo -n >/var/db/mountdtab
	echo -n ' mountd';		mountd
	echo -n ' nfsd';		nfsd $nfsd_flags
	if [[ $lockd == YES ]]; then
		echo -n ' rpc.lockd';	rpc.lockd
	fi
fi

# run rdate before timed/ntpd
if [[ $rdate_flags != NO ]]; then
	echo -n ' rdate';		rdate -s $rdate_flags
fi

# $timed_flags is imported from /etc/rc.conf;
# if $timed_flags == NO, timed isn't run.
if [[ $timed_flags != NO ]]; then
	echo -n ' timed';		timed $timed_flags
fi

# run ntpd if asked for; set time once (at startup) via settimeofday(2)
if [[ $ntpd_flags != NO ]]; then
	echo -n ' ntpd';		ntpd -s $ntpd_flags
fi

echo '.'

mount -a -t nfs

swapctl -A -t noblk

# /var/crash should be a directory or a symbolic link
# to the crash directory if core dumps are to be saved.
if [[ -d /var/crash ]]; then
	savecore ${savecore_flags} /var/crash
fi

if [[ $check_quotas == YES ]]; then
	echo -n 'checking quotas:'
	quotacheck -a
	echo ' done.'
	quotaon -a
fi

# build ps databases
echo -n 'building ps databases:'
echo -n " kvm"
kvm_mkdb
echo -n " dev"
dev_mkdb
echo "."

chmod 666 /dev/tty[pqrstuvwxyzPQRST]*
chown root:wheel /dev/tty[pqrstuvwxyzPQRST]*

# check the password temp/lock file
if [[ -f /etc/ptmp ]]; then
	logger -s -p auth.err \
	'password file may be incorrect -- /etc/ptmp exists'
fi

echo clearing /tmp

if mount 2>&1 | grep -F "on /tmp" >/dev/null 2>&1; then
	# prune quickly with one rm, then use find to clean up /tmp/[lq]*
	# (not needed with mfs /tmp, but doesn't hurt there...)
	(cd /tmp && rm -rf [a-km-pr-zA-Z]* &&
	    find . ! -name . ! -name lost+found ! -name quota.user \
		! -name quota.group -execdir rm -rf -- {} \; -type d -prune)
  else
	# clean up as usual on small systems
	rm -rf /tmp
	mkdir /tmp
	chown 0:0 /tmp
	chmod 01777 /tmp
fi

# create Unix sockets directories for X if needed and make sure they have
# correct permissions
if [[ -d /usr/X11R6/lib ]]; then
	for d in /tmp/.X11-unix /tmp/.ICE-unix; do
		if [[ -d $d ]]; then
			if [[ $(ls -ld $d | cut -d' ' -f4) != root ]]; then
				chown root $d
			fi
			if [[ $(ls -ld $d | cut -d' ' -f1) != drwxrwxrwt ]]; then
				chmod 1777 $d
			fi
		  elif [[ -e $d ]]; then
			echo "Error: $d exists and isn't a directory."
		  else
			mkdir -m 1777 $d
		fi
	done
fi

[[ -f /etc/rc.securelevel ]] && . /etc/rc.securelevel
if [[ -n $securelevel ]]; then
	echo -n 'setting kernel security level: '
	sysctl kern.securelevel=${securelevel}
fi

# patch /etc/motd
if [[ ! -f /etc/motd ]]; then
	install -c -o root -g wheel -m 664 /dev/null /etc/motd
fi
T=$(mktemp /tmp/_motd.XXXXXXXXXX)
if [[ $? -eq 0 ]]; then
	sysctl -n kern.version | sed 1q >$T
	echo "" >>$T
	sed '1,/^$/d' </etc/motd >>$T
	cmp -s $T /etc/motd || cp $T /etc/motd
	rm -f $T
  else
	echo 'warning: mktemp(1) failed. Please check for possible reasons.'
fi

if [[ -f /var/account/acct ]]; then
	echo 'turning on accounting';	accton /var/account/acct
fi

if [[ -f /sbin/ldconfig ]]; then
	echo 'creating runtime link editor directory cache.'
	if [[ -d /usr/local/lib ]]; then
		shlib_dirs="/usr/local/lib $shlib_dirs"
	fi
	if [[ -d /usr/X11R6/lib ]]; then
		shlib_dirs="/usr/X11R6/lib $shlib_dirs"
	fi
	ldconfig $shlib_dirs
fi

if [[ -x /usr/libexec/vi.recover && -e /var/tmp/vi.recover ]]; then
	echo 'preserving editor files';	/usr/libexec/vi.recover
fi

if [[ ! -f /etc/ssh/ssh_host_rsa_key ]]; then
	echo -n "ssh-keygen: generating new RSA host key... "
	if /usr/bin/ssh-keygen -q -t rsa -f /etc/ssh/ssh_host_rsa_key \
	    -N ''; then
		echo done.
	  else
		echo failed.
	fi
fi

if [[ -d /var/anoncvs/anoncvs && -f /var/anoncvs/anoncvssh \
    && ! -e /var/anoncvs/anoncvs/dev/null ]]; then
	# Copy over /dev/null into anoncvs chroot, it needs it
	(cd /dev; tar cf - null) | (cd /var/anoncvs/anoncvs/dev; tar xpf -)
fi

if [[ ! -f /etc/ssl/private/default.key \
    || ! -f /etc/ssl/default.cer \
    || ! -f /etc/ssl/deflt-ca.cer ]]; then
	echo -n "openssl: generating new host RSA key... "
	rm -f /etc/ssl/{def{ault,lt-ca}.cer,private/default.key}
	if /usr/sbin/openssl genrsa -out /etc/ssl/private/default.key 1024 \
	    >/dev/null 2>&1; then
		chmod 600 /etc/ssl/private/default.key
		/usr/sbin/openssl req -batch -new -subj "/CN=$(hostname)/" \
		    -key /etc/ssl/private/default.key \
		    -x509 -out /etc/ssl/default.cer
		chmod 644 /etc/ssl/default.cer
		ln /etc/ssl/default.cer /etc/ssl/deflt-ca.cer
		echo done.
	else
		echo failed.
	fi
fi

if [[ ! -f /etc/isakmpd/private/local.key ]]; then
	echo -n "openssl: generating new isakmpd RSA key... "
	if /usr/sbin/openssl genrsa -out /etc/isakmpd/private/local.key 1024 \
	    >/dev/null 2>&1; then
		chmod 600 /etc/isakmpd/private/local.key
		/usr/sbin/openssl rsa -out /etc/isakmpd/private/local.pub \
		    -in /etc/isakmpd/private/local.key -pubout >/dev/null 2>&1
		echo done.
	else
		echo failed.
	fi
fi

echo -n starting network daemons:

# $routed_flags are imported from /etc/rc.conf.
# If $routed_flags == NO, routed isn't run.
if [[ $routed_flags != NO ]]; then
	echo -n ' routed';		routed $routed_flags
fi

# $mrouted_flags is imported from /etc/rc.conf;
# If $mrouted_flags == NO, then mrouted isn't run.
if [[ $mrouted_flags != NO ]]; then
	echo -n ' mrouted';		mrouted $mrouted_flags
fi

if [[ $bgpd_flags != NO ]]; then
	echo -n ' bgpd';		/usr/sbin/bgpd $bgpd_flags
fi

# $dhcpd_flags is imported from /etc/rc.conf
# If $dhcpd_flags == NO or /etc/dhcpd.conf doesn't exist, then dhcpd isn't run.
if [[ $dhcpd_flags != NO && -f /etc/dhcpd.conf ]]; then
	touch /var/db/dhcpd.leases
	if [[ -f /etc/dhcpd.interfaces ]]; then
		dhcpd_ifs=$(stripcom /etc/dhcpd.interfaces)
	fi
	_flags="$dhcpd_flags $dhcpd_ifs"
	echo -n ' dhcpd';		/usr/sbin/dhcpd $_flags
fi

if ifconfig lo0 inet6 >/dev/null 2>&1; then
	fw=$(sysctl -n net.inet6.ip6.forwarding)
	if [[ $fw == 0 ]]; then
		# $rtsold_flags is imported from /etc/rc.conf;
		# If $rtsold_flags == NO, then rtsold isn't run.
		if [[ $rtsold_flags != NO ]]; then
			echo -n ' rtsold'
			/usr/sbin/rtsold $rtsold_flags
		fi
	  else
		# $route6d_flags is imported from /etc/rc.conf;
		# If $route6d_flags == NO, then route6d isn't run.
		if [[ $route6d_flags != NO ]]; then
			echo -n ' route6d'
			/usr/sbin/route6d $route6d_flags
		fi
		# $rtadvd_flags is imported from /etc/rc.conf;
		# If $rtadvd_flags == NO, then rtadvd isn't run.
		if [[ $rtadvd_flags != NO ]]; then
			echo -n ' rtadvd'
			/usr/sbin/rtadvd $rtadvd_flags
		fi
	fi
fi

# $rwhod is imported from /etc/rc.conf;
# if $rwhod == YES, rwhod is run.
if [[ $rwhod == YES ]]; then
	echo -n ' rwhod';		rwhod
fi


if [[ $lpd_flags != NO ]]; then
	echo -n ' printer';		lpd $lpd_flags
fi

# $sendmail_flags is imported from /etc/rc.conf;
# If $sendmail_flags == NO or /etc/mailer.conf doesn't exist, then
# sendmail isn't run.  We call sendmail with a full path so that
# SIGHUP works.  Note that /usr/sbin/sendmail may actually call a
# mailer other than sendmail, depending on /etc/mailer.conf.
if [[ $sendmail_flags != NO && -s /etc/mailer.conf ]]; then
	echo -n ' sendmail'
	( /usr/sbin/sendmail $sendmail_flags >/dev/null 2>&1 & )
fi

if [[ $httpd_flags != NO ]]; then
	# Clean up left-over httpd locks
	rm -f /var/www/logs/{ssl_mutex,httpd.lock,accept.lock}.*
	echo -n ' httpd';		/usr/sbin/httpd $httpd_flags
fi

if [[ $ftpd_flags != NO ]]; then
	echo -n ' ftpd';		/usr/libexec/ftpd $ftpd_flags
fi

if [[ $identd_flags != NO ]]; then
	echo -n ' identd';		/usr/libexec/identd $identd_flags
fi

if [[ $inetd == YES && -e /etc/inetd.conf ]]; then
	echo -n ' inetd';		inetd
fi

if [[ $sshd_flags != NO ]]; then
	echo -n ' sshd';		/usr/sbin/sshd ${sshd_flags};
fi

if [[ $spamd_flags != NO ]]; then
	if [[ $spamd_grey != NO ]]; then
		spamd_flags="${spamd_flags} -g"
	fi
	echo -n ' spamd';		eval /usr/libexec/spamd ${spamd_flags}
	/usr/libexec/spamd-setup
	if [[ $spamd_grey != NO ]]; then
		echo -n ' spamlogd'
		/usr/libexec/spamlogd
	fi
fi

# $rarpd_flags is imported from /etc/rc.conf;
# If $rarpd_flags == NO or /etc/ethers doesn't exist, then
# rarpd isn't run.
if [[ $rarpd_flags != NO && -s /etc/ethers ]]; then
	echo -n ' rarpd';		rarpd $rarpd_flags
fi

# $bootparamd_flags is imported from /etc/rc.conf;
# If $bootparamd_flags == NO or /etc/bootparams doesn't exist, then
# bootparamd isn't run.
if [[ $bootparamd_flags != NO && -s /etc/bootparams ]]; then
	echo -n ' rpc.bootparamd';	rpc.bootparamd $bootparamd_flags
fi

# $rbootd_flags is imported from /etc/rc.conf;
# If $rbootd_flags == NO or /etc/rbootd.conf doesn't exist, then
# rbootd isn't run.
if [[ $rbootd_flags != NO && -s /etc/rbootd.conf ]]; then
	echo -n ' rbootd';		rbootd $rbootd_flags
fi

if [[ $isdnd_flags != NO ]]; then
	echo -n ' isdnd';		/usr/sbin/isdnd $isdnd_flags
fi

echo '.'

if [[ $sshagent_autostart != NO ]]; then
	echo 'Setting up ssh-agent directories...'
	mkdir -m 0755 /tmp/.ssh-agent
	chown root:daemon /tmp/.ssh-agent
	for luser in $sshagent_autostart; do
		mkdir -m 0700 /tmp/.ssh-agent/$luser
		chown $luser /tmp/.ssh-agent/$luser
		rm -f /tmp/.ssh-agent/$luser/agent
	done
fi

if [[ -x /sbin/wsconsctl && -f /etc/wsconsctl.conf ]]; then
(
	# delete comments and blank lines
	save_IFS="$IFS"
	IFS="
"
	set -- $(stripcom /etc/wsconsctl.conf)
	IFS="$save_IFS"
	while [[ $# -ge 1 ]]; do
		eval /sbin/wsconsctl -w $1
		shift
	done
)
fi

[[ -f /etc/rc.local ]] && . /etc/rc.local

echo -n standard daemons:

# $apmd_flags is imported from /etc/rc.conf;
# don't run daemon if $apmd_flags == NO or /usr/sbin/apmd doesn't exist
if [[ $apmd_flags != NO && -x /usr/sbin/apmd ]]; then
	echo -n ' apmd';	/usr/sbin/apmd $apmd_flags
fi

if [[ $sensorsd_flags != NO ]]; then
	echo -n ' sensorsd';	/usr/sbin/sensorsd ${sensorsd_flags}
fi

if [[ $hotplugd_flags != NO && -x /usr/sbin/hotplugd ]]; then
	echo -n ' hotplugd';	/usr/sbin/hotplugd ${hotplugd_flags}
fi

echo -n ' cron';		cron

echo '.'

date

if [[ $wsmoused_flags != NO && -x /usr/sbin/wsmoused ]]; then
	echo 'starting wsmoused...';	/usr/sbin/wsmoused $wsmoused_flags
fi

# Alternatively, on some architectures, xdm may be started in /etc/ttys.
if [[ $xdm_flags != NO ]]; then
	echo 'starting xdm...';		/usr/X11R6/bin/xdm $xdm_flags
fi

exit 0
@


1.38
log
@fix default sendmail and httpd operation
@
text
@d2 1
a2 1
# $MirBSD: src/etc/rc,v 1.37 2004/11/13 18:51:38 tg Exp $
a553 13
if [[ ! -f /etc/isakmpd/private/local.key ]]; then
	echo -n "openssl: generating new isakmpd RSA key... "
	if /usr/sbin/openssl genrsa -out /etc/isakmpd/private/local.key 1024 \
	    >/dev/null 2>&1; then
		chmod 600 /etc/isakmpd/private/local.key
		/usr/sbin/openssl rsa -out /etc/isakmpd/private/local.pub \
		    -in /etc/isakmpd/private/local.key -pubout >/dev/null 2>&1
		echo done.
	else
		echo failed.
	fi
fi

d557 1
a557 1
	echo -n "openssl: generating new sendmail RSA key... "
d567 13
@


1.37
log
@move sendmail certs to /etc/ssl/ and more sensible locations/names
@
text
@d2 1
a2 1
# $MirBSD: src/etc/rc,v 1.36 2004/10/22 20:08:18 tg Exp $
d567 3
a569 3
if [[ ! -f /etc/ssl/private/sendmail.key \
    || ! -f /etc/ssl/sendmail.cer \
    || ! -f /etc/ssl/sendmail-ca.cer ]]; then
d571 2
a572 2
	rm -f /etc/ssl/{sendmail{,-ca}.cer,private/sendmail.key}
	if /usr/sbin/openssl genrsa -out /etc/ssl/private/sendmail.key 1024 \
d574 1
a574 1
		chmod 600 /etc/ssl/private/sendmail.key
d576 4
a579 4
		    -key /etc/ssl/private/sendmail.key \
		    -x509 -out /etc/ssl/sendmail.cer
		chmod 644 /etc/ssl/sendmail.cer
		ln /etc/ssl/sendmail.cer /etc/ssl/sendmail-ca.cer
@


1.36
log
@generate sendmail key at first boot, like the others
so that Damien Miller can't laugh at me any more
@
text
@d2 1
a2 1
# $MirBSD: src/etc/rc,v 1.35 2004/10/22 19:38:02 tg Exp $
d567 3
a569 3
if [[ ! -f /etc/mail/private/sendmail.key \
    || ! -f /etc/mail/private/sendmail.cer \
    || ! -f /etc/mail/private/my-ca.cer ]]; then
d571 2
a572 2
	rm -f /etc/mail/private/{sendmail.{ker,cey},my-ca.cer}
	if /usr/sbin/openssl genrsa -out /etc/mail/private/sendmail.key 1024 \
d574 1
a574 1
		chmod 600 /etc/mail/private/sendmail.key
d576 4
a579 4
		    -key /etc/mail/private/sendmail.key \
		    -x509 -out /etc/mail/private/sendmail.cer
		chmod 644 /etc/mail/private/sendmail.cer
		ln /etc/mail/private/sendmail.cer /etc/mail/private/my-ca.cer
@


1.35
log
@merge stuff from current OpenBSD
@
text
@d2 1
a2 1
# $MirBSD: src/etc/rc,v 1.34 2004/10/14 19:50:23 tg Exp $
d115 1
a115 1
			ifconfig $if > /dev/null 2>&1
d557 1
a557 1
	    > /dev/null 2>&1; then
d559 21
a579 2
		openssl rsa -out /etc/isakmpd/private/local.pub \
		    -in /etc/isakmpd/private/local.key -pubout > /dev/null 2>&1
@


1.34
log
@add sample ntpd.conf
add ntpd_flags to rc/rc.conf
@
text
@d2 2
a3 2
# $MirBSD: src/etc/rc,v 1.33 2004/06/29 14:59:58 tg Stab $
# $OpenBSD: rc,v 1.246 2004/05/16 04:31:01 mcbride Exp $
d290 6
d302 6
d362 1
a362 6
(cd /var/run && { \
	test -r dhclient.pid && dhclient_pid="$(<dhclient.pid)"; \
	rm -rf -- *; \
	test -e /usr/dynamic && ldconfig /usr/dynamic; \
	install -c -m 664 -g utmp /dev/null utmp; \
	test -n "$dhclient_pid" && echo "$dhclient_pid" >dhclient.pid; })
a364 1

d383 2
a384 3
# If $isakmpd_flags == NO or /etc/isakmpd/isakmpd.policy doesn't exist, then
# isakmpd isn't run.
if [[ $isakmpd_flags != NO && -e /etc/isakmpd/isakmpd.policy ]]; then
a728 6
if [[ -f /sbin/kbd && -f /etc/kbdtype ]]; then
	[[ -f /etc/wsconsctl.conf ]] && \
	    echo "warning: better use wsconsctl.conf instead of kbdtype!"
	kbd $(</etc/kbdtype)
fi

d741 4
@


1.33
log
@d'oh, esac not }
found by screenyfs (Felix Scholz) via IRC
@
text
@d2 1
a2 1
# $MirBSD: src/etc/rc,v 1.32 2004/05/23 20:48:23 tg Exp $
d6 1
a6 1
#	Thorsten Glaser <x86@@ePost.de>
d9 5
a13 5
# tion, including unlimited rights to use, publically perform, modi-
# fy, merge, distribute, sell, give away or sublicence, provided the
# above copyright notices, these terms and the disclaimer are retai-
# ned in all redistributions, or reproduced in accompanying documen-
# tation or other materials provided with binary redistributions.
d18 4
a21 4
# licious intent or gross negligence; in no event shall an author or
# contributor be held liable for any direct, indirect or other dama-
# ge, however caused, arising in any way out of the usage of covered
# work, even if advised of the possibility of such damage.
d406 1
a406 1
# run rdate before timed
d416 6
@


1.32
log
@first soft attempt to merge
add learn dirs to mtree
@
text
@d2 1
a2 1
# $MirBSD: src/etc/rc,v 1.31 2004/05/10 16:44:00 tg Exp $
d304 1
a304 1
	}
@


1.31
log
@don't write /var/db/host.random _twice_ at power-up... *sigh*
@
text
@d2 2
a3 2
# $MirBSD: src/etc/rc,v 1.30 2004/04/29 19:57:40 tg Exp $
# $OpenBSD: rc,v 1.232 2004/01/23 22:11:40 deraadt Exp $
d6 1
a6 1
#	Thorsten "mirabile" Glaser <x86@@ePost.de>
d8 6
a13 6
# Subject to these terms, everybody who obtained a copy of this work
# is hereby permitted to deal in the work without restriction inclu-
# ding without limitation the rights to use, distribute, sell, modi-
# fy, publically perform, give away, merge or sublicence it provided
# this notice is kept and the authors and contributors are given due
# credit in derivates or accompanying documents.
d15 7
a21 6
# This work is provided by its developers (authors and contributors)
# "as is" and without any warranties whatsoever, express or implied,
# to the maximum extent permitted by applicable law; in no event may
# developers be held liable for damage caused, directly or indirect-
# ly, but not by a developer's malice intent, even if advised of the
# possibility of such damage.
d108 13
d124 2
a125 1
	  else
d296 3
a298 2
	case $(sysctl vfs.mounts.nfs 2>/dev/null) {
	  *[1-9]*)
d313 1
a313 1
		sysctl -w $1
d425 1
a425 1
	savecore $savecore_flags /var/crash
d490 1
a490 1
	sysctl -w "kern.securelevel=$securelevel"
d543 13
d570 4
a630 5
if [[ $spamd_flags != NO ]]; then
	echo -n ' spamd';		/usr/libexec/spamd $spamd_flags
	/usr/libexec/spamd-setup
fi

d649 16
a683 11
fi

# $mopd_flags is imported from /etc/rc.conf;
# If $mopd_flags == NO or /tftpboot/mop doesn't exist, then
# mopd isn't run.
if [[ $mopd_flags != NO && -d /tftpboot/mop ]]; then
	echo -n ' mopd';		mopd $mopd_flags
fi

if [[ $sshd_flags != NO ]]; then
	echo -n ' sshd';		/usr/sbin/sshd $sshd_flags
@


1.30
log
@don't read the HDD at startup; it's said to be bad to the entropy level
@
text
@d2 1
a2 1
# $MirBSD: src/etc/rc,v 1.29 2004/04/26 18:33:33 tg Exp $
d322 4
a325 12
# if there's no /var/db/host.random, make one through /dev/urandom
if [[ ! -f /var/db/host.random ]]; then
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 \
		>/dev/null 2>&1
	chmod 600 /var/db/host.random >/dev/null 2>&1
  else
	dd if=/var/db/host.random of=/dev/arandom bs=1024 count=64 \
	    >/dev/null 2>&1
fi

# reset seed file, so that if a shutdown-less reboot occurs,
# the next seed is not a repeat
d328 1
@


1.29
log
@oops... missing a ) can land you in single user
mode way quicker than you thought
@
text
@d2 2
a3 2
#	$MirBSD: src/etc/rc,v 1.28 2004/04/26 16:59:06 tg Exp $
#	$OpenBSD: rc,v 1.232 2004/01/23 22:11:40 deraadt Exp $
d5 2
a6 2
# Copyright (c) 2003
#	Thorsten Glaser <x86@@ePost.de> for the MirOS Project
d15 6
a20 5
# This work is provided "as is" with no explicit or implicit warran-
# ties whatsoever to the maximum extent permitted by applicable law;
# in no event may an author or contributor be held liable for damage
# that is, directly or indirectly, caused by the work, even if advi-
# sed of the possibility of such damage.
a320 5

# add some information from the HD to the random pool
i=$(sysctl -n kern.root_device)
dd if=/dev/r${i%[a-p]}c count=126 >/dev/urandom 2>&1
echo "$RANDOM $(find /var/spool /var/run 2>&1)" >/dev/urandom
@


1.28
log
@* improve dd command output usage (error message gets seeded too)
* add the same HDD read, just not for the root disk, but for
  wd0 and sd0, to the ramdisk (it doesn't matter if they fail)
@
text
@d2 1
a2 1
#	$MirBSD: src/etc/rc,v 1.27 2004/04/26 16:51:50 tg Exp $
d324 1
a324 1
echo "$RANDOM $(find /var/spool /var/run 2>&1" >/dev/urandom
@


1.27
log
@* don't seed /dev/urandom with the same data as /dev/arandom;
  rather, don't seed it at all (seeding arandom is the same as
  seeding urandom and stirring arandom afterwards) instead
* read in some transient information from the HDD on boot
  (at this point, the random pool already contains bits, so
  the information shouldn't be unsafe)
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.26 2004/01/27 18:42:50 tg Exp $
d323 1
a323 1
dd if=/dev/r${i%[a-p]}c count=126 of=/dev/urandom >/dev/null 2>&1
@


1.26
log
@ignore swap and xx filesystems...
reduces warnings on HERC boots
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.25 2004/01/27 17:41:37 tg Exp $
d321 5
a331 2
	dd if=/var/db/host.random of=/dev/urandom bs=1024 count=64 \
	    >/dev/null 2>&1
@


1.25
log
@first part of mergeing OpenBSD and fixing whitespace and RCS IDs
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.24 2004/01/03 01:25:11 tg Exp $
d241 2
@


1.24
log
@merge OpenBSD
@
text
@d2 2
a3 2
#	$MirBSD: rc,v 1.23 2003/12/23 13:57:48 tg Exp $
#	$OpenBSD: rc,v 1.231 2003/12/29 23:16:45 millert Exp $
d380 1
a380 1
	nfs_server=NO			# No NFS without portmapper
@


1.23
log
@spaces
@
text
@d2 2
a3 2
#	$MirBSD: rc,v 1.22 2003/12/23 13:55:06 tg Exp $
#	$OpenBSD: rc,v 1.230 2003/12/05 00:52:16 deraadt Exp $
d692 2
@


1.22
log
@attempt to merge
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.21 2003/12/03 21:50:58 tg Exp $
d702 1
a702 1
        echo -n ' apmd';        /usr/sbin/apmd $apmd_flags
@


1.21
log
@merge cvs import, etc.
@
text
@d2 2
a3 2
#	$MirBSD: rc,v 1.20 2003/11/19 17:31:21 tg Exp $
#	$OpenBSD: rc,v 1.229 2003/11/18 16:37:34 henning Exp $
d5 2
a6 1
# Copyright (c) 2003 Thorsten Glaser <x86@@ePost.de>
d11 1
a11 1
# fy, publically perform, give away, merge or sublicense it provided
d14 1
d16 1
a16 1
# ties whatsoever to the maximum extend permitted by applicable law;
d398 1
a398 1
        echo -n ' rdate';		rdate -s $rdate_flags
@


1.20
log
@sshd will use only RSAv2 by default from now on
document that in afterboot
while there, adjust afterboot for .Mx BSD
and implement .Mx BSD and .Mx Linux :)
@
text
@d2 2
a3 2
#	$MirBSD: rc,v 1.19 2003/10/09 14:15:51 tg Exp $
#	$OpenBSD: rc,v 1.228 2003/07/29 17:52:17 henning Exp $
d701 4
@


1.19
log
@oh why oh why...
using stripcom, the input of 'while read...' was fed from a pipe.
this means, in pdksh, it's executed in a subshell.
this means: the array vanished as soon as the loop exits.

fix: use a co-process.

This time: TESTED! (yes, here at least)
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.18 2003/10/08 18:04:22 tg Exp $
a514 9
if [[ ! -f /etc/ssh/ssh_host_dsa_key ]]; then
	echo -n "ssh-keygen: generating new DSA host key... "
	if /usr/bin/ssh-keygen -q -t dsa -f /etc/ssh/ssh_host_dsa_key \
	    -N ''; then
		echo done.
	  else
		echo failed.
	fi
fi
a517 9
	    -N ''; then
		echo done.
	  else
		echo failed.
	fi
fi
if [[ ! -f /etc/ssh/ssh_host_key ]]; then
	echo -n "ssh-keygen: generating new RSA1 host key... "
	if /usr/bin/ssh-keygen -q -t rsa1 -f /etc/ssh/ssh_host_key \
@


1.18
log
@Synchronize functions in rc and profile
Some minor clean-up and limit upping
Use less as pager, not more
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.17 2003/10/08 15:40:02 tg Exp $
d134 1
d136 2
a137 1
stripcom /etc/fstab | while read _fdev _fmp _ffstype _fopt _frest; do
@


1.17
log
@``>Warning: force-mounting unchecked ffs filesystem: #/dev/wd0f -> /usr/obj´´
Reported From: Teh Kok How <khteh@@willowglen.com.my>

Fix: run stripcom on /etc/fstab before reading it in *d'oh*.

This change will be MFCd, but the tarballs will not be updated any more.
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.16 2003/10/07 14:07:34 tg Exp $
d119 1
a119 1
for dev in 0 1 2 3; do
d165 1
a165 1
		case "$_flags" {	# Duplicated but safer here
@


1.16
log
@Fix at least five different errors and three style nits.
Tested on my main development machine before it should have
become a disaster. Reviewed by Jupp Söntgen <cnuke@@66h.42h.de>

Will be MFCd.
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.15 2003/10/07 13:25:13 tg Exp $
d135 1
a135 1
while read _fdev _fmp _ffstype _fopt _frest; do
d142 1
a142 1
done </etc/fstab
@


1.15
log
@/etc/rc isn't my friend for this release.
Noticed these From: Teh Kok How <khteh@@willowglen.com.my>
	/etc/rc[217]: _fsdump: not found
	/etc/rc[219]: _fsdump: not found

(leftovers from debugging, nuked)

	/etc/rc[241]: syntax error: ase' unmatched

(now line 239 - replaced case foo in...esac by case foo {...}
 wonder if that'll fix it.)

If test succeeds, will (have to) MFC.
@
text
@d1 2
a2 2
e#!/bin/ksh
#	$MirBSD: rc,v 1.14 2003/10/06 14:57:00 tg Exp $
d27 1
a27 1
# from a file and spew to stdout
d45 1
a45 5
	local dev
	local mp
	local fstype
	local opt
	local rest
d67 1
a67 3
	local i
	local j
	local k
d74 1
a74 1
			if [[ ${_mp[$k]} < ${_mp[$j]} ]]; then
d133 27
a159 9
# Disable hardware write cache (needed for softdep).
# Currently only IDE drives are supported, sorry.
if [[ $softdrives_ide != NO ]]; then
	_flags="$softdrives_ide"
  else
	_flags=""
fi
softdrives_ide="$_flags $(echo \
  'g/^\/dev\/\(wd[0-9][0-9]*\)[a-p].*softdep.*/s//\1/p\nq' | ed -s /etc/fstab)"
d165 1
a165 1
		case "$_flags" in
d174 1
a174 1
		esac
d186 2
a187 2
	case $? in
	0)
d189 1
a189 1
	2)
d192 1
a192 1
	4)
d198 1
a198 1
	8)
d202 1
a202 1
	12)
d206 1
a206 1
	130)
d210 1
a210 1
	*)
d214 1
a214 1
	esac
a219 10
let _fstab=0
while read _fdev _fmp _ffstype _fopt _frest; do
	_dev[_fstab]="$_fdev"
	_mp[_fstab]="$_fmp"
	_fstype[_fstab]="$_ffstype"
	_opt[_fstab]="${_fopt:-rw}"
	_rest[_fstab]="$_frest"
	let _fstab='_fstab+1'
done </etc/fstab
_fssort
d222 2
a223 2
	if [[ ${_mp[$i]} == / ]]; then
		mount -uwo "${_opt[$i]}" "${_dev[$i]}" / >/dev/null 2>&1
d225 1
a225 1
			case "${_opt[$i]}" {
d229 1
a229 1
				echo 'The system is probably severely damaged.'
d232 1
a232 1
			mount -ufwo "${_opt[$i]}" "${_dev[$i]}" /
d235 1
a235 1
		case "${_opt[$i]}" in
d237 3
a239 3
		  *)	if [[ ${_fstype[$i]} == ffs ]]; then
				mount -t ffs -o "${_opt[$i]}" "${_dev[$i]}" \
					"${_mp[$i]}" >/dev/null 2>&1
d241 1
a241 1
					case "${_opt[$i]}" {
d245 2
a246 2
						echo -n "system" ${_dev[$i]}"
						echo " -> ${_mp[$i]}"
d249 2
a250 2
					mount -f -t ffs -o "${_opt[$i]}" \
					    "${_dev[$i]}" "${_mp[$i]}"
d253 2
a254 2
				mount -t "${_fstype[$i]}" -o "${_opt[$i]}" \
				    "${_dev[$i]}" "${_mp[$i]}"
d257 1
a257 1
		esac
d274 2
a275 2
	case $(sysctl vfs.mounts.nfs 2>/dev/null) in
	*[1-9]*)
d281 1
a281 1
	esac
@


1.14
log
@o Sync "stripcom" function with /etc/profile and /etc/rc ksh style
o KNFify: function foo\n{
o Move whitespace around a bit

Tested.

This revision will be pulled up and MFCd to MIRBSD_7.
@
text
@d1 2
a2 2
#!/bin/ksh
#	$MirBSD: rc,v 1.13 2003/10/06 14:46:38 tg Exp $
a216 1
_fsdump
a217 1
_fsdump
d223 1
a223 1
			case "${_opt[$i]}" in
d229 1
a229 1
			esac
d239 1
a239 1
					case "${_opt[$i]}" in
d246 1
a246 1
					esac
@


1.13
log
@Do not use /usr/bin/sed in /etc/rc, use /bin/ed instead.
Pointed to by and thanks to: From: Teh Kok How <khteh@@willowglen.com.my>
Code by myself
@
text
@d2 1
a2 1
#	$MirBSD: rc,v 1.12 2003/10/05 21:17:13 tg Exp $
d19 4
a22 6
# System startup script run by init on autoboot
# or after single-user.
# Output and error are redirected to console by init,
# and the console is the controlling terminal.
#
# This script must be run with the korn shell.
d28 2
a29 2
stripcom() {
	local _file="$1"
d32 6
a37 7
	{
		while read _line; do
			_line=${_line%%#*}		# strip comments
			test -z "$_line" && continue	# and empty lines
			echo $_line			# and whitespace
		done
	} <"$_file"
d43 2
a44 1
function _fsswap {
d69 2
a70 1
function _fssort {
d146 2
a147 3
softdrives_ide="$(echo \
    'g/^\/dev\/\(wd[0-9][0-9]*\)[a-p].*softdep.*/s//\1/p\nq\n' \
    | ed -s fstab) $_flags"
@


1.12
log
@Errata:
  When mounting the filesystems in order, do not use sort(1) for sorting
  /etc/fstab before doing the mount. Reason: it's /usr/bin/sort

Additional fixes:
  Try if the mount proceeds, do not display error messages.
  If the mount has not been successfully, check if softdep is enabled
  for that filesystem - if not, output a warning.
  Then mount forcefully (error messages are not suppressed).

This change will be MFCd to MIRBSD_7 tag.

ok and approved bsiegert@@
@
text
@d2 1
a2 1
#	$MirBSD: licence.template,v 1.5 2003/07/26 12:33:13 tg Exp $
d147 3
a149 2
softdrives_ide="$(sed -n 's#^/dev/\(wd[0-9]\)[a-z].*softdep.*#\1#p' \
    </etc/fstab) $_flags"
@


1.11
log
@o auto-detect rwd*c drives to disable HDD hardware write cache
  from the entries in /etc/fstab; report progress and potential
  failure (from Denis A. Doroshenko <d.doroshenko@@omnitel.net>)
o allow for additional drives (such as non-softdep filesystems'
  drives or "the device behind /dev/root") to be mentioned for
  disabling the HDD write cache; don't invoke sort(1) and uniq(1)
  but rather do the work in shell (should be faster especially
  on machines with very slow I/O)
o convert all [ x"$foo" = x"bar" -a \! false ] to the korn shell
  syntax of [[ $foo == bar && ! false ]] for security reasons
  NOTE: this now means /etc/rc and friends are to be read by ksh!
o remove whitespace after the '<', '>', '>>' of file redirections
o remove whitespace before a ;
o fix whitespace and tab settings; cosmetics
o replace 'FOO=bar; export FOO' with 'export FOO=bar'
o nuke unused string escapes like 'food ${food_params}'
o protect string escapes like '/dev/r$bar.blah' -> '/dev/r${bar}.blah'

I haven't still read the entire ksh manual and O'Reilly book,
but will continue to do so and encourage everybody to polish
his korn shell speak for autumn ;-)
@
text
@d1 2
a2 1
#	$MirBSD: rc,v 1.10 2003/09/02 08:45:16 tg Exp $
d4 15
a18 1

d23 1
a23 1

d43 48
d209 50
a258 6
sort -bk2 </etc/fstab | while read _dev _mp _fstype _opt _rest; do
	if [[ $_mp == / ]]; then
		mount -ufwo "$_opt" "$_dev" /
	  elif [[ $_fstype == ffs ]]; then
		echo "$_opt" | grep -F noauto >/dev/null 2>&1 || \
			mount -f -t ffs -o "$_opt" "$_dev" "$_mp"
d260 1
d262 1
a262 1
mount -a -t nonfs,noffs
@


1.10
log
@move generation of anoncvs/dev/null to /etc/rc, just
as with /var/empty/dev/log
@
text
@d1 1
a1 1
#	$MirBSD: rc,v 1.9 2003/08/17 08:38:26 tg Exp $
d9 2
d20 1
a20 1
		while read _line ; do
d22 2
a23 2
			test -z "$_line" && continue
			echo $_line
d25 1
a25 1
	} < $_file
d37 2
a38 3
HOME=/; export HOME
PATH=/sbin:/bin:/usr/sbin:/usr/bin
export PATH
d40 3
a42 2
if [ $1x = shutdownx ]; then
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 >/dev/null 2>&1
d44 1
a44 1
	if [ $? -eq 0 -a -f /etc/rc.shutdown ]; then
d48 1
a48 1
		if [ "X${powerdown}" = X"YES" ]; then
d51 1
a51 1
	else
d58 1
a58 1
if [ -f /etc/ccd.conf ]; then
d64 2
a65 2
	if [ -f /etc/raid$dev.conf ]; then
		raidctl -c /etc/raid$dev.conf raid$dev
d78 23
a100 6
if [ "$softdrives_ide" = NO ]; then
	echo "rc: warning: you did not disable hardware write cache!"
  elif [ "$softdrives_ide" != SCSI ]; then
	echo "Disabling hard disc hardware write caches..."
	for drv in ${softdrives_ide}; do
		/sbin/atactl /dev/r${drv}c writecachedisable
d102 2
d107 1
a107 1
if [ -e /fastboot ]; then
d109 1
a109 1
elif [ $1x = autobootx ]; then
d147 1
a147 1
	if [ x"$_mp" = x"/" ]; then
d149 1
a149 1
	elif [ x"$_fstype" = x"ffs" ]; then
d161 1
a161 1
if [ "X${pf}" != X"NO" ]; then
d178 1
a178 1
if [ -f /etc/sysctl.conf ]; then
d182 1
a182 1
	while [ $# -ge 1 ] ; do
d194 1
a194 1
if [ "$arptables" = "YES" -a -e /etc/arp.conf ]; then
d199 3
a201 3
if [ "X${pf}" != X"NO" ]; then
	if [ -f ${pf_rules} ]; then
		pfctl -f ${pf_rules}
d209 1
a209 1
if [ ! -f /var/db/host.random ]; then
d213 1
a213 1
else
d215 1
a215 1
	    > /dev/null 2>&1
d217 1
a217 1
	    > /dev/null 2>&1
d223 1
a223 1
    > /dev/null 2>&1
d230 1
a230 1
	test -r dhclient.pid && dhclient_pid=$(<dhclient.pid); \
d234 1
a234 1
	test -n "$dhclient_pid" && echo "$dhclient_pid" > dhclient.pid; })
d243 1
a243 1
if [ -d /var/empty ]; then
d246 1
a246 1
	syslogd_flags="${syslogd_flags} -a /var/empty/dev/log"
d248 1
a248 1
syslogd ${syslogd_flags}
d250 1
a250 1
if [ X"${pf}" != X"NO" -a X"${pflogd_flags}" != X"NO" ]; then
d252 1
a252 1
	pflogd ${pflogd_flags}
d258 2
a259 2
if [ "X${isakmpd_flags}" != X"NO" -a -e /etc/isakmpd/isakmpd.policy ]; then
	echo 'starting isakmpd';	isakmpd ${isakmpd_flags}
d266 1
a266 1
if [ X"${portmap}" = X"YES" ]; then
d268 2
d274 2
a275 2
if [ X${nfs_server} = X"YES" -a -s /etc/exports -a \
    $(sed -e '/^#/d' < /etc/exports | wc -l) -ne 0 ]; then
d277 1
a277 1
	echo -n > /var/db/mountdtab
d279 2
a280 2
	echo -n ' nfsd';		nfsd ${nfsd_flags}
	if [ X${lockd} = X"YES" ]; then
a284 6
if [ X${amd} = X"YES" -a -e ${amd_master} ]; then
	echo -n ' amd'
	(cd /etc/amd; amd -l syslog -x error,noinfo,nostats -p \
	    -a ${amd_dir} $(<${amd_master}) > /var/run/amd.pid )
fi

d286 2
a287 2
if [ X"${rdate_flags}" != X"NO" ]; then
        echo -n ' rdate';     rdate -s ${rdate_flags}
d292 2
a293 2
if [ "X${timed_flags}" != X"NO" ]; then
	echo -n ' timed'; timed $timed_flags
d303 2
a304 2
if [ -d /var/crash ]; then
	savecore ${savecore_flags} /var/crash
d307 1
a307 1
if [ "X${check_quotas}" = X"YES" ]; then
d326 1
a326 1
if [ -f /etc/ptmp ]; then
d347 1
a347 1
# create Unix sockets directories  for X if needed and make sure they have
d349 4
a352 4
if [ -d /usr/X11R6/lib ]; then
	for d in /tmp/.X11-unix /tmp/.ICE-unix ; do
		if [ -d $d ]; then
			if [ $(ls -ld $d | cut -d' ' -f4) != root ]; then
d355 1
a355 1
			if [ $(ls -ld $d | cut -d' ' -f1) != drwxrwxrwt ]; then
d358 1
a358 1
		elif [ -e $d ]; then
d360 1
a360 1
		else
d366 2
a367 2
[ -f /etc/rc.securelevel ] && . /etc/rc.securelevel
if [ X${securelevel} != X"" ]; then
d369 1
a369 1
	sysctl -w kern.securelevel=${securelevel}
d373 1
a373 1
if [ ! -f /etc/motd ]; then
d377 4
a380 4
if [ $? -eq 0 ]; then
	sysctl -n kern.version | sed 1q > $T
	echo "" >> $T
	sed '1,/^$/d' < /etc/motd >> $T
d383 2
d387 1
a387 1
if [ -f /var/account/acct ]; then
d391 1
a391 1
if [ -f /sbin/ldconfig ]; then
d393 1
a393 1
	if [ -d /usr/local/lib ]; then
d396 1
a396 1
	if [ -d /usr/X11R6/lib ]; then
d402 1
a402 1
if [ -x /usr/libexec/vi.recover ]; then
d406 1
a406 1
if [ ! -f /etc/ssh/ssh_host_dsa_key ]; then
d408 2
a409 1
	if /usr/bin/ssh-keygen -q -t dsa -f /etc/ssh/ssh_host_dsa_key -N ''; then
d411 1
a411 1
	else
d415 1
a415 1
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
d417 2
a418 1
	if /usr/bin/ssh-keygen -q -t rsa -f /etc/ssh/ssh_host_rsa_key -N ''; then
d420 1
a420 1
	else
d424 1
a424 1
if [ ! -f /etc/ssh/ssh_host_key ]; then
d426 2
a427 1
	if /usr/bin/ssh-keygen -q -t rsa1 -f /etc/ssh/ssh_host_key -N ''; then
d429 1
a429 1
	else
d434 3
a436 2
if [ -d /var/anoncvs/anoncvs -a -f /var/anoncvs/anoncvssh \
    -a ! -e /var/anoncvs/anoncvs/dev/null ]; then
d444 1
a444 1
if [ "X${routed_flags}" != X"NO" ]; then
d450 1
a450 1
if [ "X${mrouted_flags}" != X"NO" ]; then
d456 1
a456 1
if [ "X${dhcpd_flags}" != X"NO" -a -f /etc/dhcpd.conf ]; then
d458 1
a458 1
	if [ -f /etc/dhcpd.interfaces ]; then
d461 2
a462 1
	echo -n ' dhcpd';	/usr/sbin/dhcpd ${dhcpd_flags} ${dhcpd_ifs}
d467 1
a467 1
	if [ "X${fw}" == X"0" ]; then
d470 1
a470 1
		if [ "X${rtsold_flags}" != X"NO" ]; then
d472 1
a472 1
			/usr/sbin/rtsold ${rtsold_flags}
d474 1
a474 1
	else
d477 1
a477 1
		if [ "X${route6d_flags}" != X"NO" ]; then
d479 1
a479 1
			/usr/sbin/route6d ${route6d_flags}
d483 1
a483 1
		if [ "X${rtadvd_flags}" != X"NO" ]; then
d485 1
a485 1
			/usr/sbin/rtadvd ${rtadvd_flags}
d492 1
a492 1
if [ X${rwhod} = X"YES" ]; then
d497 2
a498 2
if [ "X${lpd_flags}" != X"NO" ]; then
	echo -n ' printer';		lpd ${lpd_flags}
d506 3
a508 2
if [ "X${sendmail_flags}" != X"NO" -a -s /etc/mailer.conf ]; then
	echo -n ' sendmail';		( /usr/sbin/sendmail ${sendmail_flags} >/dev/null 2>&1 & )
d511 2
a512 2
if [ "X${spamd_flags}" != X"NO" ]; then
	echo -n ' spamd';		/usr/libexec/spamd ${spamd_flags}
d516 1
a516 1
if [ "X${httpd_flags}" != X"NO"  ]; then
d519 1
a519 1
	echo -n ' httpd';		/usr/sbin/httpd ${httpd_flags}
d522 2
a523 2
if [ "X${ftpd_flags}" != X"NO" ]; then
	echo -n ' ftpd';		/usr/libexec/ftpd ${ftpd_flags}
d526 2
a527 2
if [ "X${identd_flags}" != X"NO" ]; then
	echo -n ' identd';		/usr/libexec/identd ${identd_flags}
d530 1
a530 1
if [ X${inetd} = X"YES" -a -e /etc/inetd.conf ]; then
d537 2
a538 2
if [ "X${rarpd_flags}" != X"NO" -a -s /etc/ethers ]; then
	echo -n ' rarpd';		rarpd ${rarpd_flags}
d544 2
a545 2
if [ "X${bootparamd_flags}" != X"NO" -a -s /etc/bootparams ]; then
	echo -n ' rpc.bootparamd';	rpc.bootparamd ${bootparamd_flags}
d551 2
a552 2
if [ "X${rbootd_flags}" != X"NO" -a -s /etc/rbootd.conf ]; then
	echo -n ' rbootd';		rbootd ${rbootd_flags}
d558 2
a559 2
if [ "X${mopd_flags}" != X"NO" -a -d /tftpboot/mop ]; then
	echo -n ' mopd';		mopd ${mopd_flags}
d562 2
a563 2
if [ X"${sshd_flags}" != X"NO" ]; then
	echo -n ' sshd';		/usr/sbin/sshd ${sshd_flags};
d566 2
a567 2
if [ X"${isdnd_flags}" != X"NO" ]; then
	echo -n ' isdnd';		/usr/sbin/isdnd ${isdnd_flags};
d572 1
a572 1
if [ "${sshagent_autostart}" != NO ]; then
d576 1
a576 1
	for luser in ${sshagent_autostart}; do
d583 1
a583 1
if [ -x /sbin/wsconsctl -a -f /etc/wsconsctl.conf ]; then
d591 1
a591 1
	while [ $# -ge 1 ] ; do
d598 1
a598 1
if [ -f /sbin/kbd -a -f /etc/kbdtype ]; then
d602 1
a602 1
[ -f /etc/rc.local ] && . /etc/rc.local
d608 2
a609 2
if [ "X${apmd_flags}" != X"NO" -a -x /usr/sbin/apmd ]; then
        echo -n ' apmd';        /usr/sbin/apmd ${apmd_flags}
d618 2
a619 2
if [ "X${wsmoused_flags}" != X"NO" -a -x /usr/sbin/wsmoused ]; then
	echo 'starting wsmoused...';	/usr/sbin/wsmoused ${wsmoused_flags}
d623 2
a624 2
if [ "X${xdm_flags}" != X"NO" ]; then
	echo 'starting xdm...';		/usr/X11R6/bin/xdm ${xdm_flags}
@


1.9
log
@improve mount logic:
1) mount -update -force -read/write -options (see fstab) device (see fstab) /
   force: if softdep, and check == 0
2) mount all ffs -force -options (see fstab) device mountpoint,
   which don't have noauto in options
3) mount all noffs (and nonfs, see below)
@
text
@d1 1
a1 1
#	$MirBSD: rc,v 1.8 2003/08/16 15:19:58 tg Exp $
d410 5
@


1.8
log
@Merge OpenBSD
@
text
@d1 1
a1 1
#	$MirBSD: rc,v 1.7 2003/05/22 14:06:13 tg Exp $
d125 9
a133 3
mount -ufw /
mount -af -t ffs
mount -a -t nonfs
d316 1
a316 1
if mount 2>&1 | grep "on /tmp" >/dev/null 2>&1; then
@


1.7
log
@merge CVS import stuff
@
text
@d1 2
a2 2
#	$MirBSD: rc,v 1.6 2003/05/17 23:02:22 tg Exp $
#	$OpenBSD: rc,v 1.227 2003/05/14 18:41:06 ian Exp $
d136 1
@


1.6
log
@thanks xsa@@bsdcow.net (Xavier Santolaria)
@
text
@d1 2
a2 2
#	$MirBSD: rc,v 1.5 2003/05/17 20:14:28 tg Exp $
#	$OpenBSD: rc,v 1.226 2003/04/08 01:53:43 millert Exp $
d407 1
a407 2
# $gated and $routed_flags are imported from /etc/rc.conf.
# If $gated == YES, gated is used; otherwise routed.
d409 1
a409 3
if [ X${gated} = X"YES" -a -e /etc/gated.conf ]; then
	echo -n ' gated';		/usr/local/sbin/gated $gated_flags
elif [ "X${routed_flags}" != X"NO" ]; then
@


1.5
log
@add option for isdnd autostart
@
text
@d1 1
a1 1
#	$MirBSD: rc,v 1.4 2003/04/10 20:10:51 tg Exp $
d533 1
a533 1
	echo -n ' isdnd';		/usr/sbin/isdnd ${sshd_flags};
@


1.4
log
@clean up the cvs import mess

nb, this doesnt mean the tree builds.
its bed time
@
text
@d1 1
a1 1
#	$MirBSD: rc,v 1.3 2003/03/29 21:33:32 tg Exp $
d530 4
@


1.3
log
@merge OpenBSD cvs import conflicts
enable /etc/isdn directory and MAKEDEV.i4b
@
text
@d1 2
a2 2
#	$MirBSD: rc,v 1.2 2003/03/23 21:47:59 tg Exp $
#	$OpenBSD: rc,v 1.225 2003/03/23 18:45:34 marc Exp $
d299 1
a299 1
chown root.wheel /dev/tty[pqrstuvwxyzPQRST]*
@


1.2
log
@Merge MirBSD-old entirely
Remove krb, yp, afs, GPL'd stuff in kernel
Adjust some other stuff

Not to be compiled yet...
@
text
@d1 2
a2 2
#	$MirBSD: obsd.tygs,v 1.44 2003/03/22 22:33:30 tg Exp $
#	$OpenBSD: rc,v 1.222 2003/03/10 01:05:28 deraadt Exp $
d464 1
a464 1
if [ X${lpd_flags} != X"NO" ]; then
d548 1
a548 1
	saveIFS=$IFS
d552 1
a552 1
	IFS=$save_IFS
@


1.1
log
@Initial revision
@
text
@d1 1
d72 14
d125 2
d128 1
a128 5
mount -uw /		# root on nfs requires this, others aren't hurt
rm -f /fastboot		# XXX (root now writeable)

# pick up option configuration
. /etc/rc.conf
d139 1
a139 1
	case `sysctl vfs.mounts.nfs 2>/dev/null` in
d153 1
a153 1
	set -- `stripcom /etc/sysctl.conf`
d165 6
d201 6
a206 1
(cd /var/run && { test -r dhclient.pid && dhclient_pid=`cat dhclient.pid`; rm -rf -- *; install -c -m 664 -g utmp /dev/null utmp; test -n "$dhclient_pid" && echo "$dhclient_pid" > dhclient.pid; })
a214 4
if [ "X${named_flags}" != X"NO" ]; then
	rm -f /var/named/dev/log
	syslogd_flags="${syslogd_flags} -a /var/named/dev/log"
fi
a226 16
# $named_flags are imported from /etc/rc.conf;
# if $named_flags != NO, named is run.
if [ "X${named_flags}" != X"NO" ]; then
	if ! cmp -s /etc/rndc.key /var/named/etc/rndc.key ; then
		echo -n "rndc-confgen: generating new shared secret... "
		if /usr/sbin/rndc-confgen -a -t /var/named >/dev/null 2>&1; then
			chmod 0640 /var/named/etc/rndc.key >/dev/null 2>&1
			echo done.
		else
			echo failed.
		fi
	fi

	echo 'starting named';		named $named_flags
fi

a241 29
if [ -d /var/yp/binding -a X`domainname` != X ]; then
	if [ -d /var/yp/`domainname` ]; then
		# yp server capabilities needed...
		echo -n ' ypserv';		ypserv ${ypserv_flags}
		#echo -n ' ypxfrd';		ypxfrd
	fi

	echo -n ' ypbind';		ypbind

	if [ -d /var/yp/`domainname` ]; then
		# if we are the master server, run rpc.yppasswdd
		_host1=`ypwhich -m passwd 2> /dev/null`
		_host2=`hostname`
		if [ `grep '^lookup' /etc/resolv.conf | grep yp | wc -c` -ne 0 ]; then
			_host1=`ypmatch $_host1 hosts | cut -d'	' -f2`
			_host2=`ypmatch $_host2 hosts | cut -d'	' -f2 | head -1`
		else
			_host1=`nslookup $_host1 | grep '^Name: ' | \
			    sed -e 's/^Name:    //'`
			_host2=`nslookup $_host2 | grep '^Name: ' | \
			    sed -e 's/^Name:    //'`
		fi
		if [ "$_host2" = "$_host1" ]; then
			echo -n ' rpc.yppasswdd'
			rpc.yppasswdd ${yppasswdd_flags}
		fi
	fi
fi

d245 1
a245 1
    `sed -e '/^#/d' < /etc/exports | wc -l` -ne 0 ]; then
d258 1
a258 1
	    -a ${amd_dir} `cat ${amd_master}` > /var/run/amd.pid )
a282 7
if [ "X${afs}" = X"YES" -a -c ${afs_device} -a -d ${afs_mount_point} ]; then
	echo -n 'mounting afs:'
	mount -t xfs ${afs_device} ${afs_mount_point}
	/usr/libexec/afsd ${afsd_flags} -d ${afs_device}
	echo ' done.'
fi

d309 13
a321 5
# prune quickly with one rm, then use find to clean up /tmp/[lq]*
# (not needed with mfs /tmp, but doesn't hurt there...)
(cd /tmp && rm -rf [a-km-pr-zA-Z]* &&
    find . ! -name . ! -name lost+found ! -name quota.user \
	! -name quota.group -execdir rm -rf -- {} \; -type d -prune)
d328 1
a328 1
			if [ `ls -ld $d | cut -d' ' -f4` != root ]; then
d331 1
a331 1
			if [ `ls -ld $d | cut -d' ' -f1` != drwxrwxrwt ]; then
d352 1
a352 1
T=`mktemp /tmp/_motd.XXXXXXXXXX`
a360 4
if [ -x /usr/libexec/vi.recover ]; then
	echo 'preserving editor files';	/usr/libexec/vi.recover
fi

d376 4
d427 1
a427 1
		dhcpd_ifs=`stripcom /etc/dhcpd.interfaces`
d433 1
a433 1
	fw=`sysctl -n net.inet6.ip6.forwarding`
d534 11
d551 1
a551 1
	set -- `stripcom /etc/wsconsctl.conf`
d561 1
a561 16
	kbd `cat /etc/kbdtype`
fi

# KerberosV master KDC
if [ X${krb5_master_kdc} = X"YES" ]; then
	echo 'KerberosV master KDC'
	/usr/libexec/kdc &
	/usr/libexec/kadmind &
	/usr/libexec/kpasswdd &
fi

# KerberosV slave KDC
if [ X${krb5_slave_kdc} = X"YES" ]; then
	echo 'KerberosV slave KDC'
	/usr/libexec/kdc &
	# Remember to enable hpropd in inetd.conf
a589 1

@


1.1.1.1
log
@Import OpenBSD 3.3 source repository from CTM 3132 the first time
This opens an OpenBSD-mirabile (aka MirBSD) repository.

### MirBSD is:
# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
# Copyright © 1968-2003  The authors of And contributors to UNIX®, the
#       C Language, BSD/Berkeley Unix; 386BSD, NetBSD 1.1 and OpenBSD.
#
# Anyone who obtained a copy of this work is hereby permitted to freely use,
# distribute, modify, merge, sublicence, give away or sell it as long as the
# authors are given due credit and the following notice is retained:
#
# This work is provided "as is", with no explicit or implicit warranty what-
# soever. Use it only at your own risk. In no event may an author or contri-
# butor be held liable for any damage, directly or indirectly, that origina-
# ted through or is caused by creation or modification of this work.

MirBSD is my private tree. MirBSD does not differ very much from OpenBSD
and intentionally tracks OpenBSD. That's why it _is_ OpenBSD, just not the
official one. It's like with DarrenBSD.

At time of this writing, no advertising for MirBSD must be done,
because the advertising clause has not yet been sorted out.

http://templeofhate.com/tglaser/MirBSD/index.php
@
text
@@


1.1.1.2
log
@Import OpenBSD repository of CTM 3155 (roughly today at noon).
Mostly in order to go 3.3-current and ease further merges of
both OpenBSD and ELFdiffs after the MirBSD has been enabled
to build again.
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.225 2003/03/23 18:45:34 marc Exp $
d207 1
a207 1
# $named_flags is imported from /etc/rc.conf;
d488 1
a488 1
if [ "X${lpd_flags}" != X"NO" ]; then
d561 1
a561 1
	save_IFS="$IFS"
d565 1
a565 1
	IFS="$save_IFS"
@


1.1.1.3
log
@Import OpenBSD cvs as of roughly 11:11 UTC today,
or CTM delta 3188/3189/3190.
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.226 2003/04/08 01:53:43 millert Exp $
d331 1
a331 1
chown root:wheel /dev/tty[pqrstuvwxyzPQRST]*
@


1.1.1.4
log
@Sync MirBSD main source tree against OpenBSD-current,
which should be fairly stable after the Hackathon now.
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.227 2003/05/14 18:41:06 ian Exp $
d431 2
a432 1
# $routed_flags are imported from /etc/rc.conf.
d434 3
a436 1
if [ "X${routed_flags}" != X"NO" ]; then
@


1.1.1.5
log
@Import the complete OpenBSD source tree (base system)
as of CTM delta 3496 (roughly 1200 UTC today) into the
vendor branch.
Attention: this is a big update. Don't even try to
build this system, OpenBSD 3.4-beta, yet on your own.
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.228 2003/07/29 17:52:17 henning Exp $
a122 1
	RULES="$RULES\npass on lo0"
@


1.1.1.6
log
@Import selected parts of the OpenBSD base system:
 * vnd change - you'll have to re-run MAKEDEV after booting a new kernel
 * misc. changes in /etc, mostly user related
 * Perl 5.8.2 (diff to MirPorts will be committed RSN)
 * some changes to binutils
 * Updates in bc and dc
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.229 2003/11/18 16:37:34 henning Exp $
a597 4
fi

if [ X"${sensorsd_flags}" != X"NO" ]; then
	echo -n ' sensorsd';	/usr/sbin/sensorsd ${sensorsd_flags}
@


1.1.1.7
log
@Time to import OpenBSD once again. Expect breakage.
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.230 2003/12/05 00:52:16 deraadt Exp $
d289 1
a289 1
	echo -n ' rdate';	rdate -s ${rdate_flags}
d597 1
a597 1
	echo -n ' apmd';	/usr/sbin/apmd ${apmd_flags}
@


1.1.1.8
log
@Import OpenBSD again, for various reasons.
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.231 2003/12/29 23:16:45 millert Exp $
d386 4
a402 4
fi

if [ -x /usr/libexec/vi.recover ]; then
	echo 'preserving editor files';	/usr/libexec/vi.recover
@


1.1.1.9
log
@Import OpenBSD as of today again (seems pretty stable, I hope)

Prominent changes: more bgpd, tcpmd5; tcpdump/isakmpd fixes
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.232 2004/01/23 22:11:40 deraadt Exp $
d248 1
a248 1
	if [ X"${yppasswdd_flags}" != X"NO" -a -d /var/yp/`domainname` ]; then
@


1.1.1.10
log
@large-scale import of OpenBSD 3.5-current source base including many fixes
note: from now, we will not be binary compatible with OpenBSD apps any
longer (due to syscall numbering differences); both an OpenBSD compat and
a conversion tool for old MirOS #7 apps will be delivered later.

The src/ tree is locked from now.
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.246 2004/05/16 04:31:01 mcbride Exp $
a44 13

		# bring carp interfaces down gracefully
		for hn in /etc/hostname.carp[0-9]*; do
			# Strip off /etc/hostname. prefix
			if=${hn#/etc/hostname.}
			test "$if" = "carp[0-9]*" && continue

			ifconfig $if > /dev/null 2>&1
			if [ "$?" != "0" ]; then
				ifconfig $if down
			fi
		done

a47 1

a126 1
	RULES="$RULES\npass proto { pfsync, carp }"
d143 1
a143 1
		sysctl $1
d309 1
a309 1
if [ "X${afs}" = X"YES" -a -c /dev/xfs0 ]; then
d311 2
a312 3
	mkdir -p -m 0755 /afs
	mount -t xfs /dev/xfs0 /afs
	/usr/libexec/afsd ${afsd_flags}
d370 1
a370 1
	sysctl kern.securelevel=${securelevel}
a429 13
if [ ! -f /etc/isakmpd/private/local.key ]; then
	echo -n "openssl: generating new isakmpd RSA key... "
	if /usr/sbin/openssl genrsa -out /etc/isakmpd/private/local.key 1024 \
	    > /dev/null 2>&1; then
		chmod 600 /etc/isakmpd/private/local.key
		openssl rsa -out /etc/isakmpd/private/local.pub \
		    -in /etc/isakmpd/private/local.key -pubout > /dev/null 2>&1
		echo done.
	else
		echo failed.
	fi
fi

a443 4
if [ "X${bgpd_flags}" != X"NO" ]; then
	echo -n ' bgpd';		/usr/sbin/bgpd $bgpd_flags
fi

d499 5
a521 16
if [ X"${sshd_flags}" != X"NO" ]; then
	echo -n ' sshd';		/usr/sbin/sshd ${sshd_flags};
fi

if [ "X${spamd_flags}" != X"NO" ]; then
	if [ "X${spamd_grey}" != X"NO" ]; then
		spamd_flags="${spamd_flags} -g"
	fi
	echo -n ' spamd';		eval /usr/libexec/spamd ${spamd_flags}
	/usr/libexec/spamd-setup
	if [ "X${spamd_grey}" != X"NO" ]; then
		echo -n ' spamlogd'
		/usr/libexec/spamlogd
	fi
fi

d548 4
@


