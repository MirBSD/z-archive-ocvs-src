head	1.22;
access;
symbols
	tg-mergetmp-mirosx-1:1.22
	tg-mergefixes-1-branch:1.22.0.4
	tg-mergefixes-1-base:1.22
	MIROS_X:1.22.0.2
	MIROS_X_BASE:1.22
	tg-mergetmp-3:1.22
	MIRBSD_XP_MIRPPC:1.21.0.4
	MIRBSD_XP_SPARC_BASE:1.21
	MIRBSD_XP_SPARC:1.21.0.2
	MIRBSD_7quater:1.12
	cvs-200405160640:1.1.1.12
	cvs-200401271800:1.1.1.11
	cvs-200401261630:1.1.1.11
	cvs-200401021645:1.1.1.11
	MIRBSD_7_ALPHA:1.12.0.6
	MIRBSD_7:1.12.0.4
	cvs-200312222040:1.1.1.11
	MIRBSD_7ter:1.12
	MIRBSD_7_DEV:1.12.0.2
	cvs-200310020700:1.1.1.10
	cvs-200309271030:1.1.1.10
	cvs-200309251530:1.1.1.9
	cvs-200309071830:1.1.1.8
	cvs-200308302005:1.1.1.8
	cvs-200308171200:1.1.1.7
	ctm-3496:1.1.1.7
	ctm-3449:1.1.1.6
	ctm-3437:1.1.1.6
	cvs-200307191805:1.1.1.6
	ctm-3425:1.1.1.6
	cvs-200307091500:1.1.1.6
	cvs-200307072125:1.1.1.6
	ctm-3389:1.1.1.6
	cvs-200307030815:1.1.1.5
	cvs-200307021520:1.1.1.4
	cvs-200306301805:1.1.1.4
	cvs-200306291430:1.1.1.3
	ctm-3341:1.1.1.2
	MIRBSD_5:1.3
	cvs-200306082100:1.1.1.2
	ctm-3316:1.1.1.2
	ctm-3272:1.1.1.1
	ctm-3264:1.1.1.1
	cvs-200305071630:1.1.1.1
	MIRBSD_4:1.2
	ctm-3203:1.1.1.1
	cvs-20030410-1130:1.1.1.1
	ctm-3155:1.1.1.1
	ctm-3132:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.22
date	2004.11.25.23.41.54;	author tg;	state Exp;
branches;
next	1.21;

1.21
date	2004.06.11.15.57.24;	author tg;	state Stab;
branches;
next	1.20;

1.20
date	2004.05.21.21.10.47;	author tg;	state Exp;
branches;
next	1.19;

1.19
date	2004.03.05.19.48.44;	author tg;	state Exp;
branches;
next	1.18;

1.18
date	2004.02.01.21.39.50;	author tg;	state Exp;
branches;
next	1.17;

1.17
date	2004.01.28.15.14.06;	author tg;	state Exp;
branches;
next	1.16;

1.16
date	2003.12.23.13.41.59;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2003.11.28.22.37.49;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2003.11.20.12.37.52;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2003.11.20.12.36.05;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2003.09.27.15.46.48;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2003.09.26.20.53.58;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2003.09.25.20.59.39;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2003.08.31.20.54.08;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2003.08.16.15.19.51;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2003.07.06.20.20.58;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2003.07.03.08.26.53;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2003.06.30.18.22.10;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2003.06.29.19.45.43;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2003.06.06.18.26.41;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2003.03.23.21.47.55;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2003.03.22.17.35.11;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2003.03.22.17.35.11;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2003.06.05.16.58.33;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2003.06.29.14.52.19;	author tg;	state Exp;
branches;
next	1.1.1.4;

1.1.1.4
date	2003.06.30.18.14.28;	author tg;	state Exp;
branches;
next	1.1.1.5;

1.1.1.5
date	2003.07.03.08.19.34;	author tg;	state Exp;
branches;
next	1.1.1.6;

1.1.1.6
date	2003.07.06.14.48.07;	author tg;	state Exp;
branches;
next	1.1.1.7;

1.1.1.7
date	2003.08.11.17.46.43;	author tg;	state Exp;
branches;
next	1.1.1.8;

1.1.1.8
date	2003.08.30.21.07.50;	author tg;	state Exp;
branches;
next	1.1.1.9;

1.1.1.9
date	2003.09.25.16.08.08;	author tg;	state Exp;
branches;
next	1.1.1.10;

1.1.1.10
date	2003.09.27.10.47.15;	author tg;	state Exp;
branches;
next	1.1.1.11;

1.1.1.11
date	2003.12.22.20.23.14;	author tg;	state Exp;
branches;
next	1.1.1.12;

1.1.1.12
date	2004.05.16.07.26.09;	author tg;	state Exp;
branches;
next	;


desc
@@


1.22
log
@sync w/ GENERIC,1.78
@
text
@#!/bin/sh
# $MirBSD: src/distrib/miniroot/install.sh,v 1.21 2004/06/11 15:57:24 tg Stab $
# $OpenBSD: install.sh,v 1.142 2004/03/23 02:39:38 krw Exp $
# $NetBSD: install.sh,v 1.5.2.8 1996/08/27 18:15:05 gwr Exp $
#
# Copyright (c) 1997-2004 Todd Miller, Theo de Raadt, Ken Westerback
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# Copyright (c) 1996 The NetBSD Foundation, Inc.
# All rights reserved.
#
# This code is derived from software contributed to The NetBSD Foundation
# by Jason R. Thorpe.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#        This product includes software developed by the NetBSD
#        Foundation, Inc. and its contributors.
# 4. Neither the name of The NetBSD Foundation nor the names of its
#    contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
# TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE
# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
#

#	OpenBSD installation script.
#	In a perfect world, this would be a nice C program, with a reasonable
#	user interface.

# The name of the file holding the list of configured filesystems.
FILESYSTEMS=/tmp/filesystems

# The name of the file holding the list of non-default configured swap devices.
SWAPLIST=/tmp/swaplist

# install.sub needs to know the MODE
MODE=install

# include common subroutines and initialization code
. install.sub

# If /etc/fstab already exists, skip disk initialization.
if [ ! -f /etc/fstab ]; then
	# Install the shadowed disktab file; lets us write to it for temporary
	# purposes without mounting the miniroot read-write.
	[ -f /etc/disktab.shadow ] && cp /etc/disktab.shadow /tmp/disktab.shadow

	DISK=
	_DKDEVS=$DKDEVS

	while : ; do
		_DKDEVS=$(rmel "$DISK" $_DKDEVS)

		# Always do ROOTDISK first, and repeat until
		# it is configured acceptably.
		if isin $ROOTDISK $_DKDEVS; then
			resp=$ROOTDISK
			rm -f /tmp/fstab
			# Make sure empty files exist so we don't have to
			# keep checking for their existence before grep'ing.
			cat /dev/null >$FILESYSTEMS
			cat /dev/null >$SWAPLIST
		else
			# Force the user to think and type in a disk name by
			# making 'done' the default choice.
			ask_which "disk" "do you wish to initialize" "$_DKDEVS" done "No more disks to initialize"
			[[ $resp == done ]] && break
		fi

		DISK=$resp

		# Deal with disklabels, including editing the root disklabel
		# and labeling additional disks. This is machine-dependent since
		# some platforms may not be able to provide this functionality.
		# /tmp/fstab.$DISK is created here with 'disklabel -f'.
		rm -f /tmp/*.$DISK
		md_prep_disklabel $DISK

		# Get the lists of BSD and swap partitions.
		unset _partitions _psizes _mount_points
		_i=0
		disklabel $DISK 2>&1 | sed -ne '/^ *[a-p]: /p' >/tmp/disklabel.$DISK
		while read _dev _size _offset _type _rest; do
			_pp=${DISK}${_dev%:}
			_ps=$_size

			if [[ $_pp == $ROOTDEV ]]; then
				echo "$ROOTDEV /" >$FILESYSTEMS
				continue
			elif [[ $_type == swap ]]; then
				echo "$_pp" >>$SWAPLIST
				continue
			elif [[ $_type != *BSD ]]; then
				continue
			fi

			_partitions[$_i]=$_pp
			_psizes[$_i]=$_ps

			# If the user assigned a mount point, use it if possible.
			if [[ -f /tmp/fstab.$DISK ]]; then
				while read _pp _mp _rest; do
					[[ $_pp == "/dev/${_partitions[$_i]}" ]] || continue
					# Ignore mount points that have already been specified.
					[[ -n $(grep " $_mp\$" $FILESYSTEMS) ]] && break
					isin $_mp ${_mount_points[*]} && break
					# Ignore '/' for any partition but ROOTDEV. Check just
					# in case ROOTDEV isn't first partition processed.
					[[ $_mp == '/' ]] && break
					# Otherwise, record user specified mount point.
					_mount_points[$_i]=$_mp
				done </tmp/fstab.$DISK
			fi
			: $(( _i += 1 ))
		done </tmp/disklabel.$DISK

		if [[ $DISK == $ROOTDISK ]]; then
			# Ensure that ROOTDEV was configured.
			if [[ -n $(grep "^$ROOTDEV /$" $FILESYSTEMS) ]]; then
				echo "The root filesystem will be mounted on $ROOTDEV."
			else
				echo "ERROR: Unable to mount the root filesystem on $ROOTDEV."
				DISK=
			fi
			# Ensure that $SWAPDEV was configured as swap space.
			if [[ -n $(grep "^$SWAPDEV" $SWAPLIST) ]]; then
				echo "$SWAPDEV will be used for swap space."
				# But we really don't want it in the installed
				# /etc/fstab.
				grep -v "^$SWAPDEV" $SWAPLIST >$SWAPLIST.tmp
				mv $SWAPLIST.tmp $SWAPLIST
			else
				echo "ERROR: Unable to use $SWAPDEV for swap space."
				DISK=
			fi
			[[ -n $DISK ]] || echo "You must reconfigure $ROOTDISK."
		fi

		# If there are no BSD partitions, or $DISK has been reset, go on to next disk.
		[[ ${#_partitions[*]} -gt 0 && -n $DISK ]] || continue

		# Now prompt the user for the mount points. Loop until "done" entered.
		_i=0
		while : ; do
			_pp=${_partitions[$_i]}
			_ps=$(( ${_psizes[$_i]} / 2 ))
			_mp=${_mount_points[$_i]}

			# Get the mount point from the user
			ask "Mount point for ${_pp} (size=${_ps}k)? (or 'none' or 'done')" "$_mp"
			case $resp in
			"")	;;
			none)	_mp=
				;;
			done)	break
				;;
			/*)	set -- $(grep " $resp\$" $FILESYSTEMS)
				_pp=$1
				if [[ -z $_pp ]]; then
					# Mount point wasn't specified on a
					# previous disk. Has it been specified
					# on this one?
					_j=0
					for _pp in ${_partitions[*]} ""; do
						if [[ $_i -ne $_j ]]; then
							[[ $resp == ${_mount_points[$_j]} ]] && break
						fi
						: $(( _j += 1 ))
					done
				fi
				if [[ -n $_pp ]]; then
					echo "Invalid response: $_pp is already being mounted at $resp."
					continue
				fi
				_mp=$resp
				;;
			*)	echo "Invalid response: mount point must be an absolute path!"
				continue
				;;
			esac

			_mount_points[$_i]=$_mp

			: $(( _i += 1))
			[ $_i -ge ${#_partitions[*]} ] && _i=0
		done

		# Append mount information to $FILESYSTEMS
		_i=0
		for _pp in ${_partitions[*]}; do
			_mp=${_mount_points[$_i]}
			[ "$_mp" ] && echo "$_pp $_mp" >>$FILESYSTEMS
			: $(( _i += 1 ))
		done
	done

	cat <<__EOT

You have configured the following partitions and mount points:

$(<$FILESYSTEMS)

The next step creates a filesystem on each partition, ERASING existing data.
__EOT

	ask_yn "Are you really sure that you're ready to proceed?"
	[[ $resp == n ]] && { echo "ok, try again later..." ; exit ; }

	# Read $FILESYSTEMS, creating a new filesystem on each listed
	# partition and saving the partition and mount point information
	# for subsequent sorting by mount point.
	_i=0
	unset _partitions _mount_points
	while read _pp _mp; do
		newfs -q /dev/r$_pp

		_partitions[$_i]=$_pp
		_mount_points[$_i]=$_mp
		: $(( _i += 1 ))
	done <$FILESYSTEMS

	# Write fstab entries to /tmp/fstab in mount point alphabetic
	# order to enforce a rational mount order.
	for _mp in $(bsort ${_mount_points[*]}); do
		_i=0
		for _pp in ${_partitions[*]}; do
			if [ "$_mp" = "${_mount_points[$_i]}" ]; then
				echo -n "/dev/$_pp $_mp ffs rw,softdep"
				# Only '/' is neither nodev nor nosuid. i.e.
				# it can obviously *always* contain devices or
				# setuid programs.
				#
				# Every other mounted filesystem is nodev. If
				# the user chooses to mount /dev as a separate
				# filesystem, then on the user's head be it.
				#
				# The only directories that install puts suid
				# binaries into (as of 3.2) are:
				#
				# /sbin
				# /usr/bin
				# /usr/sbin
				# /usr/libexec
				# /usr/libexec/auth
				# /usr/X11R6/bin
				#
				# and ports and users can do who knows what
				# to /usr/local and sub directories thereof.
				#
				# So try to ensure that only filesystems that
				# are mounted at or above these directories
				# can contain suid programs. In the case of
				# /usr/libexec, give blanket permission for
				# subdirectories.
				if [[ $_mp == / ]]; then
					# / can hold devices and suid programs.
					echo " 1 1"
				else
					# No devices anywhere but /.
					echo -n ",nodev"
					case $_mp in
					# A few directories are allowed suid.
					/sbin|/usr)			;;
					/usr/bin|/usr/sbin)		;;
					/usr/libexec|/usr/libexec/*)	;;
					/usr/local|/usr/local/*)	;;
					/usr/X11R6|/usr/X11R6/bin)	;;
					# But all others are not.
					*)	echo -n ",nosuid"	;;
					esac
					echo " 1 2"
				fi
			fi
			: $(( _i += 1 ))
		done
	done >>/tmp/fstab

	# Append all non-default swap devices to fstab.
	while read _dev; do
		echo "/dev/$_dev none swap sw 0 0" >>/tmp/fstab
	done <$SWAPLIST

	munge_fstab
fi

mount_fs "-o async"

# Seed from random if exists
if [ -e /mnt/var/db/host.random ]; then
	dd if=/dev/prandom bs=256 count=1 >/tmp/rand
	dd if=/dev/arandom bs=256 count=94 >>/tmp/rand
	SUMS="$(cksum /tmp/rand) $RANDOM $(ls -lR /) $PPID $SECONDS $$ $(dd if=/dev/srandom bs=8 count=1)"
	RANDOM=$(echo "$SUMS" | cksum -o 1 | while read a b; do echo $a; done)
	dd if=/dev/prandom bs=256 count=1 >>/tmp/rand
	dd if=/dev/urandom bs=256 count=96 >>/tmp/rand
	cat /mnt/var/db/host.random >/dev/arandom
	dd if=/dev/arandom bs=256 count=1 >>/tmp/rand
	dd if=/dev/urandom bs=1024 count=63 >>/tmp/rand
	SUMS="$(cksum /mnt/var/db/host.random) $RANDOM $(cksum -o 1 /tmp/rand)"
	cat /tmp/rand >/var/db/host.random
	dd if=/dev/prandom bs=256 count=1 >/tmp/rand
	dd if=/dev/urandom bs=256 count=1 >>/tmp/rand
	echo "$SUMS" >>/tmp/rand
	cat /tmp/rand >/dev/arandom
	rm /tmp/rand
fi

# Set hostname.
#
# Use existing hostname (short form) as the default value because we could
# be restarting an install.
#
# Don't ask for, but don't discard, domain information provided by the user.
#
# Only apply the new value if the new short form name differs from the existing
# one. This preserves any existing domain information in the hostname.
ask_until "\nSystem hostname? (short form, e.g. 'foo')" "$(hostname -s)"
[[ ${resp%%.*} != $(hostname -s) ]] && hostname $resp

# Remove existing network configuration files in /tmp to ensure they don't leak
# onto the installed system in the case of a restarted install. Any information
# contained within them should be accessible via ifconfig, hostname, route,
# etc.
( cd /tmp; rm -f host* my* resolv.* dhclient.* )

# Always create new hosts file.
cat >/tmp/hosts <<__EOT
::1 localhost
127.0.0.1 localhost
::1 $(hostname -s)
127.0.0.1 $(hostname -s)
__EOT

ask_yn "Configure the network?" yes
[[ $resp == y ]] && donetconfig

_oifs=$IFS
IFS=
resp=
while [[ -z $resp ]]; do
	askpass "Password for root account? (will not echo)"
	_password=$resp

	askpass "Password for root account? (again)"
	if [ "$_password" != "$resp" ]; then
		echo "Passwords do not match, try again."
		resp=
	fi
done
IFS=$_oifs

install_sets

# Remount all filesystems in /etc/fstab with the options from /etc/fstab, i.e.
# without any options such as async which may have been used in the first
# mount.
while read _dev _mp _fstype _opt _rest; do
	mount -u -o $_opt $_dev $_mp ||	exit
done </etc/fstab

# Handle questions...
questions

echo -n "Saving configuration files..."

# Save any leases obtained during install.
( cd /var/db
[ -f dhclient.leases ] && mv dhclient.leases /mnt/var/db/. )

# Move configuration files from /tmp to /mnt/etc.
( cd /tmp
hostname >myname

# Add FQDN to /tmp/hosts entries, changing lines of the form '1.2.3.4 hostname'
# to '1.2.3.4 hostname.$FQDN hostname'. Leave untouched any lines containing
# domain information or aliases. The user added those manually.
_dn=$(get_fqdn)
while read _addr _hn _aliases; do
	if [[ -n $_aliases || $_hn != ${_hn%%.*} || -z $_dn ]]; then
		echo "$_addr $_hn $_aliases"
	else
		echo "$_addr $_hn.$_dn $_hn"
	fi
done <hosts >hosts.new
mv hosts.new hosts

# Prepend interesting comments from installed hosts and dhclient.conf files
# to /tmp/hosts and /tmp/dhclient.conf.
save_comments hosts
save_comments dhclient.conf

# Possible files: fstab, kbdtype, myname, sysctl.conf
#                 dhclient.conf resolv.conf resolv.conf.tail
#		  hostname.* hosts
for _f in fstab kbdtype myname *.conf *.tail host*; do
	[[ -f $_f ]] && mv $_f /mnt/etc/.
done )

# Amend target fstab by kernfs (BSD) / sysfs (Linux) and procfs (both)
[[ $MODE == install ]] && cat >>/mnt/etc/fstab <<__EOF
kern /kern kernfs rw,noauto 0 0
proc /proc procfs rw,linux 0 0
__EOF

_encr=$(/mnt/usr/bin/encrypt -b 8 -- "$_password")
echo "1,s@@^root::@@root:${_encr}:@@
w
q" | ed /mnt/etc/master.passwd 2>/dev/null
/mnt/usr/sbin/pwd_mkdb -p -d /mnt/etc /etc/master.passwd

echo -n "done.\nGenerating initial host.random file..."
dd if=/dev/urandom of=/mnt/var/db/host.random bs=1024 count=64 >/dev/null 2>&1
chmod 600 /mnt/var/db/host.random
echo "done."

set_timezone

# Perform final steps common to both an install and an upgrade.
finish_up
@


1.21
log
@unbreak make release - the only thing that's broken is
IPv4 default routes which are not entered via hostname.if(5)
@
text
@d2 1
a2 1
# $MirBSD: src/distrib/miniroot/install.sh,v 1.20 2004/05/21 21:10:47 tg Exp $
d439 1
a439 1
kern /kern kernfs rw 0 0
@


1.20
log
@not-so-easy merge
note: the release process is currently marked as broken, because
the install.sub file needs some major fixes.
they are so major I'll eventually rewrite the stuff now. let's see.
@
text
@d2 1
a2 1
# $MirBSD: src/distrib/miniroot/install.sh,v 1.19 2004/03/05 19:48:44 tg Exp $
a435 5

# Default routes
[ -e /tmp/mygate ] && while read if ip; do
	echo "route add -inet -host default $ip" >>/mnt/etc/hostname.$if
done </tmp/mygate
@


1.19
log
@quell warning
@
text
@d2 3
a4 3
#	$MirBSD: install.sh,v 1.18 2004/02/01 21:39:50 tg Exp $
#	$OpenBSD: install.sh,v 1.140 2003/12/04 18:43:38 deraadt Exp $
#	$NetBSD: install.sh,v 1.5.2.8 1996/08/27 18:15:05 gwr Exp $
d6 1
a6 1
# Copyright (c) 1997-2002 Todd Miller, Theo de Raadt, Ken Westerback
d458 2
@


1.18
log
@can't use /mnt/dev/urandom before it exists
rather use /dev/urandom, and shorten
@
text
@d2 1
a2 1
#	$MirBSD: install.sh,v 1.17 2004/01/28 15:14:06 tg Exp $
d438 1
a438 1
while read if ip; do
@


1.17
log
@second round
 - more merges
 - (hopefully) fix routing issue
 - also ask for a per-interface default route,
   not for a global one
 - use ELF sections for cdefs.h
   (XXX miros is now a.out incompatible. maybe even since longer.)
 - seed random on upgrade scenario
 - regenerate files
@
text
@d2 1
a2 1
#	$MirBSD: install.sh,v 1.16 2003/12/23 13:41:59 tg Exp $
d455 2
a456 3
( cd /mnt/var/db
dd if=/mnt/dev/urandom of=host.random bs=1024 count=64 >/dev/null 2>&1
chmod 600 host.random >/dev/null 2>&1 )
@


1.16
log
@* merge in OpenBSD
* rename cd34.iso to cdrom8.iso

XXX gzip/compress on ramdisk in MirOS should still
XXX	be able to compress and not only decompress
XXX	files. must be revisited
@
text
@d2 1
a2 1
#	$MirBSD: install.sh,v 1.15 2003/11/28 22:37:49 tg Exp $
d326 20
d436 5
@


1.15
log
@remove /etc/mygate altogether; it's prone to errors.
users on
.Mx
are to use
.Xr hostname.if 5
instead, for example:

# cat >>/etc/hostname.vr0 <<EOF
!route -n add -inet default 192.168.0.1 -mtu 1454
EOF

for an ADSL home router.
--
Idea from Angelo Laub.
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.14 2003/11/20 12:37:52 tg Exp $
#	$OpenBSD: install.sh,v 1.138 2003/09/26 00:11:25 krw Exp $
d98 1
a98 1
			# keep checking for their existance before grep'ing.
d379 2
a380 2
# Create /tmp/sysctl.conf from installed sysctl.conf if appropriate.
set_machdep_apertureallowed
@


1.14
log
@oops, amend only if (I)nstall""ing
@
text
@d2 1
a2 1
#	$MirBSD: install.sh,v 1.13 2003/11/20 12:36:05 tg Exp $
d410 1
a410 1
# Possible files: fstab, kbdtype, myname, mygate, sysctl.conf
d413 1
a413 1
for _f in fstab kbdtype my* *.conf *.tail host*; do
@


1.13
log
@have procfs with -o linux being automatically
mounted on /proc and kernfs (BSD) resp. sysfs (Linux)
on /kern after an installation.

remove space after I/O redirectors while here
@
text
@d2 1
a2 1
#	$MirBSD: install.sh,v 1.12 2003/09/27 15:46:48 tg Exp $
d418 1
a418 1
cat >>/mnt/etc/fstab <<__EOF
@


1.12
log
@Merge update, bump patchlevel
End cvs playing games with me
@
text
@d2 1
a2 1
#	$MirBSD: install.sh,v 1.11 2003/09/26 20:53:58 tg Exp $
d150 1
a150 1
				done < /tmp/fstab.$DISK
d153 1
a153 1
		done < /tmp/disklabel.$DISK
d168 1
a168 1
				grep -v "^$SWAPDEV" $SWAPLIST > $SWAPLIST.tmp
d235 1
a235 1
	cat << __EOT
d314 1
a314 1
	done >> /tmp/fstab
d319 1
a319 1
	done < $SWAPLIST
d345 1
a345 1
cat > /tmp/hosts << __EOT
d377 1
a377 1
done < /etc/fstab
d390 1
a390 1
hostname > myname
d402 1
a402 1
done < hosts > hosts.new
d417 6
d426 1
a426 1
q" | ed /mnt/etc/master.passwd 2> /dev/null
@


1.11
log
@nuke superfluous '?'
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.10 2003/09/25 20:59:39 tg Exp $
#	$OpenBSD: install.sh,v 1.137 2003/09/22 01:31:39 krw Exp $
@


1.10
log
@Merge OpenBSD-current
@
text
@d2 1
a2 1
#	$MirBSD: install.sh,v 1.9 2003/08/31 20:54:08 tg Exp $
d104 1
a104 1
			ask_which "disk" "do you wish to initialize?" "$_DKDEVS" done "No more disks to initialize"
@


1.9
log
@Merge import of OpenBSD source, ports and XF4 tree.

While here,
o clean up differences where possible
o whitespace cleanup
o ifdef ./. if defined()
o '...' ./. "..."
o echo foo > bar ./. echo foo >bar
o `...` ./. $(...) ./. $$(...)
o `...' ./. '...'
o modernize "our" tree, e.g. WWW in ports
o fix some typos and brainos introduced when renaming OpenBSD to MirBSD
o use hardware 80387 by default
o migrate Apache 1.3.28 OpenBSD ./. MirBSD ./. KAME
o work around as many CVS bugs as possible (add back/delete files, ...)

Synchronize stuff, ready for ongoing changes.
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.8 2003/08/16 15:19:51 tg Exp $
#	$OpenBSD: install.sh,v 1.136 2003/08/17 18:18:50 krw Exp $
d244 2
a245 7
	ask "Are you really sure that you're ready to proceed?" n
	case $resp in
	y*|Y*)	;;
	*)	echo "ok, try again later..."
		exit
		;;
	esac
d352 2
a353 5
ask "Configure the network?" y
case $resp in
y*|Y*)	donetconfig ;;
*)	;;
esac
d358 1
a358 1
while [ -z "$resp" ]; do
@


1.8
log
@Merge OpenBSD
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.7 2003/07/06 20:20:58 tg Exp $
#	$OpenBSD: install.sh,v 1.135 2003/08/07 19:12:59 deraadt Exp $
d104 1
a104 1
			ask_which "disk" "do you wish to initialize?" "$_DKDEVS" done
@


1.7
log
@mop up
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.6 2003/07/03 08:26:53 tg Exp $
#	$OpenBSD: install.sh,v 1.134 2003/07/03 15:19:01 krw Exp $
d169 1
a169 1
				mv $SWAPLIST.tmp $SWAPLIST	
@


1.6
log
@Merge OpenBSD, gives us better mmap2, etc.pp
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.5 2003/06/30 18:22:10 tg Exp $
#	$OpenBSD: install.sh,v 1.133 2003/07/02 16:42:19 krw Exp $
d178 1
a178 1
		[[ ${#_partitions[*]} > 0 && -n $DISK ]] || continue
@


1.5
log
@merge fixes by krw
remove 0x60 uncharacter
some more MirBSD
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.4 2003/06/29 19:45:43 tg Exp $
#	$OpenBSD: install.sh,v 1.132 2003/06/30 17:49:14 krw Exp $
d195 6
a200 4
			/*)	_pp=$(grep " $resp\$" $FILESYSTEMS | cutword 1)
				if [ -z "$_pp" ]; then
					# Mount point wasn't specified on a previous disk. Has it
					# been specified on this one?
d203 2
a204 2
						if [ $_i -ne $_j ]; then
							[ "$resp" = "${_mount_points[$_j]}" ] && break
d209 1
a209 1
				if [ "$_pp" ]; then
@


1.4
log
@merge the import
amd (automount dæmon) bites the dust
rewrite fake-NLS emulation, copyright to me
foobar! fnord!
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.3 2003/06/06 18:26:41 tg Exp $
#	$OpenBSD: install.sh,v 1.131 2003/06/27 22:40:40 krw Exp $
d18 1
a18 1
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
d52 1
a52 1
# ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
d90 1
a90 1
		_DKDEVS=`rmel "$DISK" $_DKDEVS`
d102 4
a105 2
			ask_which "disk" "do you wish to initialize?" "$_DKDEVS"
			[ "$resp" = "done" ] && break
d195 1
a195 1
			/*)	_pp=`grep " $resp\$" $FILESYSTEMS | cutword 1`
d265 1
a265 1
	for _mp in `bsort ${_mount_points[*]}`; do
d423 1
a423 1
_encr=`/mnt/usr/bin/encrypt -b 8 -- "$_password"`
@


1.3
log
@Merge OpenBSD-current
@
text
@d2 2
a3 2
#	$MirBSD: install.sh,v 1.2 2003/03/23 21:47:55 tg Exp $
#	$OpenBSD: install.sh,v 1.130 2003/06/02 15:46:09 deraadt Exp $
d68 1
a68 2
# A list of devices holding filesystems and the associated mount points
# is kept in the file named FILESYSTEMS.
d71 3
d97 4
a100 1
			rm -f $FILESYSTEMS
d112 1
a112 1
		rm -f /tmp/fstab.$DISK
d115 1
a115 5
		# Get the list of BSD partitions and store sizes
		# XXX - It would be nice to just pipe the output of sed to a
		#       'while read _pp _ps' loop, but our 'sh' runs the last
		#       element of a pipeline in a subshell and the required side
		#       effects to _partitions, etc. would be lost.
d118 4
a121 5
		for _p in $(disklabel ${DISK} 2>&1 | sed -ne '/^ *\([a-p]\): *\([0-9][0-9]*\).*BSD.*/s//\1\2/p'); do
			# All characters after the initial [a-p] are the partition size
			_ps=${_p#?}
			# Removing the partition size leaves us with the partition name
			_pp=${DISK}${_p%${_ps}}
d124 6
a129 1
				echo "$ROOTDEV /" > $FILESYSTEMS
d141 1
a141 1
					[[ -f $FILESYSTEMS && -n $(grep " $_mp\$" $FILESYSTEMS) ]] && break
d151 1
a151 1
		done
d155 1
a155 1
			if [[ -f $FILESYSTEMS && -n $(grep "^$ROOTDEV /$" $FILESYSTEMS) ]]; then
d161 7
a167 3
			# Ensure that ${ROOTDISK}b was configured as swap space.
			if [[ -n $(disklabel $ROOTDISK 2>&1 | sed -ne '/^ *\(b\):.*swap/s//\1/p') ]]; then
				echo "${ROOTDISK}b will be used for swap space."
d169 1
a169 1
				echo "ERROR: Unable to use ${ROOTDISK}b for swap space."
d226 1
a226 1
			[ "$_mp" ] && echo "$_pp $_mp" >> $FILESYSTEMS
d259 1
a259 1
	done < $FILESYSTEMS
d316 5
@


1.2
log
@Merge MirBSD-old entirely
Remove krb, yp, afs, GPL'd stuff in kernel
Adjust some other stuff

Not to be compiled yet...
@
text
@d2 2
a3 2
#	$MirBSD: obsd.tygs,v 1.44 2003/03/22 22:33:30 tg Exp $
#	$OpenBSD: install.sh,v 1.129 2002/12/14 15:33:34 krw Exp $
a16 6
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#	This product includes software developed by Todd Miller and
#	Theo de Raadt
# 4. The name of the author may not be used to endorse or promote products
#    derived from this software without specific prior written permission.
@


1.1
log
@Initial revision
@
text
@d2 1
d264 1
a264 1
				echo -n "/dev/$_pp $_mp ffs rw"
@


1.1.1.1
log
@Import OpenBSD 3.3 source repository from CTM 3132 the first time
This opens an OpenBSD-mirabile (aka MirBSD) repository.

### MirBSD is:
# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
# Copyright © 1968-2003  The authors of And contributors to UNIX®, the
#       C Language, BSD/Berkeley Unix; 386BSD, NetBSD 1.1 and OpenBSD.
#
# Anyone who obtained a copy of this work is hereby permitted to freely use,
# distribute, modify, merge, sublicence, give away or sell it as long as the
# authors are given due credit and the following notice is retained:
#
# This work is provided "as is", with no explicit or implicit warranty what-
# soever. Use it only at your own risk. In no event may an author or contri-
# butor be held liable for any damage, directly or indirectly, that origina-
# ted through or is caused by creation or modification of this work.

MirBSD is my private tree. MirBSD does not differ very much from OpenBSD
and intentionally tracks OpenBSD. That's why it _is_ OpenBSD, just not the
official one. It's like with DarrenBSD.

At time of this writing, no advertising for MirBSD must be done,
because the advertising clause has not yet been sorted out.

http://templeofhate.com/tglaser/MirBSD/index.php
@
text
@@


1.1.1.2
log
@Import latest OpenBSD CVS tree by CTM in order
to sync the base system and ports tree with Them.

This includes the recent licence changes as well - by
importing the changed base and re-applying the diffs
(with cvs up -j -j) they are inherited, and we're not
bound to the removed clauses any longer.
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.130 2003/06/02 15:46:09 deraadt Exp $
d16 6
@


1.1.1.3
log
@Sync OpenBSD source tree from -current CVS.
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.131 2003/06/27 22:40:40 krw Exp $
d67 2
a68 1
# The name of the file holding the list of configured filesystems.
a70 3
# The name of the file holding the list of non-default configured swap devices.
SWAPLIST=/tmp/swaplist

d94 1
a94 4
			# Make sure empty files exist so we don't have to
			# keep checking for their existance before grep'ing.
			cat /dev/null >$FILESYSTEMS
			cat /dev/null >$SWAPLIST
d106 1
a106 1
		rm -f /tmp/*.$DISK
d109 5
a113 1
		# Get the lists of BSD and swap partitions.
d116 5
a120 4
		disklabel $DISK 2>&1 | sed -ne '/^ *[a-p]: /p' >/tmp/disklabel.$DISK
		while read _dev _size _offset _type _rest; do
			_pp=${DISK}${_dev%:}
			_ps=$_size
d123 1
a123 6
				echo "$ROOTDEV /" >$FILESYSTEMS
				continue
			elif [[ $_type == swap ]]; then
				echo "$_pp" >>$SWAPLIST
				continue
			elif [[ $_type != *BSD ]]; then
d135 1
a135 1
					[[ -n $(grep " $_mp\$" $FILESYSTEMS) ]] && break
d145 1
a145 1
		done < /tmp/disklabel.$DISK
d149 1
a149 1
			if [[ -n $(grep "^$ROOTDEV /$" $FILESYSTEMS) ]]; then
d155 3
a157 7
			# Ensure that $SWAPDEV was configured as swap space.
			if [[ -n $(grep "^$SWAPDEV" $SWAPLIST) ]]; then
				echo "$SWAPDEV will be used for swap space."
				# But we really don't want it in the installed
				# /etc/fstab.
				grep -v "^$SWAPDEV" $SWAPLIST > $SWAPLIST.tmp
				mv $SWAPLIST.tmp $SWAPLIST	
d159 1
a159 1
				echo "ERROR: Unable to use $SWAPDEV for swap space."
d216 1
a216 1
			[ "$_mp" ] && echo "$_pp $_mp" >>$FILESYSTEMS
d249 1
a249 1
	done <$FILESYSTEMS
a305 5

	# Append all non-default swap devices to fstab.
	while read _dev; do
		echo "/dev/$_dev none swap sw 0 0" >>/tmp/fstab
	done < $SWAPLIST
@


1.1.1.4
log
@some more fixes for the OpenBSD installation scripts, from krw@@
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.132 2003/06/30 17:49:14 krw Exp $
d101 2
a102 4
			# Force the user to think and type in a disk name by
			# making 'done' the default choice.
			ask_which "disk" "do you wish to initialize?" "$_DKDEVS" done
			[[ $resp == done ]] && break
@


1.1.1.5
log
@A few more selected fixes from -current
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.133 2003/07/02 16:42:19 krw Exp $
d194 4
a197 6
			/*)	set -- $(grep " $resp\$" $FILESYSTEMS)
				_pp=$1
				if [[ -z $_pp ]]; then
					# Mount point wasn't specified on a
					# previous disk. Has it been specified
					# on this one?
d200 2
a201 2
						if [[ $_i -ne $_j ]]; then
							[[ $resp == ${_mount_points[$_j]} ]] && break
d206 1
a206 1
				if [[ -n $_pp ]]; then
@


1.1.1.6
log
@Import OpenBSD base system minus kerberos from CTM,
kernel source from CVS right now (no diffs though)
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.134 2003/07/03 15:19:01 krw Exp $
d177 1
a177 1
		[[ ${#_partitions[*]} -gt 0 && -n $DISK ]] || continue
@


1.1.1.7
log
@Import the complete OpenBSD source tree (base system)
as of CTM delta 3496 (roughly 1200 UTC today) into the
vendor branch.
Attention: this is a big update. Don't even try to
build this system, OpenBSD 3.4-beta, yet on your own.
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.135 2003/08/07 19:12:59 deraadt Exp $
d168 1
a168 1
				mv $SWAPLIST.tmp $SWAPLIST
@


1.1.1.8
log
@Synchronize with OpenBSD 3.4-beta
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.136 2003/08/17 18:18:50 krw Exp $
d103 1
a103 1
			ask_which "disk" "do you wish to initialize?" "$_DKDEVS" done "No more disks to initialize"
@


1.1.1.9
log
@Release Time. Synchronize with OpenBSD 3.4-current (base system).
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.137 2003/09/22 01:31:39 krw Exp $
d243 7
a249 2
	ask_yn "Are you really sure that you're ready to proceed?"
	[[ $resp == n ]] && { echo "ok, try again later..." ; exit ; }
d356 5
a360 2
ask_yn "Configure the network?" yes
[[ $resp == y ]] && donetconfig
d365 1
a365 1
while [[ -z $resp ]]; do
@


1.1.1.10
log
@cvs is playing games with me.

@@@@@@ CONSIDER THE TREE LOCKED NOW @@@@@@
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.138 2003/09/26 00:11:25 krw Exp $
d103 1
a103 1
			ask_which "disk" "do you wish to initialize" "$_DKDEVS" done "No more disks to initialize"
@


1.1.1.11
log
@Time to import OpenBSD once again. Expect breakage.
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.140 2003/12/04 18:43:38 deraadt Exp $
d97 1
a97 1
			# keep checking for their existence before grep'ing.
d378 2
a379 2
# Handle questions...
questions
@


1.1.1.12
log
@large-scale import of OpenBSD 3.5-current source base including many fixes
note: from now, we will not be binary compatible with OpenBSD apps any
longer (due to syscall numbering differences); both an OpenBSD compat and
a conversion tool for old MirOS #7 apps will be delivered later.

The src/ tree is locked from now.
@
text
@d2 1
a2 1
#	$OpenBSD: install.sh,v 1.142 2004/03/23 02:39:38 krw Exp $
d5 1
a5 1
# Copyright (c) 1997-2004 Todd Miller, Theo de Raadt, Ken Westerback
a426 2

set_timezone
@


